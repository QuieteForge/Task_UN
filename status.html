<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Status</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Noto Sans JP", sans-serif;
        margin: 12px;
      }
      .card {
        padding: 12px;
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
        margin-bottom: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .muted {
        color: #777;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="row">
        <h2 style="margin: 0">成長レーダー</h2>
        <span class="muted" id="date"></span>
      </div>
      <canvas id="radar" height="260"></canvas>
    </div>
    <div class="card">
      <div class="row"><h3 style="margin: 0">意味量トレンド（7日）</h3></div>
      <canvas id="spark" height="120"></canvas>
    </div>

    <script>
      (async () => {
        // 1) LIFF init → userId取得
        await liff.init({ liffId: "YOUR_LIFF_ID" });
        if (!liff.isLoggedIn()) liff.login();
        const profile = await liff.getProfile();
        const userId = profile.userId; // Supabase users.id と一致

        // 2) API 呼び出し
        const base = "https://<your-n8n-domain>/webhook";
        const latest = await fetch(
          `${base}/api/stats.latest?user_id=${encodeURIComponent(userId)}`
        ).then((r) => r.json());
        const trend = await fetch(
          `${base}/api/stats.trend?user_id=${encodeURIComponent(userId)}`
        ).then((r) => r.json());

        const cur = Array.isArray(latest) ? latest[0] : latest;
        if (!cur) {
          document.getElementById("date").textContent = "データなし";
          return;
        }
        document.getElementById("date").textContent = cur.date_utc;

        // 3) レーダー描画
        const radarCtx = document.getElementById("radar").getContext("2d");
        new Chart(radarCtx, {
          type: "radar",
          data: {
            labels: [
              "完了率(%)",
              "継続率(タスク%)",
              "継続率(日記%)",
              "意味量(0-10)",
              "平均完了/日",
            ],
            datasets: [
              {
                label: "現在値",
                data: [
                  Number(cur.task_completion_rate || 0),
                  Number(cur.task_continuation_rate || 0),
                  Number(cur.journal_continuation_rate || 0),
                  Number(cur.meaning_score || 0) * 10, // 0-10 → 0-100にスケール
                  Number(cur.avg_tasks_per_day || 0) * 10, // 表示強調のためx10
                ],
                fill: true,
                pointRadius: 3,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                ticks: { stepSize: 20 },
              },
            },
            plugins: { legend: { display: false } },
          },
        });

        // 4) スパークライン（意味量）
        const labels = trend.map((r) => r.date_utc);
        const values = trend.map((r) => Number(r.meaning_score || 0));
        const sparkCtx = document.getElementById("spark").getContext("2d");
        new Chart(sparkCtx, {
          type: "line",
          data: {
            labels,
            datasets: [{ data: values, tension: 0.3, pointRadius: 0 }],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } },
          },
        });
      })();
    </script>
  </body>
</html>
