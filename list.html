<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LISTï½œã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
      --actL:#ecfdf5; --actR:#fef2f2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    header{position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--line); z-index:10}
    .bar{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 16px}
    .title{font-weight:650; letter-spacing:.2px}
    .pill{padding:6px 10px; border-radius:999px; background:var(--pill); font-size:12px}

    main{padding:14px; max-width:720px; margin:0 auto}
    .section{margin:18px 0}
    .section h3{margin:8px 6px 10px; font-size:13px; color:var(--sub); font-weight:600}

    .card-wrap{position:relative; margin:10px 0; border-radius:16px; overflow:visible}

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¢ï¼ˆåˆæœŸã¯ä¸å¯è¦–/éæ´»æ€§ã€‚ãƒ‰ãƒ©ãƒƒã‚°è·é›¢ã§ä¸é€æ˜åº¦UPâ†’ã‚¹ãƒŠãƒƒãƒ—ã§å®Œå…¨è¡¨ç¤ºï¼‰ */
    .actions{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between;
      padding:0 8px; opacity:0; pointer-events:none; transition:opacity .12s linear;
      z-index:0;
    }
    .left-actions{display:flex; gap:6px; padding-left:8px}
    .right-actions{display:flex; gap:6px; padding-right:8px}
    .btn{
      pointer-events:auto; padding:8px 10px; border-radius:10px; border:1px solid var(--line);
      background:#fff; font-size:12px; user-select:none; white-space:nowrap;
      min-width:68px;
    }
    .btn.ok{ border-color:#c7ecd1; color:var(--ok); background:var(--actL) }
    .btn.warn{ border-color:#fde68a; color:var(--warn); background:#fffbeb }
    .btn.danger{ border-color:#fecaca; color:var(--danger); background:var(--actR) }

    /* å®Ÿã‚«ãƒ¼ãƒ‰ï¼ˆtrackï¼‰ */
    .track{
      position:relative; z-index:1;
      background:var(--card); border:1px solid var(--line); border-radius:16px;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
      padding:12px 14px; transform:translateX(0); transition:transform .18s ease;
      touch-action:pan-y;
    }
    .ghost{opacity:.45}
    .row{display:flex; align-items:center; gap:8px}
    .titleTxt{flex:1; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta{display:flex; gap:8px; color:var(--sub); font-size:12px}
    .pillDue{padding:2px 8px; border-radius:999px; border:1px solid var(--line)}
    .pin{font-size:12px; color:var(--accent)}

    .empty{color:var(--sub); text-align:center; padding:36px 12px}

    .toolbar{display:flex; gap:8px; padding:8px}
    .toolbar input{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .toolbar button{padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff}

    /* è©³ç´°ãƒ‘ãƒãƒ« */
    .detail{border-top:1px dashed var(--line); margin-top:10px; padding-top:10px; display:none; position:relative}
    .detail.open{display:block}
    .detail-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px}
    .detail label{font-size:12px; color:var(--sub)}
    .detail textarea,.detail input,.detail select{
      width:100%; padding:8px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:14px;
    }
    .detail .row-btns{display:flex; gap:8px; justify-content:flex-end; margin-top:8px}
    .detail .close-x{
      position:absolute; top:-6px; right:-6px; width:26px; height:26px; border-radius:50%;
      border:1px solid var(--line); background:#fff; display:flex; align-items:center; justify-content:center;
      font-weight:700; cursor:pointer;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
    }

    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff;
      padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; transition:.25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
      <div class="pill" id="user-pill">loadingâ€¦</div>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰" />
      <button id="reload">å†èª­è¾¼</button>
    </div>

    <div id="pinned" class="section" hidden>
      <h3>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</h3>
      <div id="pinned-list"></div>
    </div>

    <div id="active" class="section">
      <h3>ğŸ“ æœªå®Œäº†</h3>
      <div id="active-list"></div>
    </div>

    <div id="completed" class="section" hidden>
      <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
      <div id="completed-list"></div>
    </div>

    <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
  /** ===== è¨­å®š ===== */
  const LIFF_ID = "2008311584-NdJqOqMn";
  const LIST_API_URL   = "https://lumicreate.xvps.jp/webhook/webhook-list";
  const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";

  /** ===== çŠ¶æ…‹ ===== */
  let gUserId = null;
  let gAllTasks = [];
  let gOpenDetailId = null;
  let gOpenSideId = null;

  /** ===== util ===== */
  const el = s => document.querySelector(s);
  const $pinned = el("#pinned"), $pinnedList = el("#pinned-list");
  const $activeList = el("#active-list");
  const $completed = el("#completed"), $completedList = el("#completed-list");
  const $empty = el("#empty");

  function toast(msg){
    const t = el("#toast"); t.textContent = msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }
  function esc(s){return String(s||"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]))}
  function fmtJST(iso){
    if(!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});
  }
  const isFiniteNum = v => Number.isFinite(v);

  /** ä¸¦ã³é †ï¼šãƒ”ãƒ³ â†’ å„ªå…ˆåº¦(é™) â†’ æœŸé™(æ˜‡) â†’ ã‚¿ã‚¤ãƒˆãƒ« */
  function sortCombined(arr){
    return arr.slice().sort((a,b)=>{
      if(a.pinned !== b.pinned) return (b.pinned?1:0)-(a.pinned?1:0);
      const ap = isFiniteNum(a.priority) ? a.priority : -1;
      const bp = isFiniteNum(b.priority) ? b.priority : -1;
      if(ap !== bp) return bp - ap;
      const ad = a.due_at ? new Date(a.due_at).getTime() : Number.POSITIVE_INFINITY;
      const bd = b.due_at ? new Date(b.due_at).getTime() : Number.POSITIVE_INFINITY;
      if(ad !== bd) return ad - bd;
      const at = (a.title||"").toLowerCase(), bt=(b.title||"").toLowerCase();
      if(at < bt) return -1; if(at > bt) return 1; return 0;
    });
  }
  function splitByStatus(all){
    const now = Date.now(), weekAgo = now - 7*24*3600*1000;
    const pinned=[], active=[], completed=[];
    for(const t of all){
      if(t.status==="deleted" || t.status==="archived") continue;
      if(t.status==="completed"){
        const cAt = t.completed_at ? new Date(t.completed_at).getTime() : 0;
        if(cAt >= weekAgo) completed.push(t);
        continue;
      }
      if(t.pinned){ pinned.push(t); continue; }
      active.push(t);
    }
    return { pinned, active, completed };
  }

  /** ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ===== */
  function cardHTML(t){
    const dueTxt = fmtJST(t.due_at);
    const pin = t.pinned ? '<span class="pin">ğŸ“Œ</span>' : "";
    const ghost = t.status==="completed" ? " ghost" : "";

    return `
    <div class="card-wrap" data-id="${t.id}">
      <div class="actions">
        <div class="left-actions">
          <button class="btn ok" data-act="complete">å®Œäº†</button>
          <button class="btn" data-act="pin">${t.pinned?"ãƒ”ãƒ³è§£é™¤":"ãƒ”ãƒ³"}</button>
        </div>
        <div class="right-actions">
          <button class="btn warn" data-act="detail">è©³ç´°</button>
          <button class="btn danger" data-act="delete">å‰Šé™¤</button>
        </div>
      </div>
      <div class="track${ghost}">
        <div class="row">
          <div class="titleTxt">${pin}${esc(t.title||"(ç„¡é¡Œ)")}</div>
          <div class="meta">
            <span class="pillDue">â° ${esc(dueTxt)}</span>
            ${isFiniteNum(t.priority)?`<span class="pillDue">â˜…${t.priority}</span>`:""}
          </div>
        </div>
        <div class="detail" id="detail-${t.id}">
          <div class="close-x" data-close="1">Ã—</div>
          <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¡ãƒ¢ï¼‰</label>
          <textarea data-field="detail" rows="3" placeholder="ãƒ¡ãƒ¢">${esc(t.detail||"")}</textarea>
          <div class="detail-grid">
            <div>
              <label>å„ªå…ˆåº¦ï¼ˆ1ã€œ3ï¼‰</label>
              <select data-field="priority">
                <option value="">ï¼ˆç©ºï¼‰</option>
                <option value="1" ${t.priority==1?"selected":""}>1</option>
                <option value="2" ${t.priority==2?"selected":""}>2</option>
                <option value="3" ${t.priority==3?"selected":""}>3</option>
              </select>
            </div>
            <div>
              <label>æœŸé™</label>
              <input data-field="due_at" type="datetime-local" value="${toLocalDatetimeValue(t.due_at)}" />
            </div>
          </div>
          <div style="margin-top:6px">
            <label>ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆ1ä»¶ï¼‰</label>
            <input data-field="remind0" type="datetime-local" value="${toLocalDatetimeValue((t.remind_times||[])[0])}" />
          </div>
          <div class="row-btns">
            <button class="btn" data-act="detail-cancel">é–‰ã˜ã‚‹</button>
            <button class="btn ok" data-act="detail-save">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>`;
  }
  function toLocalDatetimeValue(iso){
    if(!iso) return "";
    const d = new Date(iso);
    const pad = n=>String(n).padStart(2,"0");
    const yyyy = d.getFullYear(), mm=pad(d.getMonth()+1), dd=pad(d.getDate()),
          hh = pad(d.getHours()), mi=pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  function fromLocalDatetimeValue(val){
    if(!val) return null;
    const d = new Date(val);
    return d.toISOString();
  }

  function render(){
    const { pinned, active, completed } = splitByStatus(gAllTasks);
    const pins = sortCombined(pinned).slice(0,3);
    const acts = sortCombined(active);
    const comps = sortCombined(completed);

    $pinned.hidden = pins.length===0;
    $completed.hidden = comps.length===0;
    $empty.hidden = pins.length + acts.length > 0;

    $pinnedList.innerHTML = pins.map(cardHTML).join("");
    $activeList.innerHTML = acts.map(cardHTML).join("");
    $completedList.innerHTML = comps.map(cardHTML).join("");

    [...document.querySelectorAll(".card-wrap")].forEach(bindSwipeAndButtons);
    [...document.querySelectorAll(".track")].forEach(bindDetailButtons);

    document.querySelector(".title").textContent = `LISTï½œã‚¿ã‚¹ã‚¯ï¼ˆ${pins.length+acts.length}ï¼‰`;
  }

  /** ===== ã‚¹ãƒ¯ã‚¤ãƒ—å®Ÿè£…ï¼ˆãƒœã‚¿ãƒ³å¹…â€œå®Ÿæ¸¬â€ã§ã‚¹ãƒŠãƒƒãƒ—è·é›¢æ±ºå®šï¼‰ ===== */
  const TAP_MAX_MOVE = 6;     // ã‚¿ãƒƒãƒ—åˆ¤å®šã®è¨±å®¹ç§»å‹•
  const AXIS_LOCK_SLOP = 6;   // è»¸åˆ¤å®šã®éŠã³
  const EXTRA_PAD = 14;       // ãƒœã‚¿ãƒ³ç¾¤ã®å·¦å³ä½™ç™½
  const FULL_MARGIN = 36;     // ã‚¹ãƒŠãƒƒãƒ—ã‚ˆã‚Šã•ã‚‰ã«é€²ã‚“ã ã‚‰ãƒ•ãƒªãƒƒã‚¯ãªã—ã§ã‚‚å³å®Ÿè¡Œ
  const V_FULL = 0.58;        // px/ms ä»¥ä¸Šã§å³å®Ÿè¡Œï¼ˆå‰å›ã‚ˆã‚Šæ°—æŒã¡å¼·ã‚ï¼‰

  function bindSwipeAndButtons(wrap){
    const track = wrap.querySelector(".track");
    const actions = wrap.querySelector(".actions");
    const leftBtns = wrap.querySelector(".left-actions");
    const rightBtns= wrap.querySelector(".right-actions");

    // â˜… ã“ã“ã§å¹…ã‚’å®Ÿæ¸¬ â†’ ã‚«ãƒ¼ãƒ‰æ¯ã«æœ€é©ã‚¹ãƒŠãƒƒãƒ—è·é›¢
    const { snapL, snapR, fullL, fullR } = measureSnaps(leftBtns, rightBtns);

    let sx=0, sy=0, dx=0, dy=0, ts=0;
    let dragging=false, moved=false, locked=null; // 'x' or 'y'
    let justDragged=false;

    const closeOtherOpenSides = (currentId)=>{
      if(!gOpenSideId) return;
      if(gOpenSideId !== currentId){
        const ww = document.querySelector(`.card-wrap[data-id="${gOpenSideId}"]`);
        if(ww) settleTo(ww, 0);
      }
    };

    const onStart = (x,y)=>{
      dragging=true; moved=false; locked=null;
      sx=x; sy=y; dx=0; dy=0; ts=performance.now();
      track.style.transition="none";
      // åˆå‹•ã§è–„ã£ã™ã‚‰è¦‹ãˆã‚‹ã‚ˆã†ã«0â†’å°‘ã—
      actions.style.opacity = 0;
    };

    const onMove = (x,y,evt)=>{
      if(!dragging) return;
      dx = x - sx; dy = y - sy;
      if(!moved && (Math.abs(dx)>1 || Math.abs(dy)>1)) moved=true;

      if(!locked){
        if(Math.abs(dx) > Math.abs(dy)+AXIS_LOCK_SLOP) locked='x';
        else if(Math.abs(dy) > Math.abs(dx)+AXIS_LOCK_SLOP) locked='y';
      }
      if(locked==='y'){ return; }
      if(locked==='x' && evt && typeof evt.preventDefault==='function') evt.preventDefault();

      // è¡¨ç¤ºä½ç½® & ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¦‹ãˆæ–¹
      const shown = clamp(dx, -fullR-20, fullL-20);
      track.style.transform = `translateX(${shown}px)`;

      // è·é›¢ã«å¿œã˜ã¦ä¸é€æ˜åº¦ã‚’ä¸Šã’ã‚‹ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ãƒœã‚¿ãƒ³ãŒè¦‹ãˆã‚‹ï¼‰
      const opa = Math.min(1, Math.max(Math.abs(shown)/Math.min(snapL, snapR), 0));
      actions.style.opacity = opa;

      // ã‚¯ãƒ©ã‚¹ã§ã©ã¡ã‚‰å´ãŒé–‹ãã‹ã®çŠ¶æ…‹ã‚‚ä¹—ã›ã¦ãŠãï¼ˆè¦‹ãŸç›®ç”¨ï¼‰
      if(shown>0){ wrap.classList.add("open-left"); wrap.classList.remove("open-right"); }
      else if(shown<0){ wrap.classList.add("open-right"); wrap.classList.remove("open-left"); }
      else { wrap.classList.remove("open-left","open-right"); }
    };

    const onEnd = ()=>{
      if(!dragging) return;
      dragging=false;
      track.style.transition="transform .18s ease";

      const wasDrag = moved && Math.abs(dx) > TAP_MAX_MOVE;
      if(wasDrag){ justDragged = true; setTimeout(()=>{ justDragged=false; }, 260); }

      // ã‚¯ãƒªãƒƒã‚¯æ‰±ã„
      if(!wasDrag){
        // ã‚¹ãƒŠãƒƒãƒ—ã‚’é–‹ã„ã¦ã„ã‚‹æ™‚ã¯ã¾ãšé–‰ã˜ã‚‹
        if(wrap.classList.contains("open-left") || wrap.classList.contains("open-right")){
          settleTo(wrap,0, actions);
          return;
        }
        openDetail(wrap.dataset.id, true);
        return;
      }

      const dt = Math.max(1, performance.now()-ts);
      const v = dx/dt;

      // å³æ™‚å®Ÿè¡Œï¼ˆé€Ÿåº¦ or è·é›¢ï¼‰
      if(dx >= fullL || v>=V_FULL){
        settleTo(wrap, 0, actions);
        onAction(wrap,"complete");
        return;
      }
      if(dx <= -fullR || v<=-V_FULL){
        settleTo(wrap, 0, actions);
        confirmDelete(wrap);
        return;
      }

      // ã‚¹ãƒŠãƒƒãƒ—å›ºå®šï¼ˆãƒœã‚¿ãƒ³å®Œå…¨éœ²å‡º ï¼‹ ã‚¯ãƒªãƒƒã‚¯å¯ï¼‰
      if(dx > snapL){
        settleTo(wrap, snapL, actions, 1);
        closeOtherOpenSides(wrap.dataset.id);
        gOpenSideId = wrap.dataset.id;
        closeOtherDetails(wrap.dataset.id);
        return;
      }
      if(dx < -snapR){
        settleTo(wrap, -snapR, actions, 1);
        closeOtherOpenSides(wrap.dataset.id);
        gOpenSideId = wrap.dataset.id;
        closeOtherDetails(wrap.dataset.id);
        return;
      }

      // å°ã•ã„å‹•ãâ†’æˆ»ã™
      settleTo(wrap, 0, actions);
    };

    // ãƒœã‚¿ãƒ³æŠ¼ä¸‹
    leftBtns.addEventListener("click", (e)=>{
      const b = e.target.closest(".btn"); if(!b) return;
      const act = b.dataset.act;
      if(act==="complete"){ onAction(wrap,"complete"); }
      else if(act==="pin"){ onAction(wrap,"pin"); }
      settleTo(wrap,0, actions);
    });
    rightBtns.addEventListener("click", (e)=>{
      const b = e.target.closest(".btn"); if(!b) return;
      const act = b.dataset.act;
      if(act==="detail"){ openDetail(wrap.dataset.id,true); }
      else if(act==="delete"){ confirmDelete(wrap); }
      settleTo(wrap,0, actions);
    });

    // === touch/mouse ===
    track.addEventListener("touchstart",e=>onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:false});
    track.addEventListener("touchmove", e=>onMove(e.touches[0].clientX, e.touches[0].clientY, e), {passive:false});
    track.addEventListener("touchend", onEnd, {passive:false});

    track.addEventListener("mousedown", e=>onStart(e.clientX, e.clientY));
    track.addEventListener("mousemove", e=>{ if(e.buttons===1) onMove(e.clientX, e.clientY, e) });
    track.addEventListener("mouseup", onEnd);

    // ãƒ‰ãƒ©ãƒƒã‚°ç›´å¾Œã®åˆæˆã‚¯ãƒªãƒƒã‚¯ã‚’æŠ‘æ­¢
    track.addEventListener("click",(e)=>{
      if(justDragged){ e.stopPropagation(); e.preventDefault(); return; }
      if(wrap.classList.contains("open-left") || wrap.classList.contains("open-right")){
        settleTo(wrap,0, actions); return;
      }
      openDetail(wrap.dataset.id, true);
    });
  }

  function bindDetailButtons(track){
    const wrap = track.closest(".card-wrap");
    const det = wrap.querySelector(".detail");
    det.querySelector("[data-close]")?.addEventListener("click",()=>openDetail(wrap.dataset.id,false));
    det.querySelector('[data-act="detail-cancel"]')?.addEventListener("click",()=>openDetail(wrap.dataset.id,false));
    det.querySelector('[data-act="detail-save"]')?.addEventListener("click",()=>saveDetail(wrap.dataset.id));
  }

  function measureSnaps(leftBtns, rightBtns){
    // ç”»é¢ã«æç”»æ¸ˆã¿ãªã®ã§å®Ÿæ¸¬ã§ãã‚‹
    const l = leftBtns.getBoundingClientRect().width;
    const r = rightBtns.getBoundingClientRect().width;
    // ãƒœã‚¿ãƒ³ç¾¤+ä½™ç™½åˆ†ã ã‘ç¢ºå®Ÿã«éœ²å‡ºï¼ˆæœ€å°110, æœ€å¤§240ã®ç¯„å›²ã§ä¸¸ã‚ï¼‰
    const snapL = clamp(Math.round(l + EXTRA_PAD), 110, 240);
    const snapR = clamp(Math.round(r + EXTRA_PAD), 110, 240);
    // â€œã•ã‚‰ã«é€²ã‚“ã ã‚‰â€ å³å®Ÿè¡Œï¼ˆå‰ã‚ˆã‚Šå°‘ã—ä½™è£•ï¼‰
    const fullL = snapL + FULL_MARGIN;
    const fullR = snapR + FULL_MARGIN;
    return { snapL, snapR, fullL, fullR };
  }

  function settleTo(wrap, x, actions, forceOpacity){
    const track = wrap.querySelector(".track");
    track.style.transform = `translateX(${x}px)`;
    if(x===0){
      wrap.classList.remove("open-left","open-right");
      if(actions) actions.style.opacity = 0;
      if(gOpenSideId === wrap.dataset.id) gOpenSideId = null;
    }else{
      if(actions) actions.style.opacity = (typeof forceOpacity==='number' ? forceOpacity : 1);
      if(x>0) { wrap.classList.add("open-left"); wrap.classList.remove("open-right"); }
      else { wrap.classList.add("open-right"); wrap.classList.remove("open-left"); }
    }
  }
  function clamp(v,min,max){ return Math.min(max, Math.max(min,v)); }

  function confirmDelete(wrap){
    if(!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    onAction(wrap,"delete");
  }

  async function onAction(wrap, action){
    const id = wrap.dataset.id;
    try{
      if(action==="detail"){ openDetail(id,true); return; }
      if(action==="uncomplete"){
        await postAction("complete-undo",{task_id:id,user_id:gUserId});
        toast("å®Œäº†ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
      }else if(action==="complete"){
        await postAction("complete",{task_id:id,user_id:gUserId});
        toast("å®Œäº†ã—ã¾ã—ãŸ");
      }else if(action==="pin"){
        await postAction("toggle-pin",{task_id:id,user_id:gUserId});
        toast("ãƒ”ãƒ³ã®åˆ‡æ›¿");
      }else if(action==="delete"){
        await postAction("delete",{task_id:id,user_id:gUserId});
        toast("å‰Šé™¤ã—ã¾ã—ãŸ");
      }
      await loadTasks(gUserId);
    }catch(e){
      console.error(e);
      toast("ã‚¨ãƒ©ãƒ¼: "+(e.message||"failed"));
    }
  }

  function closeOtherDetails(keepId){
    if(gOpenDetailId && gOpenDetailId!==keepId){
      const prev = el(`#detail-${gOpenDetailId}`);
      if(prev) prev.classList.remove("open");
    }
  }
  function openDetail(id, open){
    const det = el(`#detail-${id}`); if(!det) return;
    closeOtherDetails(id);
    if(open){ det.classList.add("open"); gOpenDetailId = id; }
    else { det.classList.remove("open"); if(gOpenDetailId===id) gOpenDetailId=null; }
  }

  async function saveDetail(id){
    const det = el(`#detail-${id}`); if(!det) return;
    const fields = {};
    const vDetail = det.querySelector('[data-field="detail"]').value.trim();
    const vPrio = det.querySelector('[data-field="priority"]').value;
    const vDue  = det.querySelector('[data-field="due_at"]').value;
    const vRem0 = det.querySelector('[data-field="remind0"]').value;

    fields.detail = vDetail || null;
    fields.priority = vPrio ? Number(vPrio) : null;
    fields.due_at = vDue ? fromLocalDatetimeValue(vDue) : null;
    fields.remind_times = vRem0 ? [fromLocalDatetimeValue(vRem0)] : [];

    try{
      await postAction("update",{ task_id:id, user_id:gUserId, fields });
      toast("ä¿å­˜ã—ã¾ã—ãŸ");
      openDetail(id,false);
      await loadTasks(gUserId);
    }catch(e){
      console.error(e);
      toast("ä¿å­˜ã‚¨ãƒ©ãƒ¼");
    }
  }

  /** ===== API ===== */
  async function postAction(action, body){
    const res = await fetch(ACTION_API_URL, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action, ...body })
    });
    const j = await res.json().catch(()=>({ok:false}));
    if(!res.ok || j.ok===false) throw new Error(j.message||"action failed");
    return j;
  }

  async function loadTasks(userId){
    if(!userId){
      const prof = await liff.getProfile();
      userId = prof.userId; gUserId = userId;
    }
    const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
    const res = await fetch(url, { method:"GET", credentials:"omit", headers:{ "Content-Type":"application/json" } });
    const payload = await res.json();
    if(!res.ok || !payload || payload.ok!==true){ toast("èª­ã¿è¾¼ã¿å¤±æ•—"); return; }

    const pinned = Array.isArray(payload.pinned)?payload.pinned:[];
    const active = Array.isArray(payload.active)?payload.active:[];
    const completed = Array.isArray(payload.completed)?payload.completed:[];
    gAllTasks = [...pinned, ...active, ...completed];
    render();
  }

  /** ===== init ===== */
  (async function bootstrap(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) liff.login();
    const prof = await liff.getProfile();
    gUserId = prof.userId;
    el("#user-pill").textContent = "You: " + gUserId.slice(-6);

    el("#q").addEventListener("input",(e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q){ render(); return; }
      const filtered = gAllTasks.filter(t =>
        (t.title||"").toLowerCase().includes(q) ||
        (t.detail||"").toLowerCase().includes(q)
      );
      const { pinned, active, completed } = splitByStatus(filtered);
      $pinned.hidden = pinned.length===0;
      $completed.hidden = completed.length===0;
      $empty.hidden = pinned.length + active.length > 0;
      $pinnedList.innerHTML = sortCombined(pinned).map(cardHTML).join("");
      $activeList.innerHTML = sortCombined(active).map(cardHTML).join("");
      $completedList.innerHTML = sortCombined(completed).map(cardHTML).join("");
      [...document.querySelectorAll(".card-wrap")].forEach(bindSwipeAndButtons);
      [...document.querySelectorAll(".track")].forEach(bindDetailButtons);
    });
    el("#reload").onclick = () => loadTasks(gUserId);

    await loadTasks(gUserId);
  })();
  </script>
</body>
</html>
