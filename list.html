<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LISTï½œã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    header{ position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--line); }
    .bar{ display:flex; align-items:center; gap:8px; justify-content:space-between; padding:12px 16px; }
    .title{ font-weight:650; letter-spacing:.2px; }
    .pill{ padding:6px 10px; border-radius:999px; background:var(--pill); font-size:12px; }
    main{ padding:14px; max-width:720px; margin:0 auto; }

    .section{ margin:18px 0; }
    .section h3{ margin:8px 6px 10px; font-size:13px; color:var(--sub); font-weight:600; }

    .card{
      position:relative; background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:0; margin:12px 0; box-shadow:0 1px 0 rgba(0,0,0,.03);
    }

    /* ã‚¹ãƒ¯ã‚¤ãƒ—æ§‹é€  */
    .swipe-wrap{ position:relative; overflow:hidden; border-radius:16px; }
    .actions{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between;
      padding:0 8px; pointer-events:none; opacity:0;
    }
    .group{ display:flex; gap:8px; }
    .btn{
      pointer-events:auto; padding:10px 14px; border-radius:14px; border:1px solid var(--line);
      background:#fff; font-size:14px;
    }
    .btn.ok{ border-color:#c7ecd1; color:var(--ok); background:#ecfdf5; }
    .btn.warn{ border-color:#fde68a; color:var(--warn); background:#fffbeb; }
    .btn.danger{ border-color:#fecaca; color:var(--danger); background:#fef2f2; }

    .track{ position:relative; touch-action:pan-y; background:var(--card); padding:14px; }
    .row{ display:flex; align-items:center; gap:10px; }
    .titleTxt{ flex:1; font-weight:700; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .meta{ display:flex; gap:8px; color:var(--sub); font-size:12px; }
    .chip{ padding:4px 10px; border-radius:999px; border:1px solid var(--line); }

    .ghost{ opacity:.45; }

    .toolbar{ display:flex; gap:8px; padding:8px; }
    .toolbar input{ flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; }
    .toolbar button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; }

    .empty{ color:var(--sub); text-align:center; padding:36px 12px; }

    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; transition:.25s; }
    .toast.show{ opacity:1; }

    /* ãƒ‡ãƒãƒƒã‚° */
    #debug{ white-space:pre-wrap; font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;
      background:#fff;border:1px solid #eee; padding:8px; margin:12px 0; border-radius:8px; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
      <div class="pill" id="user-pill">loadingâ€¦</div>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰" />
      <button id="reload">å†èª­è¾¼</button>
    </div>

    <div id="pinned" class="section" hidden>
      <h3>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</h3>
      <div id="pinned-list"></div>
    </div>

    <div id="active" class="section">
      <h3>ğŸ“ æœªå®Œäº†</h3>
      <div id="active-list"></div>
    </div>

    <div id="completed" class="section" hidden>
      <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
      <div id="completed-list"></div>
    </div>

    <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>

    <!-- ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆå¿…è¦ãªã‘ã‚Œã°æ¶ˆã—ã¦OKï¼‰ -->
    <pre id="debug"></pre>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    /** =================== è¨­å®š =================== */
    const LIFF_ID       = "2008311584-NdJqOqMn";
    const LIST_API_URL  = "https://lumicreate.xvps.jp/webhook/webhook-list";
    const ACTION_API_URL= "https://lumicreate.xvps.jp/webhook/webhook-action";
    /** ============================================ */

    let gUserId = null;
    let gAllTasks = [];

    const el = sel => document.querySelector(sel);
    const $pinned = el("#pinned");
    const $pinnedList = el("#pinned-list");
    const $activeList = el("#active-list");
    const $completed = el("#completed");
    const $completedList = el("#completed-list");
    const $empty = el("#empty");

    function dbg(...a){ const d=el('#debug'); if(!d) return;
      d.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ') + '\n';
      d.scrollTop = d.scrollHeight;
    }
    function toast(msg){ const t=el("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1400); }
    const fmtJST = iso => iso ? new Date(iso).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}) : "";

    // ä¸¦ã³é †ï¼šæœŸé™æ˜‡é † â†’ å„ªå…ˆåº¦é™é †
    function sortTasks(arr){
      return arr.slice().sort((a,b)=>{
        const ad=new Date(a.due_at||0).getTime(), bd=new Date(b.due_at||0).getTime();
        if(ad!==bd) return ad-bd;
        const ap=Number.isFinite(a.priority)?a.priority:-1, bp=Number.isFinite(b.priority)?b.priority:-1;
        return bp-ap;
      });
    }
    function splitByStatus(all){
      const now=Date.now(), weekAgo=now-7*24*3600*1000;
      const pinned=[], active=[], completed=[];
      for(const t of all){
        if(t.pinned){ pinned.push(t); continue; }
        if(t.status==='completed'){
          const cAt=t.completed_at?new Date(t.completed_at).getTime():0;
          if(cAt>=weekAgo) completed.push(t);
          continue;
        }
        if(t.status==='deleted'||t.status==='archived') continue;
        active.push(t);
      }
      return { pinned:pinned.slice(0,3), active, completed };
    }

    function render(){
      const { pinned, active, completed } = splitByStatus(gAllTasks);
      const actSorted = sortTasks(active);
      const pinSorted = sortTasks(pinned);
      const compSorted= sortTasks(completed);

      $pinned.hidden    = pinSorted.length===0;
      $completed.hidden = compSorted.length===0;
      $empty.hidden     = (pinSorted.length + actSorted.length) > 0;

      $pinnedList.innerHTML    = pinSorted.map(cardHTML).join("");
      $activeList.innerHTML    = actSorted.map(cardHTML).join("");
      $completedList.innerHTML = compSorted.map(cardHTML).join("");

      // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ãƒã‚¤ãƒ³ãƒ‰
      [...document.querySelectorAll(".track")].forEach(bindSwipe);

      // ä»¶æ•°è¡¨ç¤º
      el('.title').textContent = `LISTï½œã‚¿ã‚¹ã‚¯ï¼ˆ${actSorted.length}ä»¶ï¼‰`;
      dbg('render() in items=', gAllTasks.length, 'render() out activeDom=', document.querySelectorAll('#active-list .card').length);
    }

    function cardHTML(t){
      const dueTxt = fmtJST(t.due_at);
      const ghost  = t.status==='completed' ? ' ghost' : '';
      return `
      <div class="card">
        <div class="swipe-wrap" data-id="${t.id}" data-status="${t.status}">
          <div class="actions">
            <div class="group left">
              <button class="btn ok"    data-act="complete">å®Œäº†</button>
              <button class="btn warn"  data-act="pin">${t.pinned?'ãƒ”ãƒ³è§£é™¤':'ãƒ”ãƒ³'}</button>
            </div>
            <div class="group right">
              <button class="btn"       data-act="detail">è©³ç´°</button>
              <button class="btn danger"data-act="delete">å‰Šé™¤</button>
            </div>
          </div>
          <div class="track${ghost}">
            <div class="row">
              <div class="titleTxt">${escapeHTML(t.title || '(ç„¡é¡Œ)')}</div>
              <div class="meta"><span class="chip">â° ${escapeHTML(dueTxt)}</span></div>
            </div>
          </div>
        </div>
      </div>`;
    }
    function escapeHTML(s){
      return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    /** ===== ã‚¹ãƒ¯ã‚¤ãƒ—å®Ÿè£…ï¼ˆå®Ÿæ¸¬ã‚¹ãƒŠãƒƒãƒ—ï¼‹å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰ ===== */
    // é€Ÿåº¦ãƒ»è·é›¢ã—ãã„å€¤
    const VELO_STRONG   = 1.1;   // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—é€Ÿåº¦(px/ms) ä¾‹: 1.1 = 1100px/s
    const VELO_SNAP_MAX = 0.45;  // ã‚¹ãƒŠãƒƒãƒ—è¨±å®¹æœ€å¤§é€Ÿåº¦ï¼ˆã“ã‚Œã‚ˆã‚Šé€Ÿã„ã¨å³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å„ªå…ˆï¼‰
    const STRONG_FAC    = 1.2;   // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ä¿‚æ•°ï¼ˆã‚¹ãƒŠãƒƒãƒ—è·é›¢ã®ä½•å€ã§å¼·åˆ¤å®šã«ã™ã‚‹ã‹ï¼‰
    const UNSNAP_FRAC   = 0.25;  // ã‚¹ãƒŠãƒƒãƒ—è§£é™¤ã®æˆ»ã—å‰²åˆï¼ˆã‚¹ãƒŠãƒƒãƒ—è·é›¢Ã—ã“ã®å€¤ï¼‰

    // ã‚¹ãƒŠãƒƒãƒ—è·é›¢ï¼ˆå®Ÿæ¸¬è¨ˆç®—ç”¨ï¼‰
    const PADDING_SNAP = 16; // ä½™ç™½
    const MIN_SNAP     = 88; // æœ€ä½ã‚¹ãƒŠãƒƒãƒ—
    const SAFETY       = 8;  // å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³

    function bindSwipe(track){
      const wrap    = track.parentElement;
      const actions = wrap.querySelector('.actions');
      const leftG   = actions.querySelector('.group.left');
      const rightG  = actions.querySelector('.group.right');

      let sx=0, dx=0, active=false, lastT=0, lastX=0, lastVel=0;
      let snapped=null; // 'left' or 'right'
      let snapRightDist=120, snapLeftDist=120; // å®Ÿæ¸¬å€¤

      const setTransform = x => track.style.transform = `translateX(${x}px)`;
      const showActions  = v => actions.style.opacity = v?1:0;

      // ---- ã‚¹ãƒŠãƒƒãƒ—è·é›¢ã‚’å®Ÿæ¸¬ ----
      function measure(){
        const prev = actions.style.opacity;
        actions.style.opacity = 1; // è¨ˆæ¸¬ã®ãŸã‚ä¸€ç¬å¯è¦–ï¼ˆè¦‹ãŸç›®ã¯å¤‰ã‚ã‚‰ãªã„ï¼‰
        const rw = rightG?.getBoundingClientRect().width || 0;
        const lw = leftG ?.getBoundingClientRect().width || 0;
        snapRightDist = Math.max(MIN_SNAP, Math.ceil(rw + PADDING_SNAP + SAFETY));
        snapLeftDist  = Math.max(MIN_SNAP, Math.ceil(lw + PADDING_SNAP + SAFETY));
        actions.style.opacity = prev || 0;
        // dbg('snapRightDist=',snapRightDist,'snapLeftDist=',snapLeftDist);
      }
      measure();
      window.addEventListener('resize', measure, {passive:true});

      function attachButtonHandlers(){
        // å†ãƒã‚¤ãƒ³ãƒ‰å‰ã«æ—¢å­˜ã® one-time ã‚’å¤–ã™ãŸã‚ clone â†’ replace ã§ã‚‚OK
        wrap.querySelectorAll('.btn').forEach(btn=>{
          btn.onclick = async (e)=>{
            const id  = wrap.dataset.id;
            const act = e.currentTarget.dataset.act;
            if(act==='detail'){ alert('è©³ç´°ã¯åˆ¥ç”»é¢äºˆå®šï¼ˆç°¡æ˜“è¡¨ç¤ºï¼‰'); return; }
            if(act==='delete'){
              const ok = confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
              if(!ok) return;
            }
            await runAction(id, act);
            // å®Ÿè¡Œå¾Œã¯ UI ã‚’æˆ»ã™
            snapped=null; reset();
          };
        });
      }

      function onStart(x){
        active=true; sx=x; dx=0;
        lastX=x; lastT=performance.now(); lastVel=0;
        track.style.transition='none';
      }
      function onMove(x){
        if(!active) return;
        const t = performance.now();
        dx = x - sx;

        // ã‚¹ãƒŠãƒƒãƒ—çŠ¶æ…‹ã§ã¯å›ºå®šï¼ˆè»½ã„ãƒ‰ãƒ©ãƒƒã‚°ã§æˆ»ã—ãŒä¸€å®šé‡ã‚’è¶…ãˆãŸã‚‰è§£é™¤ï¼‰
        if(snapped){
          const dist = snapped==='right' ? snapRightDist : snapLeftDist;
          const unsnapNeed = snapped==='right'
            ? (dx < -dist*UNSNAP_FRAC)
            : (dx >  dist*UNSNAP_FRAC);
          if(unsnapNeed){
            snapped=null; showActions(false);
          }else{
            setTransform(snapped==='right' ? dist : -dist);
            return;
          }
        }

        // é€šå¸¸ç§»å‹•
        setTransform(dx);
        showActions(Math.min(1, Math.abs(dx)/80));

        // é€Ÿåº¦è¨ˆç®—
        const dt = Math.max(1, t - lastT); // ms
        const vx = (x - lastX) / dt;       // px/ms
        lastVel = vx;
        lastX = x; lastT = t;
      }
      function onEnd(){
        track.style.transition='transform .18s ease';

        const absDx = Math.abs(dx);
        const dir   = dx>0 ? 'right' : 'left';
        const v     = Math.abs(lastVel);

        // ã‚¹ãƒŠãƒƒãƒ—åˆ¤å®šï¼ˆè·é›¢ã®7å‰²ä»¥ä¸Š & é€Ÿåº¦ãŒé…ã„ã¨ãï¼‰
        const base = dir==='right' ? snapRightDist : snapLeftDist;
        const needSnap = (absDx >= base*0.70) && (v <= VELO_SNAP_MAX);

        if(needSnap){
          snapped = dir;
          setTransform(dir==='right' ? base : -base);
          showActions(true);
          attachButtonHandlers();
          // ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼ˆã©ã“ã§ã‚‚ï¼‰
          track.onclick = ()=>{ snapped=null; reset(); track.onclick=null; };
          active=false; return;
        }

        // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆè·é›¢ã‹é€Ÿåº¦ã§æˆç«‹ï¼‰
        const strongByDist = absDx >= base * STRONG_FAC;
        const strongByVel  = (v >= VELO_STRONG) && (absDx >= base*0.90);

        if(strongByDist || strongByVel){
          const id = wrap.dataset.id;
          const status = wrap.dataset.status;
          if(dir==='right'){
            // å³ï¼šæœªå®Œäº†â†’å®Œäº†ã€å®Œäº†â†’å–æ¶ˆ
            const action = (status==='completed') ? 'uncomplete' : 'complete';
            runAction(id, action).then(()=>reset());
          }else{
            // å·¦ï¼šå‰Šé™¤ï¼ˆç¢ºèªï¼‰
            const ok = confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
            if(ok) runAction(id, 'delete').then(()=>reset());
            else reset();
          }
          active=false; return;
        }

        // ã©ã‚Œã§ã‚‚ãªã„ï¼šæˆ»ã™
        reset();
        active=false;
      }
      function reset(){
        track.style.transition='transform .18s ease';
        setTransform(0); showActions(false);
      }

      // ç«¯æœ«ã‚¤ãƒ™ãƒ³ãƒˆ
      track.addEventListener('touchstart', e=>onStart(e.touches[0].clientX), {passive:true});
      track.addEventListener('touchmove',  e=>onMove(e.touches[0].clientX),  {passive:true});
      track.addEventListener('touchend',   onEnd);

      // ãƒã‚¦ã‚¹ï¼ˆé–‹ç™ºç”¨ï¼‰
      track.addEventListener('mousedown', e=>onStart(e.clientX));
      track.addEventListener('mousemove', e=>{ if(e.buttons===1) onMove(e.clientX); });
      track.addEventListener('mouseup', onEnd);
    }

    /** ===== API ===== */
    async function runAction(id, action){
      try{
        if(action==='detail'){ return; }
        const res = await fetch(ACTION_API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ action, task_id:id, user_id:gUserId }),
        });
        const j = await res.json().catch(()=>({ok:false}));
        if(!res.ok || j.ok===false) throw new Error(j.message || 'action failed');
        toast(actionLabel(action)+'ã—ã¾ã—ãŸ');
        await loadTasks(); // UIå†æç”»
      }catch(err){
        console.error(err); toast('ã‚¨ãƒ©ãƒ¼: '+(err.message||'failed'));
      }
    }
    function actionLabel(a){
      return ({pin:'ãƒ”ãƒ³', complete:'å®Œäº†', uncomplete:'å®Œäº†å–æ¶ˆã—', delete:'å‰Šé™¤', remind:'ãƒªãƒã‚¤ãƒ³ãƒ‰'}[a]||a);
    }

    async function loadTasks(userId){
      dbg('loadTasks userId=', userId);
      if(!userId){
        try{ const prof=await liff.getProfile(); userId=prof.userId; gUserId=userId; }
        catch(e){ dbg('loadTasks: cannot get userId:', e.message||e); toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã«å¤±æ•—'); return; }
      }
      const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
      let res, payload;
      try{
        res = await fetch(url, { method:'GET', credentials:'omit', headers:{'Content-Type':'application/json'} });
        payload = await res.json();
      }catch(e){
        dbg('fetch/json error:', e.message||e); toast('èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆé€šä¿¡/JSONï¼‰'); return;
      }
      dbg('status=',res.status,'payload.ok=',payload?.ok);
      if(!res.ok || !payload || payload.ok!==true){ toast('èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆHTTP '+res.status+'ï¼‰'); return; }

      // {ok:true, pinned/active/completed}
      const pinned    = Array.isArray(payload.pinned)?payload.pinned:[];
      const active    = Array.isArray(payload.active)?payload.active:[];
      const completed = Array.isArray(payload.completed)?payload.completed:[];

      gAllTasks = [...pinned, ...active, ...completed];
      dbg('gAllTasks.length=', gAllTasks.length);
      render();
    }

    async function bootstrap(){
      // LIFF
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) liff.login();
      const prof = await liff.getProfile();
      gUserId = prof.userId;
      el('#user-pill').textContent = 'You: ' + gUserId.slice(-6);
      dbg('LIFF_ID=', LIFF_ID, '\nliff.init OK');
      dbg('profile OK userId=', gUserId);

      // UI
      el('#reload').onclick = () => loadTasks(gUserId);
      el('#q').addEventListener('input', e=>{
        const q = e.target.value.trim().toLowerCase();
        if(!q){ render(); return; }
        const filtered = gAllTasks.filter(t =>
          (t.title||'').toLowerCase().includes(q) || (t.detail||'').toLowerCase().includes(q)
        );
        const { pinned, active, completed } = splitByStatus(filtered);
        $pinned.hidden = pinned.length===0; $completed.hidden = completed.length===0; $empty.hidden=true;
        $pinnedList.innerHTML = sortTasks(pinned).map(cardHTML).join("");
        $activeList.innerHTML = sortTasks(active).map(cardHTML).join("");
        $completedList.innerHTML = sortTasks(completed).map(cardHTML).join("");
        [...document.querySelectorAll(".track")].forEach(bindSwipe);
      });

      await loadTasks(gUserId);
    }

    bootstrap();
  </script>
</body>
</html>
