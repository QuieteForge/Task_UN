<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LISTï½œã‚¿ã‚¹ã‚¯</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
    --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px}
  .title{font-weight:650;letter-spacing:.2px}
  .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px}
  main{padding:14px;max-width:720px;margin:0 auto}
  h3{margin:8px 6px 10px;font-size:13px;color:var(--sub);font-weight:600}

  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .track{position:relative;touch-action:pan-y;background:var(--card);border-radius:16px}
  .row{display:flex;gap:8px;align-items:center;padding:12px 14px}
  .titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
  .due{padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
  .pin{font-size:12px;color:var(--accent)}
  .ghost{opacity:.45}

  .actions{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;padding:0 8px;pointer-events:none}
  .btn{pointer-events:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px}
  .btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
  .btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
  .btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}
  .btn.ghost{opacity:.9}

  .detail{display:none;border-top:1px dashed var(--line);padding:10px 12px 12px 12px;position:relative;border-bottom-left-radius:16px;border-bottom-right-radius:16px}
  .detail.open{display:block}
  .detail .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .detail .close{border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer;padding:6px;margin:-6px  -4px 0 8px}
  .detail .grid{display:grid;grid-template-columns:90px 1fr;gap:8px;align-items:center}
  .detail input[type="text"], .detail textarea, .detail select, .detail input[type="datetime-local"]{
    width:100%;padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit
  }
  .detail textarea{min-height:70px;resize:vertical}
  .detail .save{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}
  .detail .note{font-size:12px;color:var(--sub)}
  .empty{color:var(--sub);text-align:center;padding:36px 12px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
  .toast.show{opacity:1}
  .debug{white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;margin:8px;border-radius:8px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <section>
    <h3>ğŸ“ æœªå®Œäº†</h3>
    <div id="active-list"></div>
  </section>

  <section id="completed-sec" hidden>
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </section>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<div id="toast" class="toast"></div>
<pre id="debug" class="debug" hidden></pre>

<script>
/** ====== è¨­å®šï¼ˆå·®ã—æ›¿ãˆï¼‰ ====== */
const LIFF_ID       = "2008311584-NdJqOqMn";
const LIST_API_URL  = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL= "https://lumicreate.xvps.jp/webhook/webhook-action";
/** ================================= */

let gUserId = null;
let gAllTasks = [];
let openDetailTaskId = null;

const $ = (s)=>document.querySelector(s);
const $$=(s)=>Array.from(document.querySelectorAll(s));
const $active = $('#active-list');
const $completed = $('#completed-list');
const $completedSec = $('#completed-sec');
const $empty = $('#empty');

function dbg(...a){ /* $('#debug').textContent += a.join(' ')+'\n'; */ }
function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

function jstEndOfTodayISO(){
  const d = new Date();
  const jst = new Date(d.toLocaleString('en-US',{timeZone:'Asia/Tokyo'}));
  jst.setHours(24,0,0,0); // 24:00 of today JST -> next day 00:00
  const utc = new Date(jst.getTime() - (9*3600*1000)); // back to UTC
  return utc.toISOString();
}
function defaultRemindFromDueISO(dueISO){
  const due = new Date(dueISO);
  return new Date(due.getTime() - 2*3600*1000).toISOString();
}
function fmtJST(iso){
  if(!iso) return '';
  const d = new Date(iso);
  return d.toLocaleString('ja-JP',{timeZone:'Asia/Tokyo', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
}
function toDatetimeLocalValue(iso){
  if(!iso) return '';
  const d = new Date(iso);
  const pad = (n)=> String(n).padStart(2,'0');
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function fromDatetimeLocalValue(v){
  if(!v) return '';
  // treat as local time -> convert to UTC ISO
  const local = new Date(v);
  return new Date(local.getTime() - local.getTimezoneOffset()*60000).toISOString();
}

function splitByStatus(all){
  const now = Date.now();
  const weekAgo = now - 7*24*3600*1000;
  const active=[], completed=[];
  for(const t of all){
    if(t.status==='completed'){
      const cAt = t.completed_at ? new Date(t.completed_at).getTime() : 0;
      if(cAt >= weekAgo) completed.push(t);
    }else if(t.status!=='deleted' && t.status!=='archived'){
      active.push(t);
    }
  }
  return {active, completed};
}
function sortTasks(arr){
  return arr.slice().sort((a,b)=>{
    const ad = new Date(a.due_at||0).getTime();
    const bd = new Date(b.due_at||0).getTime();
    if(ad!==bd) return ad-bd; // æœŸé™æ˜‡é †
    const ap = Number.isFinite(a.priority)?a.priority:-1;
    const bp = Number.isFinite(b.priority)?b.priority:-1;
    return bp-ap; // å„ªå…ˆåº¦é™é †
  });
}

function closeAnyDetail(exceptId=null){
  $$('.detail.open').forEach(el=>{
    if(exceptId && el.dataset.id===exceptId) return;
    el.classList.remove('open');
  });
  if(!exceptId) openDetailTaskId = null;
}

function cardHTML(t){
  const pin = t.pinned ? '<span class="pin">ğŸ“Œ</span>' : '';
  const ghost = t.status==='completed' ? ' ghost' : '';
  const dueTxt = fmtJST(t.due_at);

  // ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é…ç½®ï¼šå·¦=å®Œäº†/æœªå®Œäº†, ãƒ”ãƒ³ / å³=è©³ç´°, å‰Šé™¤
  const leftPrimary = (t.status==='completed') ? 'uncomplete' : 'complete';
  const leftPrimaryLabel = (t.status==='completed') ? 'æœªå®Œäº†' : 'å®Œäº†';

  return `
  <div class="card" data-id="${t.id}" data-status="${t.status}">
    <div class="actions">
      <div style="display:flex;gap:6px">
        <button class="btn ok" data-act="${leftPrimary}">${leftPrimaryLabel}</button>
        <button class="btn warn" data-act="pin">${t.pinned?'ãƒ”ãƒ³è§£é™¤':'ãƒ”ãƒ³'}</button>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn" data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track${ghost}">
      <div class="row">
        <div class="titleTxt">${pin}${escapeHTML(t.title||'(ç„¡é¡Œ)')}</div>
        <div class="meta"><span class="due">â° ${escapeHTML(dueTxt)}</span>${Number.isFinite(t.priority)?`<span class="due">â˜…${t.priority}</span>`:''}</div>
      </div>
    </div>
    ${detailHTML(t)}
  </div>`;
}
function detailHTML(t){
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const defDue = t.due_at || jstEndOfTodayISO();
  const defRem = (t.remind_times && t.remind_times.length>0) ? t.remind_times[0] : defaultRemindFromDueISO(defDue);
  const defPri = Number.isFinite(t.priority) ? t.priority : 1;

  return `
  <div class="detail" data-id="${t.id}">
    <div class="hdr">
      <div class="note">è©³ç´°ã‚’ç·¨é›†</div>
      <button class="close" aria-label="é–‰ã˜ã‚‹" title="é–‰ã˜ã‚‹">âœ•</button>
    </div>
    <div class="grid">
      <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
      <textarea name="detail">${escapeHTML(t.detail||'')}</textarea>

      <label>å„ªå…ˆåº¦</label>
      <select name="priority">
        <option value="1" ${defPri===1?'selected':''}>1</option>
        <option value="2" ${defPri===2?'selected':''}>2</option>
        <option value="3" ${defPri===3?'selected':''}>3</option>
      </select>

      <label>æœŸé™</label>
      <input type="datetime-local" name="due_at" value="${toDatetimeLocalValue(defDue)}"/>

      <label>ãƒªãƒã‚¤ãƒ³ãƒ‰</label>
      <input type="datetime-local" name="remind" value="${toDatetimeLocalValue(defRem)}"/>
    </div>
    <button class="save">ä¿å­˜</button>
  </div>`;
}

function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function render(){
  const {active, completed} = splitByStatus(gAllTasks);
  const a = sortTasks(active);
  const c = sortTasks(completed);

  $active.innerHTML = a.map(cardHTML).join('');
  $completed.innerHTML = c.map(cardHTML).join('');
  $completedSec.hidden = c.length===0;
  $empty.hidden = (a.length+c.length) > 0;

  // ãƒã‚¤ãƒ³ãƒ‰
  $$('.card').forEach(bindCard);
}

function bindCard(card){
  const id = card.dataset.id;
  const track = card.querySelector('.track');
  const actions = card.querySelector('.actions');
  const detail = card.querySelector('.detail');
  const closeBtn = detail.querySelector('.close');
  const saveBtn = detail.querySelector('.save');

  // 1æšã ã‘é–‹ã
  track.addEventListener('click', ()=>{
    if(detail.classList.contains('open')){
      detail.classList.remove('open'); openDetailTaskId=null; return;
    }
    closeAnyDetail();
    detail.classList.add('open'); openDetailTaskId=id;
  });
  closeBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    detail.classList.remove('open'); openDetailTaskId=null;
  });
  saveBtn.addEventListener('click', async (e)=>{
    e.stopPropagation();
    const body = collectDetailPayload(card);
    const ok = await postAction('update', id, body.fields);
    if(ok){ toast('ä¿å­˜ã—ã¾ã—ãŸ'); await loadTasks(gUserId); }
    else{ toast('ä¿å­˜ã«å¤±æ•—'); }
  });

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆè»½ã‚¹ãƒ¯ã‚¤ãƒ—æ™‚ã«ä½¿ã†ï¼‰
  actions.querySelectorAll('.btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      e.stopPropagation();
      const act = btn.dataset.act;
      if(act==='detail'){
        // å³ãƒœã‚¿ãƒ³ã®ã€Œè©³ç´°ã€ã¯é–‹é–‰ãƒˆã‚°ãƒ«
        if(detail.classList.contains('open')){ detail.classList.remove('open'); openDetailTaskId=null; }
        else{ closeAnyDetail(); detail.classList.add('open'); openDetailTaskId=id; }
        return;
      }
      if(act==='delete'){
        if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      }
      const ok = await postAction(act, id);
      if(ok){ await loadTasks(gUserId); }
      else{ toast('å‡¦ç†ã«å¤±æ•—'); }
    });
  });

  // ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå·¦ï¼šå®Œäº†/æœªå®Œäº†ãƒ»ãƒ”ãƒ³ã€å³ï¼šè©³ç´°ãƒ»å‰Šé™¤ï¼‰
  bindSwipe(track, actions, id, card.dataset.status);
}

function collectDetailPayload(card){
  const d = card.querySelector('.detail');
  const detail = d.querySelector('[name="detail"]').value;
  const priority = Number(d.querySelector('[name="priority"]').value);
  const dueLocal = d.querySelector('[name="due_at"]').value;
  const remindLocal = d.querySelector('[name="remind"]').value;

  const dueISO = fromDatetimeLocalValue(dueLocal) || jstEndOfTodayISO();
  const remindISO = fromDatetimeLocalValue(remindLocal) || defaultRemindFromDueISO(dueISO);

  return {
    fields: {
      detail,
      priority,
      due_at: dueISO,
      remind_times: [remindISO],
    }
  };
}

async function postAction(action, task_id, fields){
  try{
    const res = await fetch(ACTION_API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action, task_id, user_id:gUserId, ...(fields?{fields}:{} ) })
    });
    const j = await res.json().catch(()=>({ok:false}));
    if(!res.ok || j.ok===false) throw new Error(j.message||'failed');
    return true;
  }catch(e){
    console.error(e);
    return false;
  }
}

/* ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡
 * å·¦ï¼ˆdx>0ï¼‰: å®Œäº†/æœªå®Œäº†ã€ãƒ”ãƒ³
 * å³ï¼ˆdx<0ï¼‰: è©³ç´°ã€å‰Šé™¤
 * è»½ã‚¹ãƒ¯ã‚¤ãƒ—ã¯ã€Œã‚¹ãƒŠãƒƒãƒ—ã€ã—ã¦ãƒœã‚¿ãƒ³æ“ä½œã€å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ã¯å³æ™‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 * åŠ é€Ÿåº¦åˆ¤å®š: |vx| >= VX_STRONG ã§å¼·ã‚¹ãƒ¯ã‚¤ãƒ—
 */
function bindSwipe(track, actions, id, status){
  const SW_SNAP = 84;       // ã‚¹ãƒŠãƒƒãƒ—ä½ç½®ï¼ˆãƒœã‚¿ãƒ³æ“ä½œç”¨ã«æ­¢ã‚ã‚‹å¹…ï¼‰
  const SW_STRONG = 140;    // ã“ã‚Œã‚’è¶…ãˆãŸã‚‰å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå³æ™‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
  const VX_STRONG = 1.2;    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ã®é€Ÿåº¦ï¼ˆpx/msï¼‰

  let sx=0, dx=0, active=false, startT=0, lastX=0, lastT=0, vx=0, raf=null;

  const setX=(x)=>{ track.style.transform = `translateX(${x}px)`; actions.style.opacity = Math.min(1, Math.abs(x)/70); };

  const onStart=(x)=>{
    active=true; sx=x; dx=0; startT=Date.now(); lastX=x; lastT=startT; vx=0;
    track.style.transition='none';
    if(raf) cancelAnimationFrame(raf);
  };
  const onMove=(x)=>{
    if(!active) return;
    const now=Date.now();
    dx = x - sx;
    const dt = Math.max(1, now - lastT);
    vx = (x - lastX) / dt; // px/ms
    lastX = x; lastT = now;
    setX(dx);
  };
  const strongAction = async(direction)=>{
    // å·¦=å®Œäº†/æœªå®Œäº†, å³=å‰Šé™¤ï¼ˆç¢ºèªï¼‰
    if(direction==='left'){ // dx>0
      const act = (status==='completed') ? 'uncomplete' : 'complete';
      const ok = await postAction(act, id);
      if(ok) await loadTasks(gUserId); else toast('å‡¦ç†ã«å¤±æ•—');
    }else{ // right
      if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ reset(); return; }
      const ok = await postAction('delete', id);
      if(ok) await loadTasks(gUserId); else toast('å‡¦ç†ã«å¤±æ•—');
    }
  };
  const snap = (direction)=>{
    track.style.transition='transform .16s ease';
    const snapX = (direction==='left') ? SW_SNAP : -SW_SNAP;
    setX(snapX);
    // ã‚¹ãƒŠãƒƒãƒ—ä¸­ã¯ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ã‚‹
    // 2ç§’å¾Œã«è‡ªå‹•ã§æˆ»ã™ï¼ˆæŠ¼ã•ã‚Œãªã‹ã£ãŸå ´åˆï¼‰
    setTimeout(()=> reset(), 2000);
  };
  const reset = ()=>{
    track.style.transition='transform .16s ease';
    setX(0);
  };
  const onEnd=()=>{
    if(!active) return;
    active=false;
    // åˆ¤å®š
    const direction = dx>0 ? 'left' : (dx<0 ? 'right' : 'none');
    const absDx = Math.abs(dx);
    const absVx = Math.abs(vx);

    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—: é€Ÿã• or è·é›¢ ãŒã—ãã„å€¤ã‚’è¶…ãˆãŸã‚‰å³æ™‚
    if((absVx >= VX_STRONG && absDx >= SW_SNAP) || absDx >= SW_STRONG){
      strongAction(direction);
      return;
    }
    // è»½ã‚¹ãƒ¯ã‚¤ãƒ—: ã‚¹ãƒŠãƒƒãƒ—ã—ã¦ãƒœã‚¿ãƒ³æ“ä½œã‚’å¯èƒ½ã«
    if(absDx >= SW_SNAP){
      snap(direction);
      return;
    }
    // æˆ»ã™
    reset();
  };

  // ãƒœã‚¿ãƒ³é ˜åŸŸã§ã®ã‚¯ãƒªãƒƒã‚¯ãŒã‚¹ãƒ¯ã‚¤ãƒ—è§£é™¤å¾Œã‚‚åŠ¹ãã‚ˆã†ã«
  actions.addEventListener('click', (e)=>e.stopPropagation());

  track.addEventListener('touchstart', e=>onStart(e.touches[0].clientX), {passive:true});
  track.addEventListener('touchmove',  e=>onMove(e.touches[0].clientX),  {passive:true});
  track.addEventListener('touchend', onEnd);
  // ãƒã‚¦ã‚¹ï¼ˆé–‹ç™ºç”¨ï¼‰
  track.addEventListener('mousedown', e=>onStart(e.clientX));
  track.addEventListener('mousemove', e=>{ if(e.buttons===1) onMove(e.clientX); });
  track.addEventListener('mouseup', onEnd);
}

async function loadTasks(userId){
  if(!userId){
    const prof = await liff.getProfile();
    userId = prof.userId;
    gUserId = userId;
  }
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
  let res, payload;
  try{
    res = await fetch(url, {method:'GET', credentials:'omit', headers:{'Content-Type':'application/json'}});
    payload = await res.json();
  }catch(e){
    toast('èª­ã¿è¾¼ã¿å¤±æ•—'); return;
  }
  if(!res.ok || !payload || payload.ok!==true){ toast('èª­ã¿è¾¼ã¿å¤±æ•—'); return; }

  const pinned = Array.isArray(payload.pinned)?payload.pinned:[];
  const active = Array.isArray(payload.active)?payload.active:[];
  const completed = Array.isArray(payload.completed)?payload.completed:[];
  gAllTasks = [...pinned, ...active, ...completed];
  render();
}

(async function bootstrap(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  gUserId = prof.userId;
  $('#user-pill').textContent = "You: " + gUserId.slice(-6);
  await loadTasks(gUserId);
})();
</script>
</body>
</html>
