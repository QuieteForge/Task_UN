<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LISTï½œã‚¿ã‚¹ã‚¯</title>
<link rel="preconnect" href="https://static.line-scdn.net">
<style>
  :root{
    --bg:#f7f7f8;--card:#fff;--ink:#111;--sub:#666;--line:#e9e9ec;
    --pill:#eef2ff;--accent:#3957ff;--ok:#16a34a;--warn:#eab308;--danger:#ef4444;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
  .title{font-weight:650}
  .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px}
  main{padding:14px;max-width:720px;margin:0 auto}
  h3{margin:10px 6px;color:var(--sub);font-size:13px}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .row{display:flex;align-items:center;gap:8px;padding:12px 14px}
  .titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
  .chip{padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
  .pin{color:var(--accent)}
  .ghost{opacity:.45}

  /* swipe */
  .swipe-wrap{position:relative;overflow:hidden;border-radius:16px}
  .actions{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;padding:0 8px;opacity:0;pointer-events:none;transition:opacity .15s}
  .btn{pointer-events:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px}
  .btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
  .btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
  .btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}
  .track{position:relative;touch-action:pan-y;background:#fff;z-index:1;transition:transform .18s ease}
  .swipe-wrap.menu .actions{opacity:1;pointer-events:auto}
  .swipe-wrap.menu .track{transform:translateX(-96px)}

  .empty{color:var(--sub);text-align:center;padding:36px 12px}
  #debug{white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;margin:8px;border-radius:8px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
  .toast.show{opacity:1}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div id="user-pill" class="pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div style="display:flex;gap:8px;padding:8px">
    <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰" style="flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff">
    <button id="reload" style="padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff">å†èª­è¾¼</button>
  </div>

  <section id="pinned-sec" hidden>
    <h3>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</h3>
    <div id="pinned-list"></div>
  </section>

  <section>
    <h3>ğŸ“ æœªå®Œäº†</h3>
    <div id="active-list"></div>
  </section>

  <section id="completed-sec" hidden>
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </section>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<pre id="debug"></pre>
<div id="toast" class="toast"></div>

<script>
/** ====== è¨­å®š ====== */
const LIFF_ID       = "2008311584-NdJqOqMn";
const LIST_API_URL  = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL= "https://lumicreate.xvps.jp/webhook/webhook-action";
const DEBUG = true;

/** ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const $ = sel => document.querySelector(sel);
function dbg(...a){ if(!DEBUG) return; const d=$("#debug"); if(d) d.textContent += a.map(v=>typeof v==='string'?v:JSON.stringify(v)).join(' ')+"\n"; }
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1400); }
function esc(s){ return String(s||"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function fmtJST(iso){ if(!iso) return ""; const d=new Date(iso); return d.toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}); }

/** ====== çŠ¶æ…‹ ====== */
let gUserId=null, gAll=[];

/** ====== æç”» ====== */
function splitByStatus(all){
  const now=Date.now(), weekAgo=now-7*24*3600*1000;
  const pinned=[], active=[], completed=[];
  for(const t of all){
    if(t.pinned){ pinned.push(t); continue; }
    if(t.status==="completed"){
      const ct=t.completed_at?new Date(t.completed_at).getTime():0;
      if(ct>=weekAgo) completed.push(t);
      continue;
    }
    if(t.status==="deleted"||t.status==="archived") continue;
    active.push(t);
  }
  const byDue=(a,b)=>{
    const ad=new Date(a.due_at||0).getTime(), bd=new Date(b.due_at||0).getTime();
    if(ad!==bd) return ad-bd;
    const ap=Number.isFinite(a.priority)?a.priority:-1, bp=Number.isFinite(b.priority)?b.priority:-1;
    return bp-ap;
  };
  return { pinned:pinned.sort(byDue).slice(0,3), active:active.sort(byDue), completed:completed.sort(byDue) };
}

function cardHTML(t){
  const due=fmtJST(t.due_at), ghost=t.status==="completed"?" ghost":"";
  const pin=t.pinned?'<span class="pin">ğŸ“Œ</span>':'';
  const leftBtn = t.status==="completed" ? '<button class="btn ok" data-act="uncomplete">å–æ¶ˆ</button>' : '<button class="btn ok" data-act="complete">å®Œäº†</button>';
  return `
  <div class="swipe-wrap card${ghost}" data-id="${t.id}" data-status="${t.status||'active'}">
    <div class="actions">
      <div style="display:flex;gap:6px">${leftBtn}<button class="btn warn" data-act="remind">ï¾˜ï¾ï½²ï¾ï¾„ï¾</button></div>
      <div style="display:flex;gap:6px">
        <button class="btn" data-act="pin">${t.pinned?"ãƒ”ãƒ³è§£é™¤":"ãƒ”ãƒ³"}</button>
        <button class="btn" data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track">
      <div class="row">
        <div class="titleTxt">${pin}${esc(t.title||"(ç„¡é¡Œ)")}</div>
        <div class="meta"><span class="chip">â° ${esc(due)}</span>${Number.isFinite(t.priority)?`<span class="chip">â˜…${t.priority}</span>`:""}</div>
      </div>
    </div>
  </div>`;
}

function render(){
  const {pinned,active,completed}=splitByStatus(gAll);
  $("#pinned-sec").hidden = pinned.length===0;
  $("#completed-sec").hidden = completed.length===0;
  $("#empty").hidden = (pinned.length+active.length)>0;

  $("#pinned-list").innerHTML   = pinned.map(cardHTML).join("");
  $("#active-list").innerHTML   = active.map(cardHTML).join("");
  $("#completed-list").innerHTML= completed.map(cardHTML).join("");

  [...document.querySelectorAll(".track")].forEach(bindSwipe);
  $(".title").textContent = `LISTï½œã‚¿ã‚¹ã‚¯ï¼ˆ${gAll.length}ä»¶ï¼‰`;
  dbg("render() items=", gAll.length, "tracks=", document.querySelectorAll(".track").length);
}

/** ====== ã‚¹ãƒ¯ã‚¤ãƒ— ====== */
function bindSwipe(track){
  const wrap=track.parentElement, actions=wrap.querySelector(".actions");
  const SW_MENU=36, SW_ACTION=120;
  let sx=0, dx=0, active=false;

  const isOpen = ()=>wrap.classList.contains("menu");
  const open   = ()=>{ closeAll(); wrap.classList.add("menu"); actions.style.opacity=1; };
  const close  = ()=>{ wrap.classList.remove("menu"); actions.style.opacity=0; track.style.transform="translateX(0)"; };

  function closeAll(){ document.querySelectorAll(".swipe-wrap.menu").forEach(w=>{ w.classList.remove("menu"); const a=w.querySelector(".actions"), tr=w.querySelector(".track"); if(a) a.style.opacity=0; if(tr) tr.style.transform="translateX(0)"; }); }

  const start=x=>{ active=true; sx=x; dx=0; track.style.transition="none"; };
  const move =x=>{
    if(!active) return;
    dx=x-sx;
    if(isOpen()){ if(dx>16) close(); return; }
    track.style.transform=`translateX(${dx}px)`;
    actions.style.opacity=Math.min(1,Math.abs(dx)/80);
  };
  const end =async ()=>{
    track.style.transition="transform .18s ease";
    if(isOpen()){ if(Math.abs(dx)<12) close(); active=false; dx=0; return; }

    let act=null;
    if(dx<=-SW_ACTION) act="delete";
    else if(dx>=SW_ACTION) act=(wrap.dataset.status==="completed")?"uncomplete":"complete";
    else if(dx<=-SW_MENU) open();
    else if(dx>=SW_MENU) act="pin";

    if(!isOpen()){ track.style.transform="translateX(0)"; actions.style.opacity=0; }

    active=false; const id=wrap.dataset.id; dx=0;
    if(!act) return;
    try{ await runAction(id,act); }catch(e){ console.error(e); toast("ã‚¨ãƒ©ãƒ¼: "+(e.message||"failed")); }
  };

  wrap.querySelectorAll(".btn").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      const id=wrap.dataset.id, act=e.currentTarget.dataset.act;
      if(act==="detail"){ alert("è©³ç´°ã¯åˆ¥ç”»é¢äºˆå®š"); return; }
      if(act==="delete" && !confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      close();
      try{ await runAction(id,act); }catch(err){ console.error(err); toast("ã‚¨ãƒ©ãƒ¼: "+(err.message||"failed")); }
    });
  });

  track.addEventListener("touchstart",e=>start(e.touches[0].clientX),{passive:true});
  track.addEventListener("touchmove", e=>move(e.touches[0].clientX), {passive:true});
  track.addEventListener("touchend", end);
  track.addEventListener("mousedown", e=>start(e.clientX));
  track.addEventListener("mousemove", e=>{ if(e.buttons===1) move(e.clientX); });
  track.addEventListener("mouseup", end);
  document.addEventListener("click", e=>{ if(!wrap.contains(e.target)) closeAll(); });
}

/** ====== API ====== */
async function loadTasks(userId){
  dbg("loadTasks userId=", userId);
  const url=`${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
  let res, payload;
  try{
    res = await fetch(url,{method:"GET",credentials:"omit",headers:{"Content-Type":"application/json"}});
    payload = await res.json();
  }catch(e){ dbg("fetch/json error:", e.message||e); toast("èª­ã¿è¾¼ã¿å¤±æ•—"); return; }
  dbg("status=", res.status, "payload.ok=", payload && payload.ok);

  if(!res.ok || !payload || payload.ok!==true){ toast(`èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆHTTP ${res && res.status}ï¼‰`); return; }

  // äº’æ›: {ok:true,data:[]} or {ok:true,pinned/active/completed}
  if(Array.isArray(payload.data)){
    gAll = payload.data;
  }else{
    const P = Array.isArray(payload.pinned)?payload.pinned:[];
    const A = Array.isArray(payload.active)?payload.active:[];
    const C = Array.isArray(payload.completed)?payload.completed:[];
    gAll = [...P,...A,...C];
  }
  dbg("gAll length=", gAll.length);
  render();
}

function actionLabel(a){ return ({pin:"ãƒ”ãƒ³",complete:"å®Œäº†",uncomplete:"å–æ¶ˆ",delete:"å‰Šé™¤",remind:"ï¾˜ï¾ï½²ï¾ï¾„ï¾"}[a]||a); }

async function runAction(id, act){
  const body={action:act,task_id:id,user_id:gUserId};
  const res=await fetch(ACTION_API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  const j=await res.json().catch(()=>({ok:false}));
  if(!res.ok||!j.ok){toast("å¤±æ•—ã—ã¾ã—ãŸ");return;}

  // ãƒ­ãƒ¼ã‚«ãƒ«å³æ™‚åæ˜ 
  const t=gAll.find(t=>t.id===id);
  if(t){
    if(act==="delete") gAll=gAll.filter(x=>x.id!==id);
    if(act==="complete") t.status="completed";
    if(act==="uncomplete") t.status="active";
    if(act==="pin") t.pinned=!t.pinned;
  }
  render();

  toast("æ›´æ–°ã—ã¾ã—ãŸ");
  // SupabaseåŒæœŸ
  setTimeout(()=>load(),1000);
}


/** ====== èµ·å‹• ====== */
(async function bootstrap(){
  try{
    dbg("LIFF_ID=", LIFF_ID);
    await liff.init({ liffId: LIFF_ID });
    dbg("liff.init OK");
    if(!liff.isLoggedIn()) liff.login();
    const ctx = liff.getContext(); dbg("context", ctx);
    const prof = await liff.getProfile(); dbg("profile OK userId=", prof.userId);
    gUserId = prof.userId;
    $("#user-pill").textContent = "You: " + gUserId.slice(-6);

    $("#reload").onclick = ()=>loadTasks(gUserId);
    $("#q").addEventListener("input", e=>{
      const q=e.target.value.trim().toLowerCase();
      if(!q){ render(); return; }
      const filt = gAll.filter(t=>(t.title||"").toLowerCase().includes(q) || (t.detail||"").toLowerCase().includes(q));
      const bak = gAll; gAll=filt; render(); gAll=bak;
    });

    await loadTasks(gUserId);
  }catch(e){
    console.error(e);
    dbg("bootstrap error:", e.message||e);
    toast("åˆæœŸåŒ–ã«å¤±æ•—");
  }
})();
</script>
</body>
</html>

