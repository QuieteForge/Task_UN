<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LISTÔΩú„Çø„Çπ„ÇØ</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
      --left-bg:#ecfdf5; --right-bg:#fef2f2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    header{
      position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--line); z-index:10;
    }
    .bar{display:flex; align-items:center; gap:8px; justify-content:space-between; padding:12px 16px;}
    .title{font-weight:650; letter-spacing:.2px}
    .pill{padding:6px 10px; border-radius:999px; background:var(--pill); font-size:12px}
    main{padding:14px; max-width:720px; margin:0 auto}

    .section{margin:18px 0}
    .section h3{margin:8px 6px 10px; font-size:13px; color:var(--sub); font-weight:600}

    .swipe-wrap{
      position:relative; border-radius:16px; margin:10px 0;
      background:linear-gradient(90deg, var(--left-bg) 0 50%, var(--right-bg) 50% 100%);
      background-size:200% 100%; background-position:50% 0;
      overflow:hidden; border:1px solid var(--line); box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .actions{
      position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center;
      padding:0 8px; pointer-events:none;
    }
    .actions .left, .actions .right{display:flex; gap:8px}
    .btn{
      pointer-events:auto; padding:8px 10px; border-radius:10px;
      border:1px solid var(--line); background:#fff; font-size:12px; user-select:none;
    }
    .btn.ok{border-color:#c7ecd1; color:var(--ok);}
    .btn.uncomplete{border-color:#fde68a; color:var(--warn);} /* ‚Üê ÈªÑËâ≤„Éú„Çø„É≥ */
    .btn.info{border-color:#dbeafe; color:#2563eb;}
    .btn.danger{border-color:#fecaca; color:var(--danger);}

    .track{position:relative; background:var(--card); touch-action:pan-y; will-change:transform;}
    .card{padding:12px 14px;}
    .row{display:flex; align-items:center; gap:8px}
    .titleTxt{flex:1; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta{display:flex; gap:8px; color:var(--sub); font-size:12px}
    .chip{padding:2px 8px; border-radius:999px; border:1px solid var(--line)}
    .ghost .titleTxt{opacity:.45}

    .detail{max-height:0; overflow:hidden; transition:max-height .24s ease, padding .24s ease, border .24s ease;
      padding:0 14px; border-top:1px solid transparent; background:#fff;}
    .detail.open{padding:10px 14px 14px; border-top:1px solid var(--line);}
    .detail .grid{display:grid; grid-template-columns:96px 1fr; gap:8px 10px; align-items:center}
    .detail label{font-size:12px; color:var(--sub)}
    .detail input,.detail select,.detail textarea{
      width:100%; padding:8px 10px; border:1px solid var(--line);
      border-radius:10px; font:inherit; background:#fff;
    }
    .detail textarea{min-height:72px; resize:vertical}
    .detail .rowBtns{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
    .x-close{position:absolute; right:10px; top:8px; font-size:18px; color:#999; cursor:pointer;}

    .toolbar{display:flex; gap:8px; padding:8px}
    .toolbar input{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .toolbar button{padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff}

    .empty{color:var(--sub); text-align:center; padding:36px 12px}
    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff;
      padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; transition:.25s; z-index:50;}
    .toast.show{opacity:1}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTÔΩú„Çø„Çπ„ÇØ</div>
    <div class="pill" id="user-pill">loading‚Ä¶</div>
  </div>
</header>

<main>
  <div class="toolbar">
    <input id="q" placeholder="Ê§úÁ¥¢Ôºà„Çø„Ç§„Éà„É´/Ë©≥Á¥∞Ôºâ"/>
    <button id="reload">ÂÜçË™≠Ëæº</button>
  </div>

  <div id="active" class="section">
    <h3>üìù „Çø„Çπ„ÇØ</h3>
    <div id="active-list"></div>
  </div>

  <div id="completed" class="section">
    <h3>‚úÖ ÂÆå‰∫ÜÔºàÁõ¥Ëøë1ÈÄ±ÈñìÔºâ</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="empty" hidden>„Åæ„Å†„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
</main>
<div id="toast" class="toast"></div>

<script>
const LIFF_ID="2008311584-NdJqOqMn";
const LIST_API_URL="https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL="https://lumicreate.xvps.jp/webhook/webhook-action";
let gUserId=null,gAllTasks=[];
const $=s=>document.querySelector(s);
const toast=m=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1400);}
const fmtJST=i=>!i?"":new Date(i).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});
const esc=s=>String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));

function sortTasks(a){return a.slice().sort((x,y)=>y.priority-x.priority||new Date(x.created_at)-new Date(y.created_at));}
function splitTasks(all){const now=Date.now(),week=now-7*864e5,ac=[],co=[];for(const t of all){if(t.status==="completed"){const c=new Date(t.completed_at||0).getTime();if(c>week)co.push(t);}else ac.push(t);}return{ac,co};}

function cardHTML(t){
  const due=fmtJST(t.due_at),isC=t.status==="completed",act=isC?"uncomplete":"complete",lab=isC?"Êú™ÂÆå‰∫Ü":"ÂÆå‰∫Ü",cls=isC?"uncomplete":"ok";
  return `<div class="swipe-wrap" data-id="${t.id}">
    <div class="actions">
      <div class="left"><button class="btn ${cls}" data-act="${act}">${lab}</button></div>
      <div class="right">
        <button class="btn info" data-act="detail">Ë©≥Á¥∞</button>
        <button class="btn danger" data-act="delete">ÂâäÈô§</button>
      </div>
    </div>
    <div class="track ${isC?'ghost':''}">
      <div class="card">
        <div class="row">
          <div class="titleTxt">${esc(t.title)||"(ÁÑ°È°å)"}</div>
          <div class="meta">
            <span class="chip">‚òÖ${t.priority}</span>
            <span class="chip">‚è∞ ${esc(due)}</span>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

async function loadTasks(uid){
  const r=await fetch(`${LIST_API_URL}?user_id=${encodeURIComponent(uid)}`);
  const j=await r.json();
  gAllTasks=[...(j.active||[]),...(j.completed||[])];
  render();
}

async function runAction(id,act){
  const res=await fetch(ACTION_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:act,task_id:id,user_id:gUserId})});
  const j=await res.json();
  if(!res.ok||!j.ok){toast("„Ç®„É©„Éº");return;}
  toast(({"complete":"ÂÆå‰∫Ü","uncomplete":"Êú™ÂÆå‰∫Ü„Å∏Êàª„Åó","delete":"ÂâäÈô§"})[act]);
  await loadTasks(gUserId);
}

function render(){
  const {ac,co}=splitTasks(gAllTasks);
  $("#active-list").innerHTML=sortTasks(ac).map(cardHTML).join("");
  $("#completed-list").innerHTML=sortTasks(co).map(cardHTML).join("");
  document.querySelectorAll(".btn[data-act]").forEach(b=>{
    b.onclick=async()=>{const w=b.closest(".swipe-wrap");await runAction(w.dataset.id,b.dataset.act);}
  });
}

async function bootstrap(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn())liff.login();
  const p=await liff.getProfile();
  gUserId=p.userId;$("#user-pill").textContent="You: "+gUserId.slice(-6);
  $("#reload").onclick=()=>loadTasks(gUserId);
  await loadTasks(gUserId);
}
bootstrap();
</script>
</body>
</html>
