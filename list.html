<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LISTï½œã‚¿ã‚¹ã‚¯</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    header{ position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--line); z-index:10 }
    .bar{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px }
    .title{ font-weight:650; letter-spacing:.2px }
    .pill{ padding:6px 10px; border-radius:999px; background:var(--pill); font-size:12px }

    main{ padding:14px; max-width:720px; margin:0 auto }
    .section{ margin:18px 0 }
    .section h3{ margin:8px 6px 10px; font-size:13px; color:var(--sub); font-weight:600 }

    .card{
      position:relative; background:var(--card); border:1px solid var(--line);
      border-radius:16px; margin:10px 0; box-shadow:0 1px 0 rgba(0,0,0,.03);
      overflow:hidden;
    }
    .row{ display:flex; align-items:center; gap:8px; padding:12px 14px; }
    .titleTxt{ flex:1; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .pin{ font-size:12px; color:var(--accent) }
    .meta{ display:flex; gap:8px; color:var(--sub); font-size:12px }
    .pillDue{ padding:2px 8px; border-radius:999px; border:1px solid var(--line) }
    .ghost{ opacity:.45 }

    .swipe-wrap{ position:relative; overflow:hidden }
    .track{ position:relative; touch-action:pan-y; background:var(--card) }
    .actions{
      position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center;
      padding:0 8px; pointer-events:none;
    }
    .btn{ pointer-events:auto; padding:8px 10px; border-radius:10px; border:1px solid var(--line);
      background:#fff; font-size:12px; }
    .btn.ok{ color:var(--ok); background:#ecfdf5; border-color:#c7ecd1 }
    .btn.warn{ color:var(--warn); background:#fffbeb; border-color:#fde68a }
    .btn.danger{ color:var(--danger); background:#fef2f2; border-color:#fecaca }

    .panel{
      padding:12px 14px; border-top:1px dashed var(--line); background:#fff; display:none; position:relative;
    }
    .panel.open{ display:block }
    .panel .close{
      position:absolute; right:10px; top:8px; width:28px; height:28px; border-radius:50%;
      border:1px solid var(--line); background:#fff; font-weight:700; cursor:pointer;
    }
    .grid{ display:grid; grid-template-columns:120px 1fr; gap:10px; align-items:center; margin:8px 0 }
    .grid label{ color:var(--sub); font-size:13px }
    input[type="text"],textarea,input[type="datetime-local"],select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font:inherit;
    }
    textarea{ min-height:84px; resize:vertical }
    .panelBtns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .b{ padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer }
    .b.primary{ background:#111; color:#fff; border-color:#111 }
    .b.ok{ color:var(--ok); background:#ecfdf5; border-color:#c7ecd1 }
    .b.warn{ color:var(--warn); background:#fffbeb; border-color:#fde68a }
    .b.danger{ color:var(--danger); background:#fef2f2; border-color:#fecaca }

    .empty{ color:var(--sub); text-align:center; padding:36px 12px }
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; transition:.25s }
    .toast.show{ opacity:1 }

    .snapHint{ position:absolute; top:50%; transform:translateY(-50%); width:120px; text-align:center; font-size:11px; color:#888; opacity:0; transition:.2s }
    .snapHint.left{ left:8px } .snapHint.right{ right:8px }
    .showHint .snapHint{ opacity:.9 }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
      <div class="pill" id="user-pill">loadingâ€¦</div>
    </div>
  </header>

  <main>
    <div id="active" class="section">
      <h3>ğŸ“ æœªå®Œäº†</h3>
      <div id="active-list"></div>
    </div>

    <div id="completed" class="section" hidden>
      <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
      <div id="completed-list"></div>
    </div>

    <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
    <pre id="debug" style="white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;border-radius:8px"></pre>
  </main>

  <div id="toast" class="toast"></div>

<script>
/** ====== è¨­å®šï¼ˆå·®ã—æ›¿ãˆï¼‰ ====== */
const LIFF_ID        = "2008311584-NdJqOqMn";
const LIST_API_URL   = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";
/** ================================= */

let gUserId = null;
let gAllTasks = [];

const el = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const $activeList = el('#active-list');
const $completedList = el('#completed-list');
const $completed = el('#completed');
const $empty = el('#empty');

function toast(m){ const t=el('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
function dbg(...a){ const d=el('#debug'); d.textContent+=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')+'\n'; d.scrollTop=d.scrollHeight; }

const JST = 'Asia/Tokyo';
const fmtJST = iso => iso? new Date(iso).toLocaleString('ja-JP',{timeZone:JST,month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}):'';
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]) )}
function toLocalInputValue(iso){ if(!iso) return ''; const d=new Date(iso); const z = new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,16); }
function toUTCFromLocalInput(val){ if(!val) return null; const d=new Date(val); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); }

/** ä½œæˆæ—¥ã®24:00(JST) ã‚’è¿”ã™ã€‚æ—¢å®šã¯ 23:59 ã«ä¸¸ã‚ã‚‹ */
function defaultDueFromCreatedAt(created_at){
  const d = created_at? new Date(created_at) : new Date();
  // JSTã®æ—¥ä»˜ã§ 23:59 ã‚’ä½œã‚‹
  const y = new Intl.DateTimeFormat('ja-JP',{timeZone:JST,year:'numeric'}).format(d);
  const m = new Intl.DateTimeFormat('ja-JP',{timeZone:JST,month:'2-digit'}).format(d);
  const day = new Intl.DateTimeFormat('ja-JP',{timeZone:JST,day:'2-digit'}).format(d);
  // ãƒ­ãƒ¼ã‚«ãƒ«å…¥åŠ›å€¤ï¼ˆdatetime-localï¼‰ã«åˆã‚ã›ã‚‹ãŸã‚ã® yyyy-mm-ddTHH:MM
  const localStr = `${y}-${m}-${day}T23:59`;
  return localStr;
}
/** due(ãƒ­ãƒ¼ã‚«ãƒ«) ã®2æ™‚é–“å‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å…¥åŠ›å€¤ï¼‰ */
function defaultRemindLocal(dueLocalStr){
  if(!dueLocalStr) return '';
  const d = new Date(dueLocalStr);
  const twoH = new Date(d.getTime() - 2*3600*1000);
  const z = new Date(twoH.getTime() - twoH.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,16);
}

function sortTasks(arr){
  return arr.slice().sort((a,b)=>{
    const ad = new Date(a.due_at || 0).getTime();
    const bd = new Date(b.due_at || 0).getTime();
    if (ad !== bd) return ad - bd;
    const ap = Number.isFinite(a.priority) ? a.priority : -1;
    const bp = Number.isFinite(b.priority) ? b.priority : -1;
    return bp - ap;
  });
}
function splitByStatus(all){
  const now = Date.now(), weekAgo = now - 7*24*3600*1000;
  const active=[], completed=[];
  for(const t of all){
    if (t.status === 'completed'){
      const cAt = t.completed_at ? new Date(t.completed_at).getTime() : 0;
      if (cAt >= weekAgo) completed.push(t);
      continue;
    }
    if (t.status==='deleted' || t.status==='archived') continue;
    active.push(t);
  }
  return { active, completed };
}

async function runAction(action, extra={}){
  const body = { action, user_id:gUserId, ...extra };
  const res = await fetch(ACTION_API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
  const j = await res.json().catch(()=>({ok:false}));
  if(!res.ok || j.ok===false) throw new Error(j.message || 'action failed');
  return j;
}

async function loadTasks(){
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(gUserId)}`;
  const res = await fetch(url,{ headers:{'Content-Type':'application/json'} });
  const payload = await res.json();
  if(!payload?.ok){ toast('èª­ã¿è¾¼ã¿å¤±æ•—'); return; }
  const { pinned=[], active=[], completed=[] } = payload;
  gAllTasks = [...pinned, ...active, ...completed];
  render();
}

/** ==== æç”» ==== */
function cardHTML(t){
  const dueTxt = fmtJST(t.due_at);
  const pin = t.pinned ? '<span class="pin">ğŸ“Œ</span>' : '';
  const ghost = t.status === 'completed' ? ' ghost' : '';
  const id = t.id;

  // å…¥åŠ›åˆæœŸå€¤ï¼šå„ªå…ˆåº¦(1ã€œ3), ã‚³ãƒ¡ãƒ³ãƒˆ, æœŸé™(ä½œæˆæ—¥24:00 JST), ãƒªãƒã‚¤ãƒ³ãƒ‰(æœŸé™-2h)
  const initPriority = (t.priority ?? 1);
  const priorityClamped = Math.min(3, Math.max(1, initPriority));
  const localDueForInput = toLocalInputValue(t.due_at) || defaultDueFromCreatedAt(t.created_at);
  const localRemForInput =
    (t.remind_times?.[0] ? toLocalInputValue(t.remind_times[0]) : defaultRemindLocal(localDueForInput));

  return `
  <div class="card${ghost}" data-id="${id}">
    <div class="swipe-wrap">
      <div class="actions">
        <div class="snapHint left">æ“ä½œ</div>
        <div class="snapHint right">æ“ä½œ</div>
        <div style="display:flex;gap:6px">
          <button class="btn ok" data-act="complete">å®Œäº†</button>
          <button class="btn warn" data-act="remind">ï¾˜ï¾ï½²ï¾ï¾„ï¾</button>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn" data-act="pin">${t.pinned?'ãƒ”ãƒ³è§£é™¤':'ãƒ”ãƒ³'}</button>
          <button class="btn" data-act="detail">è©³ç´°</button>
          <button class="btn danger" data-act="delete">å‰Šé™¤</button>
        </div>
      </div>
      <div class="track">
        <div class="row titleRow">
          <div class="titleTxt">${pin}${escapeHTML(t.title||'(ç„¡é¡Œ)')}</div>
          <div class="meta"><span class="pillDue">â° ${escapeHTML(dueTxt)}</span>${Number.isFinite(t.priority)?`<span class="pillDue">â˜…${t.priority}</span>`:''}</div>
        </div>
      </div>
    </div>

    <div class="panel" id="p-${id}">
      <button class="close" title="é–‰ã˜ã‚‹" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      <div class="grid"><label>ã‚³ãƒ¡ãƒ³ãƒˆ</label><textarea data-f="detail" placeholder="ãƒ¡ãƒ¢">${escapeHTML(t.detail||'')}</textarea></div>
      <div class="grid">
        <label>å„ªå…ˆåº¦</label>
        <select data-f="priority">
          <option value="1" ${priorityClamped===1?'selected':''}>1</option>
          <option value="2" ${priorityClamped===2?'selected':''}>2</option>
          <option value="3" ${priorityClamped===3?'selected':''}>3</option>
        </select>
      </div>
      <div class="grid"><label>æœŸé™</label><input type="datetime-local" data-f="due_at" value="${localDueForInput}"/></div>
      <div class="grid"><label>ãƒªãƒã‚¤ãƒ³ãƒ‰</label><input type="datetime-local" data-f="remind_at" value="${localRemForInput}"/></div>

      <div class="panelBtns">
        <button class="b primary" data-save>ä¿å­˜</button>
        <button class="b ok" data-complete ${t.status==='completed'?'disabled':''}>å®Œäº†</button>
        <button class="b warn" data-uncomplete ${t.status!=='completed'?'disabled':''}>å®Œäº†å–æ¶ˆã—</button>
        <button class="b" data-togglepin>${t.pinned?'ãƒ”ãƒ³è§£é™¤':'ãƒ”ãƒ³ç•™ã‚'}</button>
        <button class="b danger" data-delete>å‰Šé™¤</button>
      </div>
      <div class="meta">ä½œæˆ: ${fmtJST(t.created_at)} / æ›´æ–°: ${fmtJST(t.updated_at)}${t.completed_at?` / å®Œäº†: ${fmtJST(t.completed_at)}`:''}</div>
    </div>
  </div>`;
}

function render(){
  const {active, completed} = splitByStatus(gAllTasks);
  const actSorted = sortTasks(active);
  const compSorted = sortTasks(completed);

  $activeList.innerHTML    = actSorted.map(cardHTML).join('');
  $completedList.innerHTML = compSorted.map(cardHTML).join('');
  $completed.hidden = compSorted.length === 0;
  $empty.hidden     = actSorted.length > 0;

  // ã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚¯ãƒªãƒƒã‚¯ï¼š1ã¤ã ã‘é–‹ã
  $$('.card .titleRow').forEach(row=>{
    row.addEventListener('click', ()=>{
      const card = row.closest('.card');
      const id   = card.dataset.id;
      // ã™ã¹ã¦é–‰ã˜ã‚‹ â†’ å¯¾è±¡ã ã‘é–‹ã
      $$('.panel.open').forEach(p=>p.classList.remove('open'));
      el(`#p-${CSS.escape(id)}`)?.classList.add('open');
    });
  });

  // âœ•ã§é–‰ã˜ã‚‹
  $$('.panel .close').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      btn.closest('.panel')?.classList.remove('open');
    });
  });

  // ãƒ‘ãƒãƒ«å†…ãƒœã‚¿ãƒ³
  $$('.panel').forEach(p=>{
    const card = p.closest('.card'); const id = card.dataset.id;
    p.querySelector('[data-save]')?.addEventListener('click', ()=>saveCard(id,p));
    p.querySelector('[data-complete]')?.addEventListener('click', ()=>completeCard(id));
    p.querySelector('[data-uncomplete]')?.addEventListener('click', ()=>uncompleteCard(id));
    p.querySelector('[data-togglepin]')?.addEventListener('click', ()=>togglePin(id,p));
    p.querySelector('[data-delete]')?.addEventListener('click', ()=>deleteCard(id));
  });

  // ã‚¹ãƒ¯ã‚¤ãƒ—
  $$('.swipe-wrap .track').forEach(bindSwipe);
}

/** ==== ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆã‚¹ãƒŠãƒƒãƒ—ï¼‹å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰ ==== */
const SW_SNAP_L = 90;
const SW_SNAP_R = -90;
const SW_STRONG_V = 0.8;
const SW_STRONG_X = 140;

function bindSwipe(track){
  const wrap = track.closest('.swipe-wrap');
  const actions = wrap.querySelector('.actions');
  const card = track.closest('.card');
  let sx=0, dx=0, active=false, lastT=0, lastX=0, velocity=0;

  const setX = (x)=>{ track.style.transform=`translateX(${x}px)`; actions.style.opacity=Math.min(1,Math.abs(x)/80); };

  const onStart = (x)=>{
    active=true; sx=x; dx=0; lastX=x; lastT=performance.now();
    track.style.transition='none';
    card.classList.add('showHint');
  };
  const onMove = (x)=>{
    if(!active) return;
    const now=performance.now();
    dx = x - sx;
    velocity = (x - lastX) / Math.max(1, (now - lastT));
    lastX=x; lastT=now;
    setX(dx);
  };
  const onEnd = async ()=>{
    card.classList.remove('showHint');
    track.style.transition='transform .18s ease';
    const absX = Math.abs(dx);
    const fast = (Math.abs(velocity) >= SW_STRONG_V) && (absX >= SW_STRONG_X);

    // å¼·ã„ã‚¹ãƒ¯ã‚¤ãƒ—ã§å³å®Ÿè¡Œ
    if (fast){
      const id = card.dataset.id;
      if (dx > 0){
        try{ await runAction('complete',{ task_id:id }); toast('å®Œäº†ã—ã¾ã—ãŸ'); await loadTasks(); }catch{ toast('å¤±æ•—'); }
      }else{
        if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ setX(0); dx=0; return; }
        try{ await runAction('delete',{ task_id:id }); toast('å‰Šé™¤ã—ã¾ã—ãŸ'); await loadTasks(); }catch{ toast('å¤±æ•—'); }
      }
      return;
    }

    // ã‚¹ãƒŠãƒƒãƒ—ï¼šãƒœã‚¿ãƒ³æ“ä½œ
    if (dx > 0 && dx >= SW_SNAP_L){ setX(SW_SNAP_L); }
    else if (dx < 0 && dx <= SW_SNAP_R){ setX(SW_SNAP_R); }
    else { setX(0); dx=0; return; }

    // ãƒœã‚¿ãƒ³ã«ãƒãƒ³ãƒ‰ãƒ©ï¼ˆä½•åº¦ã§ã‚‚æŠ¼ã›ã‚‹ï¼‰
    wrap.querySelectorAll('.btn').forEach(b=>{
      if (b.dataset.binded) return;
      b.dataset.binded = '1';
      b.addEventListener('click', async (e)=>{
        const id = card.dataset.id;
        const act = e.currentTarget.dataset.act;
        try{
          if (act === 'detail'){ // ã‚¿ãƒƒãƒ—ã§ãƒ‘ãƒãƒ«é–‹é–‰ï¼ˆ1ã¤ã ã‘é–‹ãï¼‰
            $$('.panel.open').forEach(p=>p.classList.remove('open'));
            el(`#p-${CSS.escape(id)}`)?.classList.add('open');
            return;
          }
          if (act === 'delete'){
            if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          }
          if (act === 'pin'){
            const pan = el(`#p-${CSS.escape(id)}`);
            // ãƒ‘ãƒãƒ«ç„¡ãã¦ã‚‚ãƒˆã‚°ãƒ«OK
            const newPin = !gAllTasks.find(x=>x.id===id)?.pinned;
            await runAction('pin', { task_id:id, pinned:newPin });
            toast(newPin?'ãƒ”ãƒ³ç•™ã‚ã—ã¾ã—ãŸ':'ãƒ”ãƒ³è§£é™¤ã—ã¾ã—ãŸ');
            await loadTasks();
            return;
          }
          await runAction(act, { task_id:id });
          toast(act==='complete'?'å®Œäº†ã—ã¾ã—ãŸ':'å®Ÿè¡Œã—ã¾ã—ãŸ');
          await loadTasks();
        }catch(err){ console.error(err); toast('å¤±æ•—ã—ã¾ã—ãŸ'); }
      });
    });

    // 2ç§’å¾Œã«è‡ªå‹•ã§æˆ»ã™
    setTimeout(()=>{ track.style.transition='transform .18s ease'; setX(0); dx=0; }, 2000);
  };

  const startEv = (e)=> onStart(e.touches? e.touches[0].clientX : e.clientX);
  const moveEv  = (e)=> onMove(e.touches? e.touches[0].clientX : e.clientX);
  const endEv   = ()=> onEnd();

  track.addEventListener('touchstart', startEv, {passive:true});
  track.addEventListener('touchmove',  moveEv,  {passive:true});
  track.addEventListener('touchend',   endEv);
  track.addEventListener('mousedown',  startEv);
  track.addEventListener('mousemove',  (e)=>{ if(e.buttons===1) moveEv(e); });
  track.addEventListener('mouseup',    endEv);
}

/** ==== ä¿å­˜ç³» ==== */
function collectPanelFields(pan){
  const get = sel => pan.querySelector(sel);
  const comment = (get('[data-f="detail"]')?.value || '').trim(); // ã‚³ãƒ¡ãƒ³ãƒˆ
  const priority = Number(get('[data-f="priority"]')?.value || 1);
  const dueLocal = get('[data-f="due_at"]')?.value || '';          // ãƒ­ãƒ¼ã‚«ãƒ«
  const remLocal = get('[data-f="remind_at"]')?.value || '';       // ãƒ­ãƒ¼ã‚«ãƒ«

  const fields = {
    detail: comment,
    priority: Math.min(3, Math.max(1, priority)),
    due_at: dueLocal ? toUTCFromLocalInput(dueLocal) : null,
    remind_times: remLocal ? [ toUTCFromLocalInput(remLocal) ] : [],
  };
  return fields;
}

async function saveCard(id, pan){
  try{
    const fields = collectPanelFields(pan);
    // due_at ãŒç©ºãªã‚‰æ—¢å­˜ç¶­æŒï¼ˆã¾ãŸã¯ä½œæˆæ—¥24:00ã‚’æ¡ç”¨ï¼‰
    if (!fields.due_at){
      const t = gAllTasks.find(x=>x.id===id);
      if (t?.due_at) fields.due_at = t.due_at;
      else fields.due_at = toUTCFromLocalInput(defaultDueFromCreatedAt(t?.created_at));
    }
    // ãƒªãƒã‚¤ãƒ³ãƒ‰ãŒç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæœŸé™-2hï¼‰
    if (!fields.remind_times?.length){
      const localDue = toLocalInputValue(fields.due_at);
      const remLocal = defaultRemindLocal(localDue);
      if (remLocal) fields.remind_times = [ toUTCFromLocalInput(remLocal) ];
    }
    await runAction('update', { task_id:id, fields });
    toast('ä¿å­˜ã—ã¾ã—ãŸ');
    await loadTasks();
    // ç›´å‰ã®ã‚«ãƒ¼ãƒ‰ã ã‘é–‹ã„ãŸã¾ã¾ã«ã™ã‚‹
    el(`#p-${CSS.escape(id)}`)?.classList.add('open');
  }catch(e){ console.error(e); toast('ä¿å­˜å¤±æ•—'); }
}
async function completeCard(id){
  try{ await runAction('complete',{task_id:id}); toast('å®Œäº†ã—ã¾ã—ãŸ'); await loadTasks(); }
  catch{ toast('å¤±æ•—'); }
}
async function uncompleteCard(id){
  try{ await runAction('uncomplete',{task_id:id}); toast('å–æ¶ˆã—ã¾ã—ãŸ'); await loadTasks(); }
  catch{ toast('å¤±æ•—'); }
}
async function togglePin(id){
  try{
    const cur = gAllTasks.find(x=>x.id===id)?.pinned;
    const newPin = !cur;
    await runAction('pin',{ task_id:id, pinned:newPin });
    toast(newPin?'ãƒ”ãƒ³ç•™ã‚ã—ã¾ã—ãŸ':'ãƒ”ãƒ³è§£é™¤ã—ã¾ã—ãŸ');
    await loadTasks();
    el(`#p-${CSS.escape(id)}`)?.classList.add('open');
  }catch{ toast('å¤±æ•—'); }
}
async function deleteCard(id){
  if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  try{ await runAction('delete',{task_id:id}); toast('å‰Šé™¤ã—ã¾ã—ãŸ'); await loadTasks(); }
  catch{ toast('å¤±æ•—'); }
}

/** ==== èµ·å‹• ==== */
async function bootstrap(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  gUserId = prof.userId;
  el('#user-pill').textContent = 'You: ' + gUserId.slice(-6);
  await loadTasks();
}
bootstrap();
</script>
</body>
</html>
