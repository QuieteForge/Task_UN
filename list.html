<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LISTï½œã‚¿ã‚¹ã‚¯</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{--bg:#f7f7f8;--card:#fff;--ink:#111;--sub:#666;--line:#e9e9ec;--accent:#3957ff;--ok:#16a34a;--warn:#eab308;--danger:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  .bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
  .pill{font-size:12px;background:#eef2ff;border-radius:999px;padding:6px 10px}
  main{max-width:720px;margin:0 auto;padding:14px}
  h3{margin:10px 6px;font-size:13px;color:var(--sub)}
  .card{position:relative;margin:10px 0;border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
  .actions{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;padding:0 8px;pointer-events:none;opacity:0} /* åˆæœŸã¯é€ã‘ãªã„ */
  .aL,.aR{display:flex;gap:6px}
  .btn{pointer-events:auto;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-size:12px;white-space:nowrap}
  .ok{color:var(--ok);background:#ecfdf5;border-color:#c7ecd1}
  .warn{color:var(--warn);background:#fffbeb;border-color:#fde68a}
  .danger{color:var(--danger);background:#fef2f2;border-color:#fecaca}
  .track{position:relative;touch-action:pan-y;background:#fff;border-radius:16px;z-index:2}
  .row{display:flex;align-items:center;gap:8px;padding:12px 14px}
  .title{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
  .chip{padding:2px 8px;border:1px solid var(--line);border-radius:999px}
  .ghost{opacity:.45}
  .detail{display:none;border-top:1px dashed var(--line);padding:10px 12px 12px;background:#fff}
  .detail.open{display:block}
  .dHdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .close{border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer;padding:4px}
  .grid{display:grid;grid-template-columns:88px 1fr;gap:8px;align-items:center}
  input[type="text"],textarea,select,input[type="datetime-local"]{width:100%;padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
  textarea{min-height:70px;resize:vertical}
  .save{margin-top:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .empty{color:var(--sub);text-align:center;padding:36px 12px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
  .toast.show{opacity:1}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div>LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <h3>ğŸ“ æœªå®Œäº†</h3>
  <div id="active-list"></div>

  <section id="sec-completed" hidden>
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </section>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</main>

<div id="toast" class="toast"></div>

<script>
/* ===== è¨­å®šï¼ˆå·®ã—æ›¿ãˆï¼‰ ===== */
const LIFF_ID        = "2008311584-NdJqOqMn";
const LIST_API_URL   = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";
/* ============================ */

let gUserId=null, gAll=[];

const $ = s=>document.querySelector(s);
const $active = $('#active-list');
const $completed = $('#completed-list');
const $secCompleted = $('#sec-completed');
const $empty = $('#empty');

function toast(t){ const el=$('.toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1300); }
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function fmtJST(iso){ if(!iso) return ''; return new Date(iso).toLocaleString('ja-JP',{timeZone:'Asia/Tokyo',month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
function endOfTodayJST(){ const n=new Date(); const j=new Date(n.toLocaleString('en-US',{timeZone:'Asia/Tokyo'})); j.setHours(24,0,0,0); return new Date(j.getTime()-9*3600*1000).toISOString(); }
function defRem(iso){ const d=new Date(iso); return new Date(d.getTime()-2*3600*1000).toISOString(); }
function localValue(iso){ if(!iso) return ''; const d=new Date(iso); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; }
function toISO(val){ if(!val) return ''; const d=new Date(val); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); }

function split(all){
  const weekAgo=Date.now()-7*24*3600*1000, act=[], comp=[];
  all.forEach(t=>{
    if(t.status==='completed'){
      const c= t.completed_at ? new Date(t.completed_at).getTime() : 0;
      if(c>=weekAgo) comp.push(t);
    }else if(t.status!=='deleted' && t.status!=='archived'){
      act.push(t);
    }
  });
  return {act, comp};
}
function sortByRule(arr){
  return arr.slice().sort((a,b)=>{
    const ad=new Date(a.due_at||0)-0, bd=new Date(b.due_at||0)-0;
    if(ad!==bd) return ad-bd;
    const ap=Number.isFinite(a.priority)?a.priority:-1;
    const bp=Number.isFinite(b.priority)?b.priority:-1;
    return bp-ap;
  });
}

function detailHTML(t){
  const due = t.due_at || endOfTodayJST();
  const rem = (t.remind_times && t.remind_times[0]) || defRem(due);
  const pri = Number.isFinite(t.priority) ? t.priority : 1;
  return `
    <div class="detail" data-id="${t.id}">
      <div class="dHdr"><div>è©³ç´°</div><button class="close" aria-label="é–‰ã˜ã‚‹">âœ•</button></div>
      <div class="grid">
        <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
        <textarea name="detail">${esc(t.detail||'')}</textarea>

        <label>å„ªå…ˆåº¦</label>
        <select name="priority">
          <option value="1" ${pri===1?'selected':''}>1</option>
          <option value="2" ${pri===2?'selected':''}>2</option>
          <option value="3" ${pri===3?'selected':''}>3</option>
        </select>

        <label>æœŸé™</label>
        <input type="datetime-local" name="due_at" value="${localValue(due)}"/>

        <label>ãƒªãƒã‚¤ãƒ³ãƒ‰</label>
        <input type="datetime-local" name="remind" value="${localValue(rem)}"/>
      </div>
      <button class="save">ä¿å­˜</button>
    </div>`;
}

function cardHTML(t){
  const leftPrimary = (t.status==='completed')?'uncomplete':'complete';
  const leftLabel   = (t.status==='completed')?'æœªå®Œäº†':'å®Œäº†';
  return `
  <div class="card" data-id="${t.id}" data-status="${t.status}">
    <div class="actions">
      <div class="aL">
        <button class="btn ok"   data-act="${leftPrimary}">${leftLabel}</button>
        <button class="btn warn" data-act="pin">${t.pinned?'ãƒ”ãƒ³è§£é™¤':'ãƒ”ãƒ³'}</button>
      </div>
      <div class="aR">
        <button class="btn"      data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track ${t.status==='completed'?'ghost':''}">
      <div class="row">
        <div class="title">${t.pinned?'ğŸ“Œ ':''}${esc(t.title||'(ç„¡é¡Œ)')}</div>
        <div class="meta"><span class="chip">â° ${esc(fmtJST(t.due_at))}</span>${Number.isFinite(t.priority)?`<span class="chip">â˜…${t.priority}</span>`:''}</div>
      </div>
    </div>
    ${detailHTML(t)}
  </div>`;
}

function render(){
  const {act, comp} = split(gAll);
  const a = sortByRule(act), c = sortByRule(comp);
  $active.innerHTML = a.map(cardHTML).join('');
  $completed.innerHTML = c.map(cardHTML).join('');
  $secCompleted.hidden = c.length===0;
  $empty.hidden = (a.length+c.length)>0;

  document.querySelectorAll('.card').forEach(bindCard);
}

function bindCard(card){
  const id=card.dataset.id;
  const track=card.querySelector('.track'), actions=card.querySelector('.actions');
  const d=card.querySelector('.detail'), close=d.querySelector('.close'), save=d.querySelector('.save');

  // è¡Œã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒˆã‚°ãƒ«ï¼ˆ1ä»¶ã ã‘é–‹ãï¼‰
  track.addEventListener('click', ()=>{
    // ã‚¹ãƒŠãƒƒãƒ—ä¸­ã¯ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’é–‹ã‹ãªã„ï¼ˆãƒœã‚¿ãƒ³å„ªå…ˆï¼‰
    if (card.dataset.snap) return;
    document.querySelectorAll('.detail.open').forEach(x=>{ if(x!==d) x.classList.remove('open'); });
    d.classList.toggle('open');
  });
  close.addEventListener('click', (e)=>{ e.stopPropagation(); d.classList.remove('open'); });

  save.addEventListener('click', async (e)=>{
    e.stopPropagation();
    const dueISO = toISO(d.querySelector('[name="due_at"]').value) || endOfTodayJST();
    const fields = {
      detail: d.querySelector('[name="detail"]').value,
      priority: Number(d.querySelector('[name="priority"]').value),
      due_at: dueISO,
      remind_times: [ toISO(d.querySelector('[name="remind"]').value) || defRem(dueISO) ]
    };
    const ok = await postAction('update', id, fields);
    if(ok){ toast('ä¿å­˜ã—ã¾ã—ãŸ'); await load(); } else { toast('ä¿å­˜ã«å¤±æ•—'); }
  });

  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã¯ã€Œã‚¹ãƒŠãƒƒãƒ—ä¸­ã ã‘ã€æœ‰åŠ¹
  actions.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btn'); if(!btn) return;
    const snap = card.dataset.snap; if(!snap) return; // ã‚¹ãƒŠãƒƒãƒ—ã—ã¦ã„ãªã„æ™‚ã¯ç„¡è¦–
    const act = btn.dataset.act;
    if(act==='detail'){ // è©³ç´°é–‹é–‰ã¯å³
      document.querySelectorAll('.detail.open').forEach(x=>{ if(x!==d) x.classList.remove('open'); });
      d.classList.toggle('open'); reset(track, actions, card); return;
    }
    if(act==='delete'){ if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; }
    const ok = await postAction(act, id);
    if(ok){ await load(); } else { toast('å¤±æ•—ã—ã¾ã—ãŸ'); }
  });

  bindSwipe(track, actions, card);
}

function reset(track, actions, card){
  track.style.transition='transform .16s ease';
  track.style.transform='translateX(0)';
  actions.style.opacity = 0;
  delete card.dataset.snap;
}

function bindSwipe(track, actions, card){
  // ã‚¹ãƒŠãƒƒãƒ—/å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ã®é–¾å€¤
  const SW_SNAP   = 150;   // ã‚¹ãƒŠãƒƒãƒ—ä½ç½®ï¼ˆãƒœã‚¿ãƒ³ãŒã—ã£ã‹ã‚Šè¦‹ãˆã‚‹ï¼‰
  const SW_STRONG = 200;   // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢
  const VX_STRONG = 1.0;   // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—é€Ÿåº¦(px/ms)
  const HOLD_MS   = 2500;  // ã‚¹ãƒŠãƒƒãƒ—ç¶­æŒæ™‚é–“

  let sx=0, dx=0, active=false, lastX=0, lastT=0, vx=0, timer=null;

  const setX = x => {
    track.style.transform=`translateX(${x}px)`;
    actions.style.opacity=Math.min(1,Math.abs(x)/80);
  };

  const onStart = x => {
    active=true; sx=x; dx=0; lastX=x; lastT=Date.now(); vx=0;
    track.style.transition='none';
    if(timer){clearTimeout(timer); timer=null;}
  };
  const onMove = x => {
    if(!active) return;
    const now=Date.now(), dt=Math.max(1, now-lastT);
    dx = x - sx;
    vx = (x - lastX) / dt; // px/ms
    lastX = x; lastT = now;
    setX(dx);
  };
  const onEnd = async () => {
    if(!active) return; active=false;
    const absDx=Math.abs(dx), dir = dx<0 ? 'right' : (dx>0 ? 'left' : 'none');
    const absVx=Math.abs(vx);

    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆé€Ÿåº¦ or è·é›¢ï¼‰â†’ å³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    if((absVx>=VX_STRONG && absDx>=SW_SNAP) || absDx>=SW_STRONG){
      track.style.transition='transform .12s ease';
      setX(dir==='left' ? SW_STRONG : -SW_STRONG);
      // å®Ÿè¡Œï¼ˆå·¦=å®Œäº†/æœªå®Œäº†ã€å³=å‰Šé™¤ï¼‰
      if(dir==='left'){
        const act = (card.dataset.status==='completed')?'uncomplete':'complete';
        const ok = await postAction(act, card.dataset.id);
        reset(track, actions, card);
        if(ok) await load(); else toast('å¤±æ•—ã—ã¾ã—ãŸ');
      }else if(dir==='right'){
        if(confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
          const ok = await postAction('delete', card.dataset.id);
          reset(track, actions, card);
          if(ok) await load(); else toast('å¤±æ•—ã—ã¾ã—ãŸ');
        }else{
          reset(track, actions, card);
        }
      }else{
        reset(track, actions, card);
      }
      return;
    }

    // è»½ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ã‚¹ãƒŠãƒƒãƒ—ï¼ˆãƒœã‚¿ãƒ³æ“ä½œå¾…ã¡ï¼‰
    if(absDx>=SW_SNAP){
      track.style.transition='transform .16s ease';
      const snapX = dir==='left' ? SW_SNAP : -SW_SNAP;
      setX(snapX);
      card.dataset.snap = dir;              // â˜…ã‚¹ãƒŠãƒƒãƒ—çŠ¶æ…‹ãƒ•ãƒ©ã‚°
      actions.style.opacity = 1;

      timer = setTimeout(()=>{ reset(track, actions, card); }, HOLD_MS);
      return;
    }

    // æˆ»ã™
    reset(track, actions, card);
  };

  actions.addEventListener('touchstart', e=>e.stopPropagation(), {passive:true});
  actions.addEventListener('touchmove',  e=>e.stopPropagation(), {passive:true});
  actions.addEventListener('mousedown',  e=>e.stopPropagation());

  track.addEventListener('touchstart', e=>onStart(e.touches[0].clientX), {passive:true});
  track.addEventListener('touchmove',  e=>onMove(e.touches[0].clientX),  {passive:true});
  track.addEventListener('touchend', onEnd);
  track.addEventListener('mousedown', e=>onStart(e.clientX));
  track.addEventListener('mousemove', e=>{ if(e.buttons===1) onMove(e.clientX); });
  track.addEventListener('mouseup', onEnd);
}

async function postAction(action, task_id, fields){
  try{
    const body = { action, task_id, user_id:gUserId };
    if(fields) body.fields = fields;
    const res = await fetch(ACTION_API_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await res.json().catch(()=>({ok:false}));
    if(!res.ok || j.ok===false) throw new Error(j.message||'failed');
    return true;
  }catch(e){ console.error(e); return false; }
}

async function load(){
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(gUserId)}`;
  const res = await fetch(url, {headers:{'Content-Type':'application/json'}});
  const j = await res.json().catch(()=>null);
  if(!res.ok || !j || j.ok!==true){ toast('èª­ã¿è¾¼ã¿å¤±æ•—'); return; }
  const a=j.pinned||[], b=j.active||[], c=j.completed||[];
  // status ã‚’ card ã«å¼•ãæ¸¡ã™ãŸã‚ä¿æŒ
  gAll=[...a,...b,...c];
  render();
}

(async function(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  gUserId = prof.userId;
  $('#user-pill').textContent = "You: "+gUserId.slice(-6);
  await load();
})();
</script>
</body>
</html>
