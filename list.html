<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LISTÔΩú„Çø„Çπ„ÇØ</title>
<style>
:root{--bg:#f7f7f8;--card:#fff;--ink:#111;--sub:#666;--line:#e9e9ec;--accent:#3957ff;--ok:#16a34a;--warn:#eab308;--danger:#ef4444;}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
.bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
.title{font-weight:650}
main{padding:14px;max-width:720px;margin:auto}
h3{margin:10px 6px;color:var(--sub);font-size:13px}
.card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
.row{display:flex;align-items:center;gap:8px;padding:12px 14px}
.titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
.pin{color:var(--accent)}
.ghost{opacity:.45}

/* swipe */
.swipe-wrap{position:relative;overflow:hidden;border-radius:16px}
.actions{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;padding:0 8px;opacity:0;pointer-events:none;transition:opacity .15s}
.swipe-wrap.menu .actions{opacity:1;pointer-events:auto}
.swipe-wrap.menu .track{transform:translateX(-96px)}
.btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px}
.btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
.btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
.btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}
.track{position:relative;z-index:1;transition:transform .18s ease}

.empty{color:var(--sub);text-align:center;padding:36px 12px}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
.toast.show{opacity:1}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header><div class="bar"><div class="title">LISTÔΩú„Çø„Çπ„ÇØ</div><div id="user-pill">loading‚Ä¶</div></div></header>
<main>
<section id="active"><h3>üìù Êú™ÂÆå‰∫Ü</h3><div id="active-list"></div></section>
<section id="completed" hidden><h3>‚úÖ ÂÆå‰∫Ü</h3><div id="completed-list"></div></section>
<div id="empty" class="empty" hidden>„Åæ„Å†„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
</main>
<div id="toast" class="toast"></div>

<script>
const LIFF_ID="2008311584-NdJqOqMn";
const LIST_API_URL="https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL="https://lumicreate.xvps.jp/webhook/webhook-action";
let gUserId=null,gAll=[];

const $=s=>document.querySelector(s);
function toast(m){const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1500);}
function esc(s){return (s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));}
function fmt(iso){if(!iso)return"";const d=new Date(iso);return d.toLocaleString("ja-JP",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});}
function cardHTML(t){
 const left=t.status==="completed"?
 `<button class='btn ok' data-act='uncomplete'>ÂèñÊ∂à</button>`:`<button class='btn ok' data-act='complete'>ÂÆå‰∫Ü</button>`;
 return `
 <div class="swipe-wrap card${t.status==="completed"?" ghost":""}" data-id="${t.id}" data-status="${t.status||'active'}">
  <div class="actions">
   <div>${left}</div>
   <div><button class='btn' data-act='pin'>„Éî„É≥</button><button class='btn danger' data-act='delete'>ÂâäÈô§</button></div>
  </div>
  <div class="track"><div class="row">
   <div class="titleTxt">${t.pinned?"üìå":""}${esc(t.title||"(ÁÑ°È°å)")}</div>
   <div class="meta">${fmt(t.due_at)}</div>
  </div></div>
 </div>`;
}
function render(){
 const active=gAll.filter(t=>t.status!=="completed"&&t.status!=="deleted");
 const completed=gAll.filter(t=>t.status==="completed");
 $("#active-list").innerHTML=active.map(cardHTML).join("");
 $("#completed-list").innerHTML=completed.map(cardHTML).join("");
 $("#completed").hidden=completed.length===0;
 $("#empty").hidden=gAll.length>0;
 document.querySelectorAll(".track").forEach(bindSwipe);
}
async function load(){
 const res=await fetch(`${LIST_API_URL}?user_id=${gUserId}`);const j=await res.json();
 gAll=j.data||[...(j.active||[]),...(j.completed||[])];render();
}
async function runAction(id,act){
 if(act==="delete"&&!confirm("„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü"))return;
 const body={action:act,task_id:id,user_id:gUserId};
 const res=await fetch(ACTION_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
 const j=await res.json().catch(()=>({ok:false}));
 if(!res.ok||!j.ok){toast("Â§±Êïó");return;}
 toast(act==="uncomplete"?"ÂÆå‰∫ÜÂèñÊ∂à":"ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü");
 await load();
}
function bindSwipe(track){
 const wrap=track.parentElement,actions=wrap.querySelector(".actions");
 const SW_MENU=36,SW_ACTION=140;let sx=0,dx=0,active=false;
 const isOpen=()=>wrap.classList.contains("menu");
 const open=()=>{closeAll();wrap.classList.add("menu");actions.style.opacity=1;};
 const close=()=>{wrap.classList.remove("menu");actions.style.opacity=0;track.style.transform="translateX(0)";};
 function closeAll(){document.querySelectorAll(".swipe-wrap.menu").forEach(w=>{w.classList.remove("menu");w.querySelector(".track").style.transform="translateX(0)";w.querySelector(".actions").style.opacity=0;});}
 const start=x=>{active=true;sx=x;dx=0;track.style.transition="none";};
 const move=x=>{if(!active)return;dx=x-sx;if(isOpen()){if(dx>16)close();return;}track.style.transform=`translateX(${dx}px)`;actions.style.opacity=Math.min(1,Math.abs(dx)/80);};
 const end=async()=>{track.style.transition="transform .18s ease";if(isOpen()){if(Math.abs(dx)<12)close();active=false;dx=0;return;}
 let act=null;if(dx<=-SW_ACTION)act="delete";else if(dx>=SW_ACTION)act=(wrap.dataset.status==="completed")?"uncomplete":"complete";else if(dx<=-SW_MENU)open();
 if(!isOpen()){track.style.transform="translateX(0)";actions.style.opacity=0;}
 if(!act){active=false;return;}await runAction(wrap.dataset.id,act);active=false;dx=0;};
 wrap.querySelectorAll(".btn").forEach(b=>b.onclick=()=>runAction(wrap.dataset.id,b.dataset.act));
 track.addEventListener("touchstart",e=>start(e.touches[0].clientX),{passive:true});
 track.addEventListener("touchmove",e=>move(e.touches[0].clientX),{passive:true});
 track.addEventListener("touchend",end);
 track.addEventListener("mousedown",e=>start(e.clientX));
 track.addEventListener("mousemove",e=>{if(e.buttons===1)move(e.clientX);});
 track.addEventListener("mouseup",end);
 document.addEventListener("click",e=>{if(!wrap.contains(e.target))closeAll();});
}

(async()=>{
 await liff.init({liffId:LIFF_ID});
 if(!liff.isLoggedIn())liff.login();
 const prof=await liff.getProfile();gUserId=prof.userId;
 $("#user-pill").textContent="ID:"+gUserId.slice(-5);
 await load();
})();
</script>
</body>
</html>
