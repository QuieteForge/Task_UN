<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LISTï½œã‚¿ã‚¹ã‚¯</title>
<style>
  :root{
    --bg:#f7f7f8;--card:#fff;--ink:#111;--sub:#666;--line:#e9e9ec;
    --pill:#eef2ff;--accent:#3957ff;--ok:#16a34a;--warn:#eab308;--danger:#ef4444;
    --shadow:0 1px 0 rgba(0,0,0,.03);
    --snap:120px; /* â† è»½ã‚¹ãƒ¯ã‚¤ãƒ—ã®ã‚¹ãƒŠãƒƒãƒ—è·é›¢ï¼ˆä¸¡å´å…±é€šï¼‰ */
    --reveal:140px; /* ãƒœã‚¿ãƒ³å…¨ä½“ãŒè¦‹ãˆã‚‹è·é›¢ï¼ˆç›®å®‰ï¼‰ */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px 16px}
  .title{font-weight:650;letter-spacing:.2px}
  .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px}
  main{padding:14px;max-width:740px;margin:0 auto}
  .toolbar{display:flex;gap:8px;padding:8px}
  .toolbar input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .toolbar button{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}
  .section{margin:18px 0}
  .section h3{margin:8px 6px 10px;font-size:13px;color:var(--sub);font-weight:600}

  /* ã‚«ãƒ¼ãƒ‰ */
  .swipe-wrap{position:relative;border-radius:16px;overflow:visible;margin:10px 0}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:16px;padding:0;box-shadow:var(--shadow);
  }
  .track{
    position:relative;background:#fff;border-radius:16px;
    transform:translateX(0);transition:transform .18s ease, box-shadow .18s ease;
    touch-action:pan-y; will-change: transform;
  }
  .row{display:flex;align-items:center;gap:8px;padding:12px 14px}
  .titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
  .due{padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
  .pin{font-size:12px;color:var(--accent)}
  .ghost{opacity:.45}

  /* èƒŒé¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
  .actions{
    position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;
    padding:0 8px;pointer-events:none;opacity:0;transition:opacity .15s;
  }
  .actions.show{opacity:1}
  .side{display:flex;gap:6px}
  .btn{pointer-events:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px}
  .btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
  .btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
  .btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}

  /* è©³ç´°ãƒ“ãƒ¥ãƒ¼ */
  .detail{
    display:none;border-top:1px dashed var(--line);padding:10px 14px;background:#fff;border-radius:0 0 16px 16px
  }
  .detail.open{display:block}
  .detail .grid{display:grid;grid-template-columns:100px 1fr;gap:10px 12px;align-items:center}
  .detail input[type="datetime-local"],
  .detail select,.detail textarea{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .detail textarea{min-height:72px;resize:vertical}
  .detail .actions-line{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .close-x{
    position:absolute;right:10px;top:10px;cursor:pointer;border:1px solid var(--line);border-radius:8px;padding:2px 8px;background:#fff;font-size:12px;color:#666;
  }

  .empty{color:var(--sub);text-align:center;padding:36px 12px}
  .toast{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s
  }
  .toast.show{opacity:1}

  /* ãƒ‡ãƒãƒƒã‚° */
  #debug{white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;margin:8px;border-radius:8px}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div class="toolbar">
    <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰">
    <button id="reload">å†èª­è¾¼</button>
  </div>

  <div id="pinned" class="section" hidden>
    <h3>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</h3>
    <div id="pinned-list"></div>
  </div>

  <div id="active" class="section">
    <h3>ğŸ“ æœªå®Œäº†</h3>
    <div id="active-list"></div>
  </div>

  <div id="completed" class="section" hidden>
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<pre id="debug"></pre>
<div id="toast" class="toast"></div>

<script>
/** ========= è¨­å®š ========= */
const LIFF_ID = "2008311584-NdJqOqMn";
const LIST_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";
/** ======================= */

let gUserId = null;
let gAllTasks = [];

const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const $pinned = $("#pinned"); const $pinnedList = $("#pinned-list");
const $activeList = $("#active-list");
const $completed = $("#completed"); const $completedList = $("#completed-list");
const $empty = $("#empty");

function dbg(...a){ const el=$("#debug"); if(!el) return; el.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')+"\n"; }

function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1400); }

function fmtJST(iso){
  if(!iso) return "";
  const d = new Date(iso);
  return d.toLocaleString("ja-JP",{timeZone:"Asia/Tokyo", month:"numeric", day:"numeric", hour:"2-digit", minute:"2-digit"});
}

function sortTasks(all){
  // pinned desc, priority desc (nullã¯æœ€ä¸‹ä½), due asc (nullã¯ä¸‹), created_at asc
  return all.slice().sort((a,b)=>{
    const ap = a.pinned?1:0, bp = b.pinned?1:0;
    if (ap!==bp) return bp-ap;
    const apr = Number.isFinite(a.priority)?a.priority:-1;
    const bpr = Number.isFinite(b.priority)?b.priority:-1;
    if (apr!==bpr) return bpr-apr;
    const ad = a.due_at? new Date(a.due_at).getTime(): Number.MAX_SAFE_INTEGER;
    const bd = b.due_at? new Date(b.due_at).getTime(): Number.MAX_SAFE_INTEGER;
    if (ad!==bd) return ad-bd;
    const ac = a.created_at? new Date(a.created_at).getTime(): 0;
    const bc = b.created_at? new Date(b.created_at).getTime(): 0;
    return ac-bc;
  });
}

function splitByStatus(all){
  const now=Date.now(), weekAgo = now - 7*24*3600*1000;
  const pinned=[], active=[], completed=[];
  for(const t of all){
    if (t.status==="deleted"||t.status==="archived") continue;
    if (t.status==="completed"){
      const cAt = t.completed_at? new Date(t.completed_at).getTime():0;
      if (cAt>=weekAgo) completed.push(t);
      continue;
    }
    if (t.pinned){ pinned.push(t); continue; }
    active.push(t);
  }
  return { pinned, active, completed };
}

function cardHTML(t){
  const dueTxt = fmtJST(t.due_at);
  const pin = t.pinned ? '<span class="pin">ğŸ“Œ</span> ' : '';
  const ghost = t.status==="completed" ? " ghost" : "";
  return `
<div class="swipe-wrap card" data-id="${t.id}" data-status="${t.status||'active'}" data-pinned="${t.pinned?1:0}">
  <div class="actions">
    <div class="side left">
      <button class="btn ok" data-act="complete">${t.status==="completed" ? "å–æ¶ˆ" : "å®Œäº†"}</button>
      <button class="btn" data-act="pin">${t.pinned?"ãƒ”ãƒ³è§£é™¤":"ãƒ”ãƒ³"}</button>
    </div>
    <div class="side right">
      <button class="btn" data-act="detail">è©³ç´°</button>
      <button class="btn danger" data-act="delete">å‰Šé™¤</button>
    </div>
  </div>
  <div class="track${ghost}">
    <div class="row tap-toggle">
      <div class="titleTxt">${pin}${escapeHTML(t.title||"(ç„¡é¡Œ)")}</div>
      <div class="meta">
        ${Number.isFinite(t.priority)?`<span class="due">â˜…${t.priority}</span>`:""}
        <span class="due">â° ${escapeHTML(dueTxt)}</span>
      </div>
    </div>

    <div class="detail" hidden>
      <span class="close-x" data-act="close">âœ•</span>
      <div class="grid">
        <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
        <textarea name="detail" placeholder="ãƒ¡ãƒ¢">${escapeHTML(t.detail||"")}</textarea>

        <label>å„ªå…ˆåº¦</label>
        <select name="priority">
          ${[1,2,3].map(v=>`<option value="${v}" ${t.priority==v?"selected":""}>${v}</option>`).join("")}
        </select>

        <label>æœŸé™</label>
        <input name="due_at" type="datetime-local" value="${toLocalValue(t.due_at) || defaultTodayEndLocal()}"/>

        <label>ãƒªãƒã‚¤ãƒ³ãƒ‰</label>
        <input name="remind" type="datetime-local" value="${toLocalValue((t.remind_times||[])[0]) || defaultRemindLocal(toLocalValue(t.due_at)||defaultTodayEndLocal())}"/>
      </div>
      <div class="actions-line">
        <button class="btn" data-act="cancel-detail">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn ok" data-act="save-detail">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>`;
}

function escapeHTML(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function toLocalValue(iso){
  if(!iso) return "";
  const d = new Date(iso);
  // yyyy-MM-ddTHH:mm
  const pad = n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function defaultTodayEndLocal(){
  const d = new Date();
  d.setHours(23,59,0,0);
  return toLocalValue(d.toISOString());
}
function defaultRemindLocal(dueLocal){
  // dueLocal: "yyyy-MM-ddTHH:mm" â†’ 2æ™‚é–“å‰
  const d = new Date(dueLocal);
  d.setHours(d.getHours()-2);
  return toLocalValue(d.toISOString());
}
function localToUTCString(localValue){
  if(!localValue) return null;
  // localValueã¯ "yyyy-MM-ddTHH:mm"
  const d = new Date(localValue);
  return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString(); // UTC
}

/* -------- æç”» -------- */
function render(){
  const { pinned, active, completed } = splitByStatus(gAllTasks);
  const pinSorted = sortTasks(pinned);
  const actSorted = sortTasks(active);
  const compSorted = sortTasks(completed);

  $pinned.hidden = pinSorted.length===0;
  $completed.hidden = compSorted.length===0;
  $empty.hidden = (pinSorted.length + actSorted.length) > 0;

  $pinnedList.innerHTML = pinSorted.map(cardHTML).join("");
  $activeList.innerHTML = actSorted.map(cardHTML).join("");
  $completedList.innerHTML = compSorted.map(cardHTML).join("");

  // ãƒã‚¤ãƒ³ãƒ‰
  $$(".swipe-wrap .track").forEach(bindSwipe);
  // ã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒˆã‚°ãƒ«
  $$(".tap-toggle").forEach(row=>{
    row.addEventListener("click", (e)=>{
      const wrap = row.closest(".swipe-wrap");
      toggleDetail(wrap);
    });
  });
  // detailã®ãƒœã‚¿ãƒ³ç³»
  $$(".detail [data-act='close']").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      const wrap = btn.closest(".swipe-wrap"); closeDetail(wrap);
    });
  });
  $$(".detail [data-act='cancel-detail']").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      const wrap = btn.closest(".swipe-wrap"); closeDetail(wrap);
    });
  });
  $$(".detail [data-act='save-detail']").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const wrap = btn.closest(".swipe-wrap");
      await saveDetail(wrap);
    });
  });

  document.querySelector(".title").textContent = `LISTï½œã‚¿ã‚¹ã‚¯ï¼ˆ${gAllTasks.length}ä»¶ï¼‰`;
}

/* ------ è©³ç´°ãƒ“ãƒ¥ãƒ¼ ------ */
function toggleDetail(wrap){
  // ä»–ã‚’é–‰ã˜ã‚‹
  $$(".detail.open").forEach(d=>{
    if (d.closest(".swipe-wrap")!==wrap) d.classList.remove("open");
  });
  const det = wrap.querySelector(".detail");
  det.classList.toggle("open");
  det.hidden = !det.classList.contains("open");
}
function closeDetail(wrap){
  const det = wrap.querySelector(".detail");
  det.classList.remove("open");
  det.hidden = true;
}
async function saveDetail(wrap){
  const id = wrap.dataset.id;
  const det = wrap.querySelector(".detail");
  const detail = det.querySelector("[name='detail']").value.trim();
  const priority = parseInt(det.querySelector("[name='priority']").value,10);
  const dueLocal = det.querySelector("[name='due_at']").value;
  const remindLocal = det.querySelector("[name='remind']").value;

  const fields = {
    detail,
    priority: Number.isFinite(priority) ? priority : 1,
    due_at: localToUTCString(dueLocal),
    remind_times: remindLocal? [ localToUTCString(remindLocal) ] : [],
  };
  const ok = await postAction("update",{ task_id:id, fields });
  if (!ok) { toast("æ›´æ–°ã«å¤±æ•—"); return; }
  toast("æ›´æ–°ã—ã¾ã—ãŸ");
  closeDetail(wrap);
  await loadTasks(gUserId);
}

/* ------ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å…±é€š ------ */
function actionLabel(a){
  return ({pin:"ãƒ”ãƒ³", "toggle-pin":"ãƒ”ãƒ³", complete:"å®Œäº†", uncomplete:"å–æ¶ˆ", delete:"å‰Šé™¤", detail:"è©³ç´°"}[a]||a);
}
async function onAction(wrap, action){
  try{
    const id = wrap.dataset.id;
    const status = (wrap.dataset.status||"active");
    let payload = { task_id:id, user_id:gUserId };

    if (action==="delete"){
      if (!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    }
    if (action==="pin" || action==="toggle-pin"){
      const cur = wrap.dataset.pinned==="1";
      payload.wantPinned = !cur;
      action = "pin"; // ã‚µãƒ¼ãƒãƒ¼å´ã¯ 'pin' ãƒ–ãƒ©ãƒ³ãƒã§å—ã‘ã‚‹
    }
    if (action==="complete"){
      // å®Œäº†æ¸ˆãªã‚‰å–æ¶ˆã¸
      if (status==="completed"){ action="uncomplete"; }
    }
    const ok = await postAction(action, payload);
    if (!ok) throw new Error("failed");
    toast(actionLabel(action) + "ã—ã¾ã—ãŸ");
    await loadTasks(gUserId);
  }catch(err){
    console.error(err); toast("ã‚¨ãƒ©ãƒ¼: "+(err.message||"failed"));
  }
}
async function postAction(action, payload){
  const res = await fetch(ACTION_API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action, ...payload })
  });
  const j = await res.json().catch(()=>({ok:false}));
  return res.ok && j && j.ok!==false;
}

/* ------ ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œ ------ */
function bindSwipe(track){
  const wrap = track.closest(".swipe-wrap");
  const actions = wrap.querySelector(".actions");
  let sx=0, sy=0, dx=0, dy=0, active=false, lastX=0, lastT=0, vx=0;
  let snapped = 0; // -1:å·¦ã«ã‚¹ãƒŠãƒƒãƒ—, 0:ãªã—, 1:å³ã«ã‚¹ãƒŠãƒƒãƒ—
  const SNAP = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--snap")) || 120;
  const STRONG_DIST = 180;        // ã“ã‚Œè¶…ãˆãŸã‚‰å¼·ã‚¹ãƒ¯ã‚¤ãƒ—
  const STRONG_VEL  = 0.7;        // px/ms ãã‚‰ã„ã®æ„Ÿè¦šï¼ˆå¤§ãã„ã»ã©å¼·ã„ï¼‰
  const MAX_SHIFT = 240;          // é™ç•Œå¤‰ä½ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰

  const setX = (x)=>{
    track.style.transform = `translateX(${x}px)`;
    actions.classList.toggle("show", Math.abs(x)>30);
  };
  const snapTo = (dir)=>{ // dir: -1 å·¦, 1 å³, 0 è§£é™¤
    snapped = dir;
    if (dir===0){ setX(0); return; }
    setX(dir*SNAP);
  };
  const pointerDown = (x,y)=>{
    active=true; sx=x; sy=y; dx=0; dy=0; lastX=x; lastT=performance.now();
    track.style.transition="none";
  };
  const pointerMove = (x,y)=>{
    if(!active) return;
    dx = x - sx; dy = y - sy;
    // æ¨ªæ–¹å‘å„ªå…ˆã€ç¸¦æºã‚Œã¯ç„¡è¦–
    const nx = Math.max(-MAX_SHIFT, Math.min(MAX_SHIFT, dx));
    setX(nx);
    // é€Ÿåº¦
    const t = performance.now();
    const dt = Math.max(1, t - lastT);
    vx = (x - lastX)/dt; lastX=x; lastT=t;
  };
  const pointerUp = async ()=>{
    track.style.transition = "transform .18s ease";
    const abs = Math.abs(dx);
    const dir = dx>0 ? 1 : (dx<0 ? -1 : 0);
    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šï¼ˆè·é›¢ or é€Ÿåº¦ï¼‰
    if (abs>STRONG_DIST || Math.abs(vx)>STRONG_VEL){
      setX(0);
      if (dir>0){
        // å³å¼·ï¼šå®Œäº† or å–æ¶ˆ
        await onAction(wrap,"complete");
      }else if (dir<0){
        // å·¦å¼·ï¼šå‰Šé™¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰
        await onAction(wrap,"delete");
      }
      return;
    }
    // è»½ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ã‚¹ãƒŠãƒƒãƒ—å›ºå®šï¼ˆãƒœã‚¿ãƒ³æ“ä½œå¯èƒ½ï¼‰
    if (abs>60){
      snapTo(dir); // Â±SNAPã¸å›ºå®š
      // ãƒœã‚¿ãƒ³ã«ãƒãƒ³ãƒ‰ãƒ©
      wireActionButtons(wrap);
      // ãƒˆãƒ©ãƒƒã‚¯ã‚’ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
      const closer = (e)=>{
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯é–‰ã˜ãªã„
        if (e.target.closest(".btn")) return;
        snapTo(0);
        track.removeEventListener("click", closer);
      };
      track.addEventListener("click", closer);
    }else{
      snapTo(0);
    }
    active=false; dx=0; dy=0; vx=0;
  };

  const onTouchStart = (e)=>pointerDown(e.touches[0].clientX, e.touches[0].clientY);
  const onTouchMove  = (e)=>pointerMove(e.touches[0].clientX, e.touches[0].clientY);
  const onTouchEnd   = (e)=>pointerUp();
  const onMouseDown  = (e)=>{ if(e.button!==0) return; pointerDown(e.clientX, e.clientY); };
  const onMouseMove  = (e)=>{ if(e.buttons!==1) return; pointerMove(e.clientX, e.clientY); };
  const onMouseUp    = (e)=>pointerUp();

  track.addEventListener("touchstart", onTouchStart, {passive:true});
  track.addEventListener("touchmove", onTouchMove, {passive:true});
  track.addEventListener("touchend", onTouchEnd);
  track.addEventListener("mousedown", onMouseDown);
  track.addEventListener("mousemove", onMouseMove);
  track.addEventListener("mouseup", onMouseUp);
}

function wireActionButtons(wrap){
  wrap.querySelectorAll(".btn").forEach(b=>{
    b.onclick = async (e)=>{
      const act = e.currentTarget.dataset.act;
      if (act==="detail"){ toggleDetail(wrap); return; }
      if (act==="close"){ closeDetail(wrap); return; }
      if (act==="save-detail"){ await saveDetail(wrap); return; }
      await onAction(wrap, act);
    };
  });
}

/* ------ ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ ------ */
async function loadTasks(userId){
  if(!userId){
    const prof = await liff.getProfile(); userId = prof.userId; gUserId=userId;
  }
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
  let res, payload;
  try{
    res = await fetch(url,{ method:"GET", credentials:"omit", headers:{ "Content-Type":"application/json" }});
    payload = await res.json();
  }catch(e){
    dbg("fetch/json error:", e.message||e); toast("èª­ã¿è¾¼ã¿å¤±æ•—"); return;
  }
  if(!res.ok || !payload || payload.ok!==true){ toast("èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆHTTP "+res.status+"ï¼‰"); return; }
  const pinned = Array.isArray(payload.pinned)?payload.pinned:[];
  const active = Array.isArray(payload.active)?payload.active:[];
  const completed = Array.isArray(payload.completed)?payload.completed:[];
  gAllTasks = [...pinned, ...active, ...completed];
  render();
}

/* ------ èµ·å‹• ------ */
async function bootstrap(){
  dbg("LIFF_ID=", LIFF_ID);
  await liff.init({ liffId: LIFF_ID });
  dbg("liff.init OK");
  if (!liff.isLoggedIn()) liff.login();
  const ctx = liff.getContext(); dbg("context", ctx);
  const prof = await liff.getProfile(); gUserId = prof.userId;
  $("#user-pill").textContent = "You: "+ gUserId.slice(-6);

  $("#reload").onclick = ()=>loadTasks(gUserId);
  $("#q").addEventListener("input",(e)=>{
    const q = e.target.value.trim().toLowerCase();
    if (!q){ render(); return; }
    const filtered = gAllTasks.filter(t=>
      (t.title||"").toLowerCase().includes(q) ||
      (t.detail||"").toLowerCase().includes(q)
    );
    const { pinned, active, completed } = splitByStatus(filtered);
    $pinned.hidden = pinned.length===0; $completed.hidden = completed.length===0; $empty.hidden = true;
    $pinnedList.innerHTML = sortTasks(pinned).map(cardHTML).join("");
    $activeList.innerHTML = sortTasks(active).map(cardHTML).join("");
    $completedList.innerHTML = sortTasks(completed).map(cardHTML).join("");
    $$(".swipe-wrap .track").forEach(bindSwipe);
  });

  await loadTasks(gUserId);
}

bootstrap();
</script>
</body>
</html>
