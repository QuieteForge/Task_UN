<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LISTï½œã‚¿ã‚¹ã‚¯</title>
  <style>
    :root{
      --bg:#f7f7f8;--card:#fff;--ink:#111;--sub:#666;--line:#e9e9ec;
      --pill:#eef2ff;--ok:#16a34a;--danger:#ef4444;
      --shadow:0 1px 0 rgba(0,0,0,.03);
      --snap:110px; /* â† ãƒœã‚¿ãƒ³ãŒã—ã£ã‹ã‚Šè¦‹ãˆã‚‹éœ²å‡ºé‡ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
    }
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px}
    .title{font-weight:650;letter-spacing:.2px}
    .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px}
    main{padding:14px;max-width:720px;margin:0 auto}
    .section{margin:18px 0}
    .section h3{margin:8px 6px 10px;font-size:13px;color:var(--sub);font-weight:600}
    .empty{color:var(--sub);text-align:center;padding:36px 12px}

    /* ã‚«ãƒ¼ãƒ‰ */
    .card{
      position:relative;background:var(--card);border:1px solid var(--line);
      border-radius:16px;margin:10px 0;box-shadow:var(--shadow)
    }
    .swipe-wrap{position:relative;overflow:hidden;border-radius:16px}

    /* åˆæœŸçŠ¶æ…‹ã¯å®Œå…¨ã«è¦‹ãˆãªã„ï¼ˆé€ã‘é˜²æ­¢ï¼‰ */
    .actions{
      position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;
      padding:0 8px;visibility:hidden; /* â† åˆæœŸã¯éè¡¨ç¤º */
      z-index:0; /* â† ä¸‹å±¤ã«é…ç½® */
      background:transparent;
    }
    /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«å°‘ã—ã§ã‚‚å‹•ã„ãŸã‚‰ã€ã¾ãŸã¯ã‚¹ãƒŠãƒƒãƒ—éœ²å‡ºæ™‚ã«ã ã‘è¡¨ç¤º */
    .swipe-wrap.peek .actions,
    .swipe-wrap.open-left .actions,
    .swipe-wrap.open-right .actions{ visibility:visible; }

    .btn{
      pointer-events:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--line);
      background:#fff;font-size:12px
    }
    .btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
    .btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}

    .track{
      position:relative;touch-action:pan-y;background:var(--card);
      -webkit-touch-callout:none;-webkit-user-select:none;user-select:none;
      z-index:1; /* â† ä¸Šã«ç½®ãã®ã§åˆæœŸã¯ãƒœã‚¿ãƒ³ãŒè¦‹ãˆãªã„ */
      will-change:transform;
    }
    .row{display:flex;align-items:center;gap:8px;padding:12px 14px}
    .titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
    .pill-sm{padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .ghost{opacity:.45}

    /* éœ²å‡ºçŠ¶æ…‹ã§ã ã‘ãƒœã‚¿ãƒ³ã‚’è§¦ã‚Œã‚‹ */
    .swipe-wrap.open-left .actions,
    .swipe-wrap.open-right .actions{ pointer-events:auto }

    /* è©³ç´°ãƒ‘ãƒãƒ« */
    .detail{border-top:1px dashed var(--line);padding:10px 14px;display:none;background:#fff;position:relative}
    .detail.open{display:block}
    .detail-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .detail-grid .full{grid-column:1 / -1}
    .detail label{font-size:12px;color:var(--sub);display:block;margin-bottom:4px}
    .detail input,.detail select,.detail textarea{
      width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit
    }
    .detail textarea{min-height:72px;resize:vertical}
    .detail-bar{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .x-close{
      position:absolute;right:10px;top:10px;border:1px solid var(--line);background:#fff;border-radius:999px;
      width:28px;height:28px;display:grid;place-items:center;font-size:14px;cursor:pointer
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div class="section" id="active">
    <h3>ğŸ“ ã‚¿ã‚¹ã‚¯</h3>
    <div id="active-list"></div>
  </div>

  <div class="section" id="completed">
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<pre id="debug" style="white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;margin:8px;border-radius:8px;"></pre>
<div id="toast" class="toast"></div>

<script>
/** =================== è¨­å®š =================== */
const LIFF_ID = "2008311584-NdJqOqMn";
const LIST_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";
/** ============================================ */

let gUserId = null;
let gAllTasks = [];
let gOpenDetailId = null;

const $ = (s)=>document.querySelector(s);
const $activeList = $("#active-list");
const $completedList = $("#completed-list");
const $empty = $("#empty");

function dbg(...a){ const el=$("#debug"); if(!el) return; el.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')+'\n'; }
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function fmtJST(iso){ if(!iso) return ""; const d=new Date(iso); return d.toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}); }
function isRecentCompleted(t){ if(!t.completed_at) return false; const wk = Date.now()-7*24*3600*1000; return new Date(t.completed_at).getTime()>=wk; }

function sortTasks(arr){
  return arr.slice().sort((a,b)=>{
    const ap = Number.isFinite(a.priority)?a.priority:0;
    const bp = Number.isFinite(b.priority)?b.priority:0;
    if (bp!==ap) return bp-ap; // priority é™é †
    const apos = Number.isFinite(a.position)?a.position:0;
    const bpos = Number.isFinite(b.position)?b.position:0;
    return apos-bpos;          // position æ˜‡é †
  });
}

function splitByStatus(all){
  const active=[], completed=[];
  for(const t of all){
    if(t.status==='completed'){
      if(isRecentCompleted(t)) completed.push(t);
    }else if(t.status!=='deleted' && t.status!=='archived'){
      active.push(t);
    }
  }
  return {active:sortTasks(active), completed:sortTasks(completed)};
}

function cardHTML(t){
  const ghost = t.status==='completed' ? ' ghost' : '';
  const dueTxt = fmtJST(t.due_at);
  const pri = Number.isFinite(t.priority)? t.priority : 0;
  const detailOpen = (gOpenDetailId===t.id) ? ' open' : '';

  return `
  <div class="swipe-wrap card${ghost}" data-id="${t.id}">
    <div class="actions">
      <div style="display:flex;gap:6px">
        <button class="btn ok" data-act="complete">å®Œäº†</button>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn" data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track">
      <div class="row">
        <div class="titleTxt">${escapeHTML(t.title||'(ç„¡é¡Œ)')}</div>
        <div class="meta">
          <span class="pill-sm">â˜…${pri}</span>
          ${dueTxt? `<span class="pill-sm">â° ${escapeHTML(dueTxt)}</span>`:''}
        </div>
      </div>
      <div class="detail${detailOpen}">
        <button class="x-close" title="é–‰ã˜ã‚‹" data-act="close">âœ•</button>
        <div class="detail-grid">
          <div class="full">
            <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¡ãƒ¢ï¼‰</label>
            <textarea data-field="detail" placeholder="ãƒ¡ãƒ¢">${escapeHTML(t.detail||'')}</textarea>
          </div>
          <div>
            <label>å„ªå…ˆåº¦</label>
            <select data-field="priority">
              ${[3,2,1,0].map(v=>`<option value="${v}" ${String(v)===String(pri)?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
          <div>
            <label>æœŸé™</label>
            <input type="datetime-local" data-field="due_at" value="${toLocalValue(t.due_at)||''}">
          </div>
          <div class="full">
            <label>ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆæœŸé™ã®2æ™‚é–“å‰ãŒæ—¢å®šï¼‰</label>
            <input type="datetime-local" data-field="remind_at" value="${toLocalValue(defaultRemind(t))||''}">
          </div>
        </div>
        <div class="detail-bar">
          <button class="btn" data-act="cancel">æˆ»ã™</button>
          <button class="btn ok" data-act="save">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>`;
}

function toLocalValue(iso){
  if(!iso) return '';
  const d = new Date(iso);
  const pad = n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function defaultRemind(t){
  if(!t?.due_at) return '';
  const d=new Date(t.due_at); d.setHours(d.getHours()-2); return d.toISOString();
}

function render(){
  const {active, completed} = splitByStatus(gAllTasks);
  $("#active-list").innerHTML = active.map(cardHTML).join('');
  $("#completed-list").innerHTML = completed.map(cardHTML).join('');
  $empty.hidden = (active.length+completed.length)>0;

  [...document.querySelectorAll(".swipe-wrap .track")].forEach(bindSwipe);
  [...document.querySelectorAll(".swipe-wrap")].forEach(bindClicks);
}

/* ========= ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ ========= */
const SW_LIGHT=36, SW_STRONG=140;
const SNAP_X = 110; // CSS ã¨åˆã‚ã›å›ºå®š

function bindSwipe(track){
  const wrap = track.closest('.swipe-wrap');

  let sx=0, dx=0, active=false, startT=0, startY=0;
  let frame=null;

  const snapTo=(x)=>{
    track.style.transition='transform .18s ease';
    track.style.transform=`translateX(${x}px)`;
    wrap.classList.toggle('open-left', x>0);
    wrap.classList.toggle('open-right', x<0);
    if (x===0){ wrap.classList.remove('open-left','open-right'); }
    setTimeout(()=>{ track.style.transition=''; }, 200);
  };

  const onStart=(x,y)=>{
    active=true; sx=x; dx=0; startT=performance.now(); startY=y;
    track.style.transition='none';
  };
  const onMove=(x,y)=>{
    if(!active) return;
    const dy = Math.abs(y-startY);
    if (dy>18){ // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆ
      wrap.classList.remove('peek');
      return;
    }
    dx = x - sx;
    // å°‘ã—ã§ã‚‚å‹•ã„ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’å¯è¦–åŒ–ï¼ˆpeekï¼‰
    if (Math.abs(dx)>8) wrap.classList.add('peek');

    let tx = dx;
    if (dx>0) tx = Math.min(dx, SW_STRONG);
    if (dx<0) tx = Math.max(dx, -SW_STRONG);

    if (frame) cancelAnimationFrame(frame);
    frame = requestAnimationFrame(()=>{ track.style.transform=`translateX(${tx}px)`; });
  };
  const onEnd=async ()=>{
    active=false;
    const dt = Math.max(1, performance.now()-startT);
    const vx = dx/dt; // px/ms

    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼šå³=å®Œäº†/å–æ¶ˆã€å·¦=å‰Šé™¤
    if (dx > SW_STRONG || vx>0.8){
      const id = wrap.dataset.id;
      const t = gAllTasks.find(x=>x.id===id);
      if (t){
        const act = (t.status==='completed') ? 'uncomplete' : 'complete';
        const ok = await runAction(id, act);
        if (ok) await loadTasks(gUserId);
      }
      snapTo(0);
      wrap.classList.remove('peek');
      return;
    }
    if (dx < -SW_STRONG || vx<-0.8){
      const id = wrap.dataset.id;
      const ok = window.confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
      if (ok){
        const ok2 = await runAction(id, 'delete');
        if (ok2) await loadTasks(gUserId);
      }
      snapTo(0);
      wrap.classList.remove('peek');
      return;
    }

    // è»½ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ã‚¹ãƒŠãƒƒãƒ—éœ²å‡º
    if (dx > SW_LIGHT){ snapTo(+SNAP_X); }
    else if (dx < -SW_LIGHT){ snapTo(-SNAP_X); }
    else { snapTo(0); }

    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã¯ peek ã‚’è§£é™¤ï¼ˆopen-* ã®ã¨ãã¯ actions ã¯è¦‹ãˆã‚‹ï¼‰
    wrap.classList.remove('peek');
  };

  // touch / mouse
  track.addEventListener('touchstart', (e)=>{ e.preventDefault(); const t=e.touches[0]; onStart(t.clientX,t.clientY); }, {passive:false});
  track.addEventListener('touchmove',  (e)=>{ e.preventDefault(); const t=e.touches[0]; onMove(t.clientX,t.clientY); }, {passive:false});
  track.addEventListener('touchend',   onEnd, {passive:true});

  track.addEventListener('mousedown', (e)=>{ onStart(e.clientX,e.clientY); });
  document.addEventListener('mousemove', (e)=>{ if(e.buttons===1) onMove(e.clientX,e.clientY); });
  document.addEventListener('mouseup', onEnd);
}

function bindClicks(wrap){
  const track = wrap.querySelector('.track');

  // è¡Œã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒˆã‚°ãƒ«ï¼ˆéœ²å‡ºä¸­ã¯é–‰ã˜ã¦ã‹ã‚‰ç„¡è¦–ï¼‰
  track.addEventListener('click', (e)=>{
    if (wrap.classList.contains('open-left') || wrap.classList.contains('open-right')){
      snapToZero(track, wrap);
      return;
    }
    const id = wrap.dataset.id;
    const detail = track.querySelector('.detail');
    if (gOpenDetailId && gOpenDetailId!==id){
      const opened = document.querySelector(`.swipe-wrap[data-id="${gOpenDetailId}"] .detail`);
      if (opened) opened.classList.remove('open');
    }
    if (detail.classList.contains('open')){
      detail.classList.remove('open'); gOpenDetailId=null;
    }else{
      detail.classList.add('open'); gOpenDetailId=id;
    }
  });

  // ãƒœã‚¿ãƒ³ç¾¤ï¼ˆactions ã¨ detail å†…ï¼‰ã®å§”ä»»
  wrap.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    const id = wrap.dataset.id;
    const track = wrap.querySelector('.track');
    const detail = track.querySelector('.detail');

    if (act==='close'){
      detail.classList.remove('open'); gOpenDetailId=null; return;
    }
    if (act==='detail'){
      if (gOpenDetailId && gOpenDetailId!==id){
        const opened = document.querySelector(`.swipe-wrap[data-id="${gOpenDetailId}"] .detail`);
        if (opened) opened.classList.remove('open');
      }
      detail.classList.add('open'); gOpenDetailId=id;
      snapToZero(track, wrap);
      return;
    }
    if (act==='delete'){
      const ok = window.confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
      if (!ok){ snapToZero(track, wrap); return; }
      const ok2 = await runAction(id,'delete');
      if (ok2) await loadTasks(gUserId);
      snapToZero(track, wrap);
      return;
    }
    if (act==='complete'){
      // å³ã‚¹ãƒ¯ã‚¤ãƒ—ã¨åŒã˜ï¼šå®Œäº† or å–æ¶ˆ
      const t = gAllTasks.find(x=>x.id===id);
      const kind = (t && t.status==='completed') ? 'uncomplete' : 'complete';
      const ok = await runAction(id, kind);
      if (ok) await loadTasks(gUserId);
      snapToZero(track, wrap);
      return;
    }
    if (act==='cancel'){
      await loadTasks(gUserId);
      return;
    }
    if (act==='save'){
      const fields = readDetailFields(detail);
      const ok = await runAction(id,'update',{fields});
      if (ok){
        toast('ä¿å­˜ã—ã¾ã—ãŸ');
        await loadTasks(gUserId);
      }else{
        toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      return;
    }
  });

  function snapToZero(track, wrap){
    track.style.transition='transform .18s ease';
    track.style.transform='translateX(0)';
    wrap.classList.remove('open-left','open-right','peek');
    setTimeout(()=>{ track.style.transition=''; },200);
  }
}

function readDetailFields(detailEl){
  const get = (sel)=> detailEl.querySelector(`[data-field="${sel}"]`);
  const toISO = (val)=> val? new Date(val).toISOString() : null;

  const detail = get('detail')?.value?.trim() || '';
  const priority = parseInt(get('priority')?.value ?? '0',10);
  const due_at = toISO(get('due_at')?.value || '');
  const remind_at = toISO(get('remind_at')?.value || '');
  const remind_times = remind_at? [remind_at] : [];

  return { detail, priority, due_at, remind_times };
}

/* ===== API ===== */
async function runAction(task_id, action, extra={}){
  try{
    const body = { action, task_id, user_id:gUserId, ...extra };
    const res = await fetch(ACTION_API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const j = await res.json().catch(()=>({ok:false}));
    if(!res.ok || j.ok===false){ throw new Error(j.message||'action failed'); }
    return true;
  }catch(err){
    console.error(err); toast('ã‚¨ãƒ©ãƒ¼: '+(err.message||'failed')); return false;
  }
}

async function loadTasks(userId){
  try{
    const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
    const res = await fetch(url,{method:'GET',headers:{'Content-Type':'application/json'}});
    const payload = await res.json();
    if(!res.ok || !payload || payload.ok!==true) throw new Error('load failed');

    const active = Array.isArray(payload.active)? payload.active : [];
    const completed = Array.isArray(payload.completed)? payload.completed : [];
    gAllTasks = [...active, ...completed];
    render();
  }catch(e){
    console.error(e); toast('èª­ã¿è¾¼ã¿å¤±æ•—');
  }
}

/* ===== åˆæœŸåŒ– ===== */
async function bootstrap(){
  dbg('LIFF_ID=', LIFF_ID);
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  gUserId = prof.userId;
  $("#user-pill").textContent = "You: " + gUserId.slice(-6);
  await loadTasks(gUserId);
}
bootstrap();
</script>
</body>
</html>
