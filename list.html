<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LISTÔΩú„Çø„Çπ„ÇØ‰∏ÄË¶ß</title>
    <style>
      :root {
        --bg: #f7f7f8;
        --card: #fff;
        --ink: #111;
        --sub: #666;
        --line: #e9e9ec;
        --pill: #eef2ff;
        --accent: #3957ff;
        --ok: #16a34a;
        --warn: #eab308;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--ink);
        font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
      }
      header {
        position: sticky;
        top: 0;
        background: var(--card);
        border-bottom: 1px solid var(--line);
        z-index: 10;
      }
      .bar {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
        padding: 12px 16px;
      }
      .title {
        font-weight: 650;
        letter-spacing: 0.2px;
      }
      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--pill);
        font-size: 12px;
      }
      main {
        padding: 14px;
        max-width: 720px;
        margin: 0 auto;
      }
      .section {
        margin: 18px 0;
      }
      .section h3 {
        margin: 8px 6px 10px;
        font-size: 13px;
        color: var(--sub);
        font-weight: 600;
      }

      .card {
        position: relative;
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 12px 14px;
        margin: 10px 0;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.03);
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .titleTxt {
        flex: 1;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .meta {
        display: flex;
        gap: 8px;
        color: var(--sub);
        font-size: 12px;
      }
      .due {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--line);
      }
      .pin {
        font-size: 12px;
        color: var(--accent);
      }

      /* swipe */
      .swipe-wrap {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
      }
      .actions {
        position: absolute;
        inset: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 8px;
        pointer-events: none;
      }
      .btn {
        pointer-events: auto;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: var(--card);
        font-size: 12px;
      }
      .btn.ok {
        border-color: #c7ecd1;
        color: var(--ok);
        background: #ecfdf5;
      }
      .btn.warn {
        border-color: #fde68a;
        color: var(--warn);
        background: #fffbeb;
      }
      .btn.danger {
        border-color: #fecaca;
        color: var(--danger);
        background: #fef2f2;
      }
      .track {
        position: relative;
        touch-action: pan-y;
        background: var(--card);
      }
      .ghost {
        opacity: 0.45;
      }

      .empty {
        color: var(--sub);
        text-align: center;
        padding: 36px 12px;
      }
      .skeleton {
        height: 60px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: linear-gradient(90deg, #f5f5f7, #eee, #f5f5f7);
        background-size: 200% 100%;
        animation: s 1.1s linear infinite;
      }
      @keyframes s {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .toolbar {
        display: flex;
        gap: 8px;
        padding: 8px;
      }
      .toolbar input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
      }
      .toolbar button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
      }
      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: #111;
        color: #fff;
        padding: 10px 14px;
        border-radius: 999px;
        font-size: 13px;
        opacity: 0;
        transition: 0.25s;
      }
      .toast.show {
        opacity: 1;
      }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  </head>
  <body>
    <header>
      <div class="bar">
        <div class="title">LISTÔΩú„Çø„Çπ„ÇØ</div>
        <div class="pill" id="user-pill">loading‚Ä¶</div>
      </div>
    </header>

    <main>
      <div class="toolbar">
        <input id="q" placeholder="Ê§úÁ¥¢Ôºà„Çø„Ç§„Éà„É´/Ë©≥Á¥∞Ôºâ" />
        <button id="reload">ÂÜçË™≠Ëæº</button>
      </div>

      <div id="pinned" class="section" hidden>
        <h3>üìå „Éî„É≥Áïô„ÇÅ</h3>
        <div id="pinned-list"></div>
      </div>

      <div id="active" class="section">
        <h3>üìù Êú™ÂÆå‰∫Ü</h3>
        <div id="active-list"></div>
      </div>

      <div id="completed" class="section" hidden>
        <h3>‚úÖ ÂÆå‰∫ÜÔºàÁõ¥Ëøë1ÈÄ±ÈñìÔºâ</h3>
        <div id="completed-list"></div>
      </div>

      <div id="empty" class="empty" hidden>
        „Åæ„Å†„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇLINE„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ„Çã„Å®ËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ
      </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
      /** =================== Ë®≠ÂÆöÔºàÂ∑Æ„ÅóÊõø„ÅàÔºâ =================== */
      const LIFF_ID = "2008311584-NdJqOqMn"; // ‚Üê „ÅÇ„Å™„Åü„ÅÆLIFF ID
      const LIST_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-list"; // ‚Üê n8n: LIST (GET) „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
      const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action"; // ‚Üê n8n: ACTION (POST) „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
      const ANON_FALLBACK = null; // Áõ¥Êé•Supabase„ÇíÂè©„ÅèÂ†¥Âêà„ÅÆ anon „Ç≠„ÉºÔºàÈÄöÂ∏∏„ÅØ null „ÅÆ„Åæ„ÅæÔºâ
      /** ======================================================== */

      let gUserId = null;
      let gAllTasks = [];

      const el = (sel) => document.querySelector(sel);
      const $pinned = el("#pinned");
      const $pinnedList = el("#pinned-list");
      const $activeList = el("#active-list");
      const $completed = el("#completed");
      const $completedList = el("#completed-list");
      const $empty = el("#empty");

      function toast(msg) {
        const t = el("#toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 1400);
      }

      function fmtJST(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return d.toLocaleString("ja-JP", {
          timeZone: "Asia/Tokyo",
          month: "numeric",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // ‰∏¶„Å≥È†ÜÔºöÊúüÈôêÊòáÈ†Ü ‚Üí ÂÑ™ÂÖàÂ∫¶ÈôçÈ†Ü
      function sortTasks(arr) {
        return arr.slice().sort((a, b) => {
          const ad = new Date(a.due_at || 0).getTime();
          const bd = new Date(b.due_at || 0).getTime();
          if (ad !== bd) return ad - bd; // ÊòáÈ†Ü
          const ap = Number.isFinite(a.priority) ? a.priority : -1;
          const bp = Number.isFinite(b.priority) ? b.priority : -1;
          return bp - ap; // ÈôçÈ†Ü
        });
      }

      function splitByStatus(all) {
        const now = Date.now();
        const weekAgo = now - 7 * 24 * 3600 * 1000;
        const pinned = [];
        const active = [];
        const completed = [];
        for (const t of all) {
          if (t.pinned) {
            pinned.push(t);
            continue;
          }
          if (t.status === "completed") {
            const cAt = t.completed_at ? new Date(t.completed_at).getTime() : 0;
            if (cAt >= weekAgo) completed.push(t);
            continue;
          }
          if (t.status === "deleted" || t.status === "archived") continue;
          active.push(t);
        }
        return { pinned: pinned.slice(0, 3), active, completed };
      }

      function render() {
        const { pinned, active, completed } = splitByStatus(gAllTasks);
        const actSorted = sortTasks(active);
        const pinSorted = sortTasks(pinned);
        const compSorted = sortTasks(completed);

        $pinned.hidden = pinSorted.length === 0;
        $completed.hidden = compSorted.length === 0;

        $pinnedList.innerHTML = pinSorted.map(cardHTML).join("");
        $activeList.innerHTML = actSorted.map(cardHTML).join("");
        $completedList.innerHTML = compSorted.map(cardHTML).join("");

        $empty.hidden = pinSorted.length + actSorted.length > 0;

        // „Çπ„ÉØ„Ç§„Éó„Çí„Éê„Ç§„É≥„Éâ
        [...document.querySelectorAll(".track")].forEach(bindSwipe);
      }

      function cardHTML(t) {
        const dueTxt = fmtJST(t.due_at);
        const pin = t.pinned ? '<span class="pin">üìå</span>' : "";
        const ghost = t.status === "completed" ? " ghost" : "";
        return `
  <div class="swipe-wrap card${ghost}" data-id="${t.id}">
    <div class="actions">
      <div style="display:flex;gap:6px">
        <button class="btn ok" data-act="complete">ÂÆå‰∫Ü</button>
        <button class="btn warn" data-act="remind">ÔæòÔæèÔΩ≤ÔæùÔæÑÔæû</button>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn" data-act="pin">${
          t.pinned ? "„Éî„É≥Ëß£Èô§" : "„Éî„É≥"
        }</button>
        <button class="btn" data-act="detail">Ë©≥Á¥∞</button>
        <button class="btn danger" data-act="delete">ÂâäÈô§</button>
      </div>
    </div>
    <div class="track">
      <div class="row">
        <div class="titleTxt">${pin}${escapeHTML(t.title || "(ÁÑ°È°å)")}</div>
        <div class="meta"><span class="due">‚è∞ ${escapeHTML(dueTxt)}</span>${
          Number.isFinite(t.priority)
            ? `<span class="due">‚òÖ${t.priority}</span>`
            : ""
        }</div>
      </div>
    </div>
  </div>`;
      }

      function escapeHTML(s) {
        return String(s || "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      function bindSwipe(track) {
        const wrap = track.parentElement; // .swipe-wrap
        const actions = wrap.querySelector(".actions");
        const SW_LIGHT = 40; // ËªΩ„Åè
        const SW_STRONG = 120; // Â§ß„Åç„Åè
        let sx = 0,
          dx = 0,
          active = false;

        const onStart = (x) => {
          active = true;
          sx = x;
          dx = 0;
          track.style.transition = "none";
        };
        const onMove = (x) => {
          if (!active) return;
          dx = x - sx;
          track.style.transform = `translateX(${dx}px)`;
          actions.style.opacity = Math.min(1, Math.abs(dx) / 80);
        };
        const onEnd = async () => {
          track.style.transition = "transform .18s ease";
          actions.style.opacity = 0;
          const id = wrap.dataset.id;
          const act =
            dx > SW_STRONG
              ? "complete"
              : dx < -SW_STRONG
              ? "delete"
              : dx > SW_LIGHT
              ? "pin"
              : dx < -SW_LIGHT
              ? "menu"
              : null;
          track.style.transform = "translateX(0)";
          dx = 0;
          active = false;
          if (!act) return;
          if (act === "menu") {
            openActionSheet(wrap);
            return;
          }
          await runAction(id, act);
        };

        track.addEventListener(
          "touchstart",
          (e) => onStart(e.touches[0].clientX),
          { passive: true }
        );
        track.addEventListener(
          "touchmove",
          (e) => onMove(e.touches[0].clientX),
          { passive: true }
        );
        track.addEventListener("touchend", onEnd);
        // „Éû„Ç¶„ÇπÂØæÂøúÔºàÈñãÁô∫ÊôÇÁî®Ôºâ
        track.addEventListener("mousedown", (e) => onStart(e.clientX));
        track.addEventListener("mousemove", (e) => {
          if (e.buttons === 1) onMove(e.clientX);
        });
        track.addEventListener("mouseup", onEnd);
      }

      function openActionSheet(wrap) {
        // ËªΩ„ÅèÂ∑¶Ôºö„É™„Éû„Ç§„É≥„Éâ/Ë©≥Á¥∞/ÂÆå‰∫ÜÔºà„É¢„Éê„Ç§„É´„ÅÆÊñáËÑà„Åß„Éú„Çø„É≥„Çí‰∏ÄÊôÇË°®Á§∫Ôºâ
        const btns = wrap.querySelectorAll(".btn");
        wrap.classList.add("highlight");
        btns.forEach((b) => {
          b.addEventListener(
            "click",
            async (e) => {
              const id = wrap.dataset.id;
              const act = e.currentTarget.dataset.act;
              await runAction(id, act);
            },
            { once: true }
          );
        });
        setTimeout(() => wrap.classList.remove("highlight"), 1200);
      }

      async function runAction(id, action) {
        try {
          if (action === "detail") {
            alert("Ë©≥Á¥∞„ÅØÂà•ÁîªÈù¢„Å∏ÈÅ∑Áßª‰∫àÂÆö\nÔºà„Åì„Åì„Åß„ÅØÁ∞°ÊòìË°®Á§∫„ÅÆ„ÅøÔºâ");
            return;
          }
          if (action === "delete") {
            const ok = confirm("„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");
            if (!ok) return;
          }
          const res = await fetch(ACTION_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, task_id: id, user_id: gUserId }),
          });
          const j = await res.json().catch(() => ({ ok: false }));
          if (!res.ok || j.ok === false) {
            throw new Error(j.message || "action failed");
          }
          toast(actionLabel(action) + "„Åó„Åæ„Åó„Åü");
          await loadTasks();
        } catch (err) {
          console.error(err);
          toast("„Ç®„É©„Éº: " + (err.message || "failed"));
        }
      }

      function actionLabel(a) {
        return (
          {
            pin: "„Éî„É≥",
            complete: "ÂÆå‰∫Ü",
            delete: "ÂâäÈô§",
            remind: "„É™„Éû„Ç§„É≥„Éâ",
            menu: "„É°„Éã„É•„Éº",
          }[a] || a
        );
      }

      async function loadTasks(userId) {
  if (!userId) {
    console.warn('loadTasks: userId is missing');
    return;
  }
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
  const res = await fetch(url, {
    method: 'GET',
    credentials: 'omit',
    headers: { 'Content-Type': 'application/json' },
  });

  let payload;
  try {
    payload = await res.json();
  } catch (e) {
    console.error('JSON parse error', e);
    toast('Ë™≠„ÅøËæº„ÅøÂ§±ÊïóÔºàJSONÔºâ');
    return;
  }

  if (!res.ok) {
    console.warn('HTTP error', res.status, payload);
    toast('Ë™≠„ÅøËæº„ÅøÂ§±ÊïóÔºàHTTP ' + res.status + 'Ôºâ');
    return;
  }

  // API„ÅÆ2„Éë„Çø„Éº„É≥„ÇíÂê∏ÂèéÔºö
  // A) {ok:true, data:[...]} ÂΩ¢Âºè
  // B) {ok:true, pinned:[...], active:[...], completed:[...]} ÂΩ¢ÂºèÔºà„ÅÇ„Å™„Åü„ÅÆÁèæÂú®„ÅÆÂøúÁ≠îÔºâ
  if (Array.isArray(payload)) {
    gAllTasks = payload;
  } else if (payload && payload.ok === true) {
    if (Array.isArray(payload.data)) {
      gAllTasks = payload.data;
    } else if (payload.pinned || payload.active || payload.completed) {
      const pinned = Array.isArray(payload.pinned) ? payload.pinned : [];
      const active = Array.isArray(payload.active) ? payload.active : [];
      const completed = Array.isArray(payload.completed) ? payload.completed : [];
      gAllTasks = [...pinned, ...active, ...completed];
    } else {
      gAllTasks = [];
    }
  } else {
    console.warn('API logical error', payload);
    toast('Ë™≠„ÅøËæº„ÅøÂ§±ÊïóÔºàAPIÔºâ');
    return;
  }

  render();
}



      async function bootstrap() {
        // LIFF ÂàùÊúüÂåñ
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        const prof = await liff.getProfile();
        gUserId = prof.userId; // LINE userId
        document.getElementById("user-pill").textContent =
          "You: " + gUserId.slice(-6);

        // UI „Éè„É≥„Éâ„É©
        document.getElementById("reload").onclick = () => loadTasks(gUserId);
        document.getElementById("q").addEventListener("input", (e) => {
          const q = e.target.value.trim().toLowerCase();
          if (!q) {
            render();
            return;
          }
          const filtered = gAllTasks.filter(
            (t) =>
              (t.title || "").toLowerCase().includes(q) ||
              (t.detail || "").toLowerCase().includes(q)
          );
          const { pinned, active, completed } = splitByStatus(filtered);
          $pinned.hidden = pinned.length === 0;
          $completed.hidden = completed.length === 0;
          $empty.hidden = true;
          $pinnedList.innerHTML = sortTasks(pinned).map(cardHTML).join("");
          $activeList.innerHTML = sortTasks(active).map(cardHTML).join("");
          $completedList.innerHTML = sortTasks(completed)
            .map(cardHTML)
            .join("");
          [...document.querySelectorAll(".track")].forEach(bindSwipe);
        });

        await loadTasks(gUserId);
      }

      bootstrap();
    </script>
  </body>
</html>



