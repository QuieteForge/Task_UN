<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LISTÔΩú„Çø„Çπ„ÇØ</title>
<style>
:root{--bg:#f7f7f8;--card:#fff;--ink:#111;--sub:#666;--line:#e9e9ec;--accent:#3957ff;--ok:#16a34a;--warn:#eab308;--danger:#ef4444;}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
.bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
.title{font-weight:650}
main{padding:14px;max-width:720px;margin:auto}
h3{margin:10px 6px;color:var(--sub);font-size:13px}
.card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
.row{display:flex;align-items:center;gap:8px;padding:12px 14px}
.titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
.pin{color:var(--accent)}
.ghost{opacity:.45}

/* swipe */
.swipe-wrap{position:relative;overflow:hidden;border-radius:16px;touch-action:pan-y}
.actions{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;padding:0 8px;opacity:0;pointer-events:none;transition:opacity .15s}
.swipe-wrap.menu .actions{opacity:1;pointer-events:auto}
.swipe-wrap.menu .track{transform:translateX(-96px)}
.btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px}
.btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
.btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
.btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}
.track{position:relative;z-index:1;transition:transform .18s ease;will-change:transform}

.empty{color:var(--sub);text-align:center;padding:36px 12px}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
.toast.show{opacity:1}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header><div class="bar"><div class="title">LISTÔΩú„Çø„Çπ„ÇØ</div><div id="user-pill">loading‚Ä¶</div></div></header>
<main>
<section id="active"><h3>üìù Êú™ÂÆå‰∫Ü</h3><div id="active-list"></div></section>
<section id="completed" hidden><h3>‚úÖ ÂÆå‰∫Ü</h3><div id="completed-list"></div></section>
<div id="empty" class="empty" hidden>„Åæ„Å†„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
</main>
<div id="toast" class="toast"></div>

<script>
/* ===== Ë®≠ÂÆö ===== */
const LIFF_ID="2008311584-NdJqOqMn";
const LIST_API_URL="https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL="https://lumicreate.xvps.jp/webhook/webhook-action";

/* ===== Áä∂ÊÖã ===== */
let gUserId=null,gAll=[];

/* ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ===== */
const $=s=>document.querySelector(s);
function toast(m){const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1500);}
function esc(s){return (s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));}
function fmt(iso){if(!iso)return"";const d=new Date(iso);return d.toLocaleString("ja-JP",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});}

/* ===== DOMÊèèÁîª ===== */
function cardHTML(t){
  const leftSide = t.status==="completed"
    ? `<button class='btn ok' data-act='uncomplete'>ÂèñÊ∂à</button>`
    : `<button class='btn ok' data-act='complete'>ÂÆå‰∫Ü</button>`;

  return `
  <div class="swipe-wrap card${t.status==="completed"?" ghost":""}" 
       data-id="${t.id}" data-status="${t.status||'active'}">
    <div class="actions">
      <div>${leftSide}</div>
      <div>
        <button class='btn' data-act='pin'>„Éî„É≥</button>
        <button class='btn' data-act='detail'>Ë©≥Á¥∞</button>
        <button class='btn danger' data-act='delete'>ÂâäÈô§</button>
      </div>
    </div>
    <div class="track">
      <div class="row">
        <div class="titleTxt">${t.pinned?"üìå":""}${esc(t.title||"(ÁÑ°È°å)")}</div>
        <div class="meta">${fmt(t.due_at)}</div>
      </div>
    </div>
  </div>`;
}

function render(){
 const active=gAll.filter(t=>t.status!=="completed"&&t.status!=="deleted");
 const completed=gAll.filter(t=>t.status==="completed");
 $("#active-list").innerHTML=active.map(cardHTML).join("");
 $("#completed-list").innerHTML=completed.map(cardHTML).join("");
 $("#completed").hidden=completed.length===0;
 $("#empty").hidden=(active.length+completed.length)>0;
 document.querySelectorAll(".track").forEach(bindSwipe);
}

/* ===== „Éá„Éº„Çø„É≠„Éº„Éâ/„Ç¢„ÇØ„Ç∑„Éß„É≥ ===== */
async function load(){
 const res=await fetch(`${LIST_API_URL}?user_id=${encodeURIComponent(gUserId)}`);
 const j=await res.json();
 gAll = j.data || [...(j.pinned||[]), ...(j.active||[]), ...(j.completed||[])];
 render();
}

async function runAction(id,act){
 if(act==="delete"){
   const yes = confirm("„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");
   if(!yes) return;
 }
 const body={action:act,task_id:id,user_id:gUserId};
 const res=await fetch(ACTION_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
 const j=await res.json().catch(()=>({ok:false}));
 if(!res.ok||!j.ok){toast("Â§±Êïó„Åó„Åæ„Åó„Åü");return;}
 toast(
   act==="uncomplete" ? "ÂÆå‰∫Ü„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü" :
   act==="complete"   ? "ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü" :
   act==="pin"        ? "„Éî„É≥„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åó„Åü" :
   act==="delete"     ? "ÂâäÈô§„Åó„Åæ„Åó„Åü" : "OK"
 );
 await load();
}

/* ===== „Çπ„ÉØ„Ç§„ÉóÂà∂Âæ° =====
 Âè≥ÔºöÂº∑„Çπ„ÉØ„Ç§„Éó„ÅÆ„ÅøÂÆå‰∫Ü/ÂèñÊ∂à
 Â∑¶ÔºöËªΩ„ÅÑ ‚Üí „É°„Éã„É•„ÉºË°®Á§∫„ÄÅÂº∑„ÅÑ ‚Üí ÂâäÈô§ÔºàÁ¢∫Ë™ç„ÅÇ„ÇäÔºâ
*/
function bindSwipe(track) {
  const wrap = track.parentElement;
  const actions = wrap.querySelector(".actions");

  // ÈñæÂÄ§Ë®≠ÂÆö
  const SW_MENU = 40; // ËªΩ„ÅÑÂ∑¶„Çπ„ÉØ„Ç§„Éó„Åß„É°„Éã„É•„Éº
  const SW_ACTION = 150; // Âº∑„Çπ„ÉØ„Ç§„ÉóË∑ùÈõ¢
  const V_MENU = 0.40; // ËªΩÂ∑¶„Çπ„ÉØ„Ç§„ÉóÈÄüÂ∫¶(px/ms)
  const V_ACTION = 0.85; // Âº∑„Çπ„ÉØ„Ç§„ÉóÈÄüÂ∫¶(px/ms)

  let sx = 0, dx = 0, dragging = false;
  const recent = []; // {x,t}
  const WINDOW_MS = 120;

  const isOpen = () => wrap.classList.contains("menu");
  const open = () => {
    closeAll();
    wrap.classList.add("menu");
    actions.style.opacity = 1;
    track.style.transform = "translateX(-96px)";
  };
  const close = () => {
    wrap.classList.remove("menu");
    actions.style.opacity = 0;
    track.style.transform = "translateX(0)";
  };
  function closeAll() {
    document.querySelectorAll(".swipe-wrap.menu").forEach(w => {
      w.classList.remove("menu");
      const tr = w.querySelector(".track");
      const ac = w.querySelector(".actions");
      tr.style.transform = "translateX(0)";
      ac.style.opacity = 0;
    });
  }

  // recentÈÖçÂàó„Å´Âãï„Åç„Çí‰øùÂ≠ò
  function pushRecent(x) {
    const now = performance.now();
    recent.push({ x, t: now });
    while (recent.length && (now - recent[0].t) > WINDOW_MS) recent.shift();
  }

  // ÈÄüÂ∫¶(px/ms)
  function velocity() {
    if (recent.length < 2) return 0;
    const a = recent[0], b = recent[recent.length - 1];
    const dt = b.t - a.t;
    return dt ? (b.x - a.x) / dt : 0;
  }

  // „Çπ„ÉØ„Ç§„ÉóÈñãÂßã
  const start = x => {
    dragging = true;
    sx = x;
    dx = 0;
    recent.length = 0;
    pushRecent(x);
    track.style.transition = "none";
  };

  // „Çπ„ÉØ„Ç§„Éó‰∏≠
  const move = x => {
    if (!dragging) return;
    dx = x - sx;
    pushRecent(x);

    if (isOpen()) {
      if (dx > 20) close();
      return;
    }

    const preview = Math.max(-96, Math.min(24, dx));
    track.style.transform = `translateX(${preview}px)`;
    actions.style.opacity = Math.min(1, Math.abs(preview) / 80);
  };

  // „Çπ„ÉØ„Ç§„ÉóÁµÇ‰∫Ü
  const end = async () => {
    track.style.transition = "transform .18s ease";
    const v = velocity();
    const dist = dx;
    let act = null;

    if (isOpen()) {
      track.style.transform = "translateX(-96px)";
      actions.style.opacity = 1;
      dragging = false;
      dx = 0;
      recent.length = 0;
      return;
    }

    // Âº∑„Çπ„ÉØ„Ç§„ÉóÂà§ÂÆöÔºàË∑ùÈõ¢ or ÈÄüÂ∫¶Ôºâ
    if (v >= V_ACTION || dist >= SW_ACTION) {
      act = wrap.dataset.status === "completed" ? "uncomplete" : "complete";
    } else if (v <= -V_ACTION || dist <= -SW_ACTION) {
      act = "delete";
    } else if (v <= -V_MENU || dist <= -SW_MENU) {
      open();
    }

    if (!act) {
      track.style.transform = "translateX(0)";
      actions.style.opacity = 0;
      dragging = false;
      dx = 0;
      return;
    }

    // Á¢∫Ë™ç„Å§„ÅçÂâäÈô§
    if (act === "delete") {
      const ok = confirm("„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");
      if (!ok) {
        track.style.transform = "translateX(0)";
        actions.style.opacity = 0;
        dragging = false;
        dx = 0;
        return;
      }
    }

    await runAction(wrap.dataset.id, act);
    dragging = false;
    dx = 0;
    recent.length = 0;
  };

  // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
  wrap.querySelectorAll(".btn").forEach(b =>
    b.addEventListener("click", e => {
      e.stopPropagation();
      runAction(wrap.dataset.id, b.dataset.act);
    })
  );

  // „Ç§„Éô„É≥„ÉàÁôªÈå≤
  track.addEventListener("touchstart", e => start(e.touches[0].clientX), { passive: true });
  track.addEventListener("touchmove", e => move(e.touches[0].clientX), { passive: true });
  track.addEventListener("touchend", end);
  track.addEventListener("touchcancel", end);

  track.addEventListener("mousedown", e => start(e.clientX));
  track.addEventListener("mousemove", e => { if (e.buttons === 1) move(e.clientX); });
  track.addEventListener("mouseup", end);

  document.addEventListener("click", e => { if (!wrap.contains(e.target)) closeAll(); });
}

/* ===== Ëµ∑Âãï ===== */
(async()=>{
 await liff.init({liffId:LIFF_ID});
 if(!liff.isLoggedIn()) liff.login();
 const prof=await liff.getProfile(); gUserId=prof.userId;
 $("#user-pill").textContent="ID:"+gUserId.slice(-5);
 await load();
})();
</script>
</body>
</html>


