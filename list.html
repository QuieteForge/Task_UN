<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LISTï½œã‚¿ã‚¹ã‚¯</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
      --left-ok-bg:#ecfdf5;   /* æœªå®Œäº†â†’å®Œäº†ï¼ˆç·‘ï¼‰ */
      --left-warn-bg:#fffbeb; /* å®Œäº†â†’æœªå®Œäº†ï¼ˆé»„ï¼‰ */
      --right-bg:#fef2f2;     /* å‰Šé™¤å´ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    header{
      position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--line); z-index:10;
    }
    .bar{display:flex; align-items:center; gap:8px; justify-content:space-between; padding:12px 16px;}
    .title{font-weight:650; letter-spacing:.2px}
    .pill{padding:6px 10px; border-radius:999px; background:var(--pill); font-size:12px}
    main{padding:14px; max-width:720px; margin:0 auto}

    .section{margin:18px 0}
    .section h3{margin:8px 6px 10px; font-size:13px; color:var(--sub); font-weight:600}

    /* ===== ã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒŠï¼ˆèƒŒé¢ï¼‰ ===== */
    .swipe-wrap{
      position:relative; border-radius:16px; margin:10px 0;
      background:
        linear-gradient(90deg, var(--left-ok-bg) 0 50%, var(--right-bg) 50% 100%);
      background-size:200% 100%;
      background-position:50% 0;  /* åˆæœŸã¯ä¸­å¤®ï¼å¸¯ãŒè¦‹ãˆãªã„ */
      overflow:hidden; border:1px solid var(--line);
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    /* å®Œäº†æ¸ˆã¿ã¯æœªå®Œäº†ãƒœã‚¿ãƒ³ï¼ˆé»„ï¼‰ã‚’ç¤ºã™å¸¯ã«å·®ã—æ›¿ãˆ */
    .swipe-wrap.left-warn{
      background:
        linear-gradient(90deg, var(--left-warn-bg) 0 50%, var(--right-bg) 50% 100%);
      background-size:200% 100%;
      background-position:50% 0;
    }

    /* èƒŒé¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³åˆ—ï¼ˆå·¦å³ï¼‰ */
    .actions{
      position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center; padding:0 8px; pointer-events:none;
    }
    .actions .left, .actions .right{display:flex; gap:8px}
    .btn{
      pointer-events:auto; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#fff; font-size:12px;
      user-select:none;
    }
    .btn.ok{border-color:#c7ecd1; color:var(--ok); background:#fff}       /* å®Œäº†ï¼ˆç·‘ï¼‰ */
    .btn.uncomplete{border-color:#fde68a; color:var(--warn); background:#fff} /* æœªå®Œäº†ã«æˆ»ã™ï¼ˆé»„ï¼‰ */
    .btn.info{border-color:#dbeafe; color:#2563eb; background:#fff}
    .btn.danger{border-color:#fecaca; color:var(--danger); background:#fff}

    /* ===== è¡¨é¢ãƒˆãƒ©ãƒƒã‚¯ï¼ˆæ¨ªã«å‹•ãï¼‰ ===== */
    .track{
      position:relative; background:var(--card); /* é€ã‘é˜²æ­¢ */
      touch-action:pan-y; will-change:transform;
    }
    .card{padding:12px 14px;}
    .row{display:flex; align-items:center; gap:8px}
    .titleTxt{flex:1; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta{display:flex; gap:8px; color:var(--sub); font-size:12px}
    .chip{padding:2px 8px; border-radius:999px; border:1px solid var(--line)}
    .ghost .titleTxt{opacity:.45} /* å®Œäº†æ™‚ãƒ†ã‚­ã‚¹ãƒˆã ã‘è–„ãï¼ˆãƒœã‚¿ãƒ³ã¯é€ã‘ãªã„ï¼‰ */

    /* ===== è©³ç´°ãƒ“ãƒ¥ãƒ¼ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ ===== */
    .detail{
      max-height:0; overflow:hidden; transition:max-height .24s ease, padding .24s ease, border .24s ease;
      padding:0 14px; border-top:1px solid transparent; background:#fff;
    }
    .detail.open{
      padding:10px 14px 14px; border-top:1px solid var(--line);
    }
    .detail .grid{display:grid; grid-template-columns:96px 1fr; gap:8px 10px; align-items:center}
    .detail label{font-size:12px; color:var(--sub)}
    .detail input,.detail select,.detail textarea{
      width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; font:inherit; background:#fff;
    }
    .detail textarea{min-height:72px; resize:vertical}
    .detail .rowBtns{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
    .toolbar{display:flex; gap:8px; padding:8px}
    .toolbar input{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .toolbar button{padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff}

    .empty{color:var(--sub); text-align:center; padding:36px 12px}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff;
      padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; transition:.25s; z-index:50;
    }
    .toast.show{opacity:1}

    /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®éåº¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘åˆ¶ */
    .no-scroll{overflow:hidden; touch-action:none}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div class="toolbar">
    <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰"/>
    <button id="reload">å†èª­è¾¼</button>
  </div>

  <div id="active" class="section">
    <h3>ğŸ“ ã‚¿ã‚¹ã‚¯</h3>
    <div id="active-list"></div>
  </div>

  <div id="completed" class="section">
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<div id="toast" class="toast"></div>

<script>
/** ========= è¨­å®š ========= */
const LIFF_ID        = "2008311584-NdJqOqMn";
const LIST_API_URL   = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";
/** ======================= */

let gUserId = null;
let gAllTasks = [];  // {id,title,detail,priority,due_at,status,completed_at,remind_times...}

const $ = sel => document.querySelector(sel);
const $activeList    = $('#active-list');
const $completedList = $('#completed-list');
const $empty         = $('#empty');

function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
function fmtJST(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString('ja-JP',{timeZone:'Asia/Tokyo',month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
function esc(s){return String(s??'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

function sortByPriority(arr){
  // priorityã®ã¿è©•ä¾¡ï¼ˆæ•°å€¤å¤§â†’å°ï¼‰ã€‚åŒç‡ã¯ created_at æ˜‡é †
  return arr.slice().sort((a,b)=>{
    const ap = Number.isFinite(a.priority)? a.priority : -1;
    const bp = Number.isFinite(b.priority)? b.priority : -1;
    if (bp!==ap) return bp-ap;
    const ac = a.created_at ? new Date(a.created_at).getTime() : 0;
    const bc = b.created_at ? new Date(b.created_at).getTime() : 0;
    return ac-bc;
  });
}
function splitGroups(all){
  const now=Date.now(), weekAgo= now-7*24*3600*1000;
  const active=[], completed=[];
  for(const t of all){
    if (t.status==='completed'){
      const cAt = t.completed_at ? new Date(t.completed_at).getTime():0;
      if (cAt>=weekAgo) completed.push(t);
    } else if (t.status!=='deleted' && t.status!=='archived') {
      active.push(t);
    }
  }
  return {active, completed};
}

function toLocalValue(iso){
  if(!iso) return '';
  const d = new Date(iso);
  const pad=n=>String(n).padStart(2,'0');
  const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate());
  const hh=pad(d.getHours()), mm=pad(d.getMinutes());
  return `${y}-${m}-${da}T${hh}:${mm}`;
}
function fromLocalValue(v){
  if(!v) return null;
  const d = new Date(v);
  return d.toISOString();
}
function defaultRemind(t){
  if(!t?.due_at) return null;
  const d = new Date(t.due_at);
  d.setHours(d.getHours()-2);
  return d.toISOString();
}

/* ====== ã‚«ãƒ¼ãƒ‰HTML ====== */
function cardHTML(t){
  const due = fmtJST(t.due_at);
  const isCompleted = t.status==='completed';
  const leftAct   = isCompleted? 'uncomplete':'complete';
  const leftLabel = isCompleted? 'æœªå®Œäº†':'å®Œäº†';
  const leftBtnCls= isCompleted? 'uncomplete':'ok'; /* ãƒœã‚¿ãƒ³è‰²ï¼šæœªå®Œäº†ï¼ˆé»„ï¼‰/å®Œäº†ï¼ˆç·‘ï¼‰ */
  const wrapCls   = isCompleted? 'swipe-wrap left-warn':'swipe-wrap';

  return `
  <div class="${wrapCls}" data-id="${t.id}">
    <div class="actions">
      <div class="left">
        <button class="btn ${leftBtnCls}" data-act="${leftAct}">${leftLabel}</button>
      </div>
      <div class="right">
        <button class="btn info"   data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>

    <div class="track ${isCompleted?'ghost':''}">
      <div class="card">
        <div class="row">
          <div class="titleTxt">${esc(t.title)||'(ç„¡é¡Œ)'}</div>
          <div class="meta">
            ${Number.isFinite(t.priority)? `<span class="chip">â˜…${t.priority}</span>`:''}
            ${due? `<span class="chip">â° ${esc(due)}</span>`:''}
          </div>
        </div>
      </div>

      <div class="detail" id="detail-${t.id}">
        <div class="grid">
          <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
          <textarea name="detail">${esc(t.detail||'')}</textarea>

          <label>å„ªå…ˆåº¦</label>
          <select name="priority">
            <option value="1" ${t.priority==1?'selected':''}>1</option>
            <option value="2" ${t.priority==2?'selected':''}>2</option>
            <option value="3" ${t.priority==3?'selected':''}>3</option>
          </select>

          <label>æœŸé™</label>
          <input name="due_at" type="datetime-local" value="${toLocalValue(t.due_at)}"/>

          <label>ãƒªãƒã‚¤ãƒ³ãƒ‰</label>
          <input name="remind_at" type="datetime-local" value="${toLocalValue(defaultRemind(t))}"/>
        </div>
        <div class="rowBtns">
          <button class="btn"    data-daction="cancel">é–‰ã˜ã‚‹</button>
          <button class="btn ok" data-daction="save">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>`;
}

async function loadTasks(userId){
  if(!userId){
    const prof = await liff.getProfile();
    userId = prof.userId; gUserId = userId;
  }
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
  let res,payload;
  try{
    res = await fetch(url, {method:'GET', credentials:'omit', headers:{'Content-Type':'application/json'}});
    payload = await res.json();
  }catch(e){
    toast('èª­ã¿è¾¼ã¿å¤±æ•—');
    return;
  }
  if(!res.ok || !payload || payload.ok!==true){
    toast('èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆHTTP '+res.status+'ï¼‰');
    return;
  }
  const act = Array.isArray(payload.active)? payload.active: [];
  const comp= Array.isArray(payload.completed)? payload.completed: [];
  gAllTasks = [...act, ...comp];
  render();
}

function render(){
  const {active, completed} = splitGroups(gAllTasks);
  const aSorted = sortByPriority(active);
  const cSorted = sortByPriority(completed);
  $activeList.innerHTML    = aSorted.map(cardHTML).join('');
  $completedList.innerHTML = cSorted.map(cardHTML).join('');
  $empty.hidden = (aSorted.length + cSorted.length) > 0;

  // ã‚¹ãƒ¯ã‚¤ãƒ—ãƒã‚¤ãƒ³ãƒ‰
  document.querySelectorAll('.swipe-wrap').forEach(bindSwipeCard);

  // å·¦åˆ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº† / æœªå®Œäº†ï¼‰
  document.querySelectorAll('.btn[data-act="complete"], .btn[data-act="uncomplete"]').forEach(b=>{
    b.onclick = async ()=>{
      const wrap = b.closest('.swipe-wrap');
      await runAction(wrap.dataset.id, b.getAttribute('data-act'));
    };
  });
  // è©³ç´°
  document.querySelectorAll('.btn[data-act="detail"]').forEach(b=>{
    b.onclick = ()=>{
      const wrap = b.closest('.swipe-wrap');
      toggleDetail(wrap, true);
    };
  });
  // å‰Šé™¤
  document.querySelectorAll('.btn[data-act="delete"]').forEach(b=>{
    b.onclick = async ()=>{
      const wrap = b.closest('.swipe-wrap');
      if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await runAction(wrap.dataset.id, 'delete');
    };
  });

  // è©³ç´°ãƒ“ãƒ¥ãƒ¼å†…ï¼šä¿å­˜/é–‰ã˜ã‚‹
  document.querySelectorAll('.detail').forEach(d=>{
    const wrap = d.closest('.swipe-wrap');
    const id   = wrap.dataset.id;
    const btnSave  = d.querySelector('[data-daction="save"]');
    const btnClose = d.querySelector('[data-daction="cancel"]');

    const doClose = ()=> toggleDetail(wrap, false);
    if (btnClose) btnClose.onclick = doClose;
    if (btnSave)  btnSave.onclick  = async ()=>{
      const fields = collectDetailFields(d);
      const ok = await runAction(id, 'update', {fields});
      if (ok) toggleDetail(wrap,false);
    };
  });

  // ã‚«ãƒ¼ãƒ‰é¢ã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒˆã‚°ãƒ«
  document.querySelectorAll('.track .card').forEach(card=>{
    const wrap = card.closest('.swipe-wrap');
    card.onclick = ()=>{
      const detail = wrap.querySelector('.detail');
      const open = !detail.classList.contains('open');
      // ä»–ã®é–‹ã„ã¦ã„ã‚‹è©³ç´°ã‚’é–‰ã˜ã‚‹
      document.querySelectorAll('.detail.open').forEach(el=>{
        if (el!==detail) { el.classList.remove('open'); el.style.maxHeight='0px'; }
      });
      toggleDetail(wrap, open);
    };
  });

  // è©³ç´°å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆå¸¸ã«ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆç™»éŒ²â†’å†ç™»éŒ²ï¼‰
  document.addEventListener('click', onDocClickToClose, {once:true});
}

function onDocClickToClose(e){
  const open = document.querySelector('.detail.open');
  if(!open) return;
  if (!open.contains(e.target) && !e.target.closest('.card')) {
    open.classList.remove('open'); open.style.maxHeight='0px';
  }
  document.addEventListener('click', onDocClickToClose, {once:true});
}

function collectDetailFields(detailEl){
  const v = Object.fromEntries([...detailEl.querySelectorAll('[name]')].map(i=>[i.name,i.value]));
  const patch = {};
  patch.detail   = v.detail || '';
  patch.priority = Number(v.priority)||1;
  patch.due_at   = fromLocalValue(v.due_at);
  const r = fromLocalValue(v.remind_at);
  patch.remind_times = r? [r] : [];
  return patch;
}

/* ============ ã‚¹ãƒ¯ã‚¤ãƒ—ï¼†ã‚¹ãƒŠãƒƒãƒ— ============ */
const L_EXPOSE = 88;   // å·¦ãƒœã‚¿ãƒ³ãŒè¦‹ãˆã‚‹åœæ­¢ä½ç½®ï¼ˆä½™ç™½ã‚’åˆã‚ã›ãŸã„å ´åˆã¯ã“ã®å€¤ã§èª¿æ•´ï¼‰
const R_EXPOSE = 124;  // å³ãƒœã‚¿ãƒ³ãŒè¦‹ãˆã‚‹åœæ­¢ä½ç½®
const L_COMMIT = 180;  // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå·¦ï¼‰ã§å³å®Ÿè¡Œ
const R_COMMIT = 180;  // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå³ï¼‰ã§å³å®Ÿè¡Œ
const FAST = 900;      // px/s ä»¥ä¸Šã¯é«˜é€Ÿæ‰±ã„

function bindSwipeCard(wrap){
  const track= wrap.querySelector('.track');
  let sx=0, dx=0, startT=0, dragging=false, raf=null;

  const setX = x => track.style.transform = `translateX(${Math.round(x)}px)`;

  const onStart = (clientX)=>{
    dragging=true; sx=clientX; dx=0; startT=performance.now();
    track.style.transition='none';
    document.body.classList.add('no-scroll');
  };
  const onMove = (clientX)=>{
    if(!dragging) return;
    dx = clientX - sx;
    // èƒŒæ™¯å¸¯ã‚’å¼·èª¿ï¼ˆå·¦ï¼0ã€å³ï¼œ0ï¼‰
    if (dx>0) wrap.style.backgroundPosition = '0% 0';
    else if (dx<0) wrap.style.backgroundPosition = '100% 0';
    else wrap.style.backgroundPosition = '50% 0';
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=> setX(dx));
  };
  const onEnd = async ()=>{
    if(!dragging) return;
    dragging=false;
    document.body.classList.remove('no-scroll');

    const dt = Math.max(16, performance.now()-startT);
    const vx = (dx/dt) * 1000; // px/s

    let doAct=null, snapTo=0;

    // å·¦ï¼ˆå®Œäº†/æœªå®Œäº†ï¼‰
    if (dx>0){
      const isCompleted = track.classList.contains('ghost');
      if (dx>=L_COMMIT || vx>FAST){
        doAct = isCompleted? 'uncomplete':'complete';
      } else if (dx>=L_EXPOSE){
        snapTo = L_EXPOSE; // æ“ä½œãƒœã‚¿ãƒ³éœ²å‡ºã§åœæ­¢
      }
    }
    // å³ï¼ˆè©³ç´° / å‰Šé™¤ï¼‰
    else if (dx<0){
      if (-dx>=R_COMMIT || -vx>FAST){
        doAct = 'delete';
      } else if (-dx>=R_EXPOSE){
        snapTo = -R_EXPOSE; // æ“ä½œãƒœã‚¿ãƒ³éœ²å‡ºã§åœæ­¢
      }
    }

    // ã‚¹ãƒŠãƒƒãƒ— or æˆ»ã™
    track.style.transition='transform .18s ease';
    if (snapTo){
      setX(snapTo);
      bindActionButtonsWhileSnapped(wrap, snapTo);
    } else {
      setX(0);
      // å¼·ã„ã‚¹ãƒ¯ã‚¤ãƒ—ã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      if (doAct){
        const ok = await runAction(wrap.dataset.id, doAct);
        if (!ok){ /* å¤±æ•—æ™‚ã¯æ—¢ã«æˆ»ã£ã¦ã„ã‚‹ */ }
      }
    }
    // èƒŒæ™¯å¸¯ã‚’ä¸­ç«‹ã¸
    wrap.style.backgroundPosition = '50% 0';
    dx=0;
  };

  // ã‚¿ãƒƒãƒï¼†ãƒã‚¦ã‚¹
  track.addEventListener('touchstart', e=>onStart(e.touches[0].clientX), {passive:true});
  track.addEventListener('touchmove',  e=>onMove(e.touches[0].clientX),  {passive:true});
  track.addEventListener('touchend',   onEnd);

  track.addEventListener('mousedown', e=>onStart(e.clientX));
  track.addEventListener('mousemove', e=>{ if(e.buttons===1) onMove(e.clientX) });
  track.addEventListener('mouseup', onEnd);

  // ã‚¹ãƒŠãƒƒãƒ—ä¸­ã«å¤–å´ã‚¿ãƒƒãƒ—ã§æˆ»ã™
  wrap.addEventListener('click', e=>{
    if (track.style.transform && track.style.transform!=='translateX(0px)'){
      if (!e.target.classList.contains('btn')){
        track.style.transition='transform .18s ease';
        setX(0);
      }
    }
  });
}

function bindActionButtonsWhileSnapped(wrap, snapTo){
  const track = wrap.querySelector('.track');
  const setX = x => track.style.transform = `translateX(${Math.round(x)}px)`;

  if (snapTo>0){
    const btn = wrap.querySelector('.left .btn');  // å®Œäº†/æœªå®Œäº†
    if (btn) btn.onclick = async ()=>{
      const isCompleted = track.classList.contains('ghost');
      const ok = await runAction(wrap.dataset.id, isCompleted?'uncomplete':'complete');
      if (ok) setX(0);
    };
  } else if (snapTo<0){
    const d = wrap.querySelector('.btn.danger'); // å‰Šé™¤
    const i = wrap.querySelector('.btn.info');   // è©³ç´°
    if (i) i.onclick = ()=>{ toggleDetail(wrap,true); setX(0); };
    if (d) d.onclick = async ()=>{
      if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      const ok = await runAction(wrap.dataset.id,'delete');
      if (ok) setX(0);
    };
  }
}

/* ============ è©³ç´°ãƒ“ãƒ¥ãƒ¼ ============ */
function toggleDetail(wrap, open){
  const detail = wrap.querySelector('.detail');
  if (!detail) return;
  if (open){
    document.querySelectorAll('.detail.open').forEach(el=>{
      if (el!==detail){ el.classList.remove('open'); el.style.maxHeight='0px'; }
    });
    detail.classList.add('open');
    requestAnimationFrame(()=>{
      detail.style.maxHeight = detail.scrollHeight + 24 + 'px';
    });
  } else {
    detail.classList.remove('open');
    detail.style.maxHeight='0px';
  }
}

/* ============ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ ============ */
async function runAction(taskId, action, extra={}){
  try{
    const res = await fetch(ACTION_API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action, task_id: taskId, user_id: gUserId, ...extra })
    });
    const j = await res.json().catch(()=>({ok:false}));
    if (!res.ok || j.ok===false){
      toast('action failed');
      return false;
    }
    // ãƒ­ãƒ¼ã‚«ãƒ«åæ˜ 
    if (action==='complete' || action==='uncomplete'){
      const t = gAllTasks.find(x=>x.id===taskId);
      if (t){
        if (action==='complete'){ 
          t.status='completed'; 
          t.completed_at=(new Date()).toISOString(); 
        } else { 
          t.status='active'; 
          t.completed_at=null; 
        }
      }
    } else if (action==='delete'){
      const t = gAllTasks.find(x=>x.id===taskId);
      if (t) t.status='deleted';
    } else if (action==='update'){
      const t = gAllTasks.find(x=>x.id===taskId);
      if (t && extra.fields){
        Object.assign(t, extra.fields);
      }
    }
    render();
    const label = ({complete:'å®Œäº†', uncomplete:'æœªå®Œäº†ã¸æˆ»ã—', delete:'å‰Šé™¤', update:'æ›´æ–°'})[action] || action;
    toast(label+'ã—ã¾ã—ãŸ');
    return true;
  }catch(e){
    toast('ã‚¨ãƒ©ãƒ¼');
    return false;
  }
}

/* ============ èµ·å‹• ============ */
async function bootstrap(){
  await liff.init({liffId: LIFF_ID});
  if (!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  gUserId = prof.userId;
  $('#user-pill').textContent = 'You: ' + gUserId.slice(-6);

  // æ¤œç´¢
  $('#q').addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    if (!q){ render(); return; }
    const filtered = gAllTasks.filter(t=>
      (t.title||'').toLowerCase().includes(q) ||
      (t.detail||'').toLowerCase().includes(q)
    );
    const {active, completed} = splitGroups(filtered);
    $activeList.innerHTML    = sortByPriority(active).map(cardHTML).join('');
    $completedList.innerHTML = sortByPriority(completed).map(cardHTML).join('');
    $empty.hidden = (active.length + completed.length) > 0;
    document.querySelectorAll('.swipe-wrap').forEach(bindSwipeCard);
  });

  $('#reload').onclick = ()=> loadTasks(gUserId);

  await loadTasks(gUserId);
}
bootstrap();
</script>
</body>
</html>
