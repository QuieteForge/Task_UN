<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LISTï½œã‚¿ã‚¹ã‚¯</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
      --padX:14px; /* ã‚«ãƒ¼ãƒ‰å·¦å³ã®å†…å´ä½™ç™½ï¼ˆå·¦éœ²å‡ºè¨ˆç®—ã«åˆ©ç”¨ï¼‰ */
      --gap:8px;   /* ãƒœã‚¿ãƒ³ç¾¤ã®å¤–å´ä½™ç™½ï¼ˆéœ²å‡ºæ™‚ã®è¦‹ãŸç›®ã‚’æƒãˆã‚‹ï¼‰ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
    .bar{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px 16px}
    .title{font-weight:650;letter-spacing:.2px}
    .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;font-size:12px}
    main{padding:14px;max-width:720px;margin:0 auto}
    .section{margin:18px 0}
    .section h3{margin:8px 6px 10px;font-size:13px;color:var(--sub);font-weight:600}

    .card{
      position:relative;background:var(--card);border:1px solid var(--line);
      border-radius:16px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.03);
      overflow:hidden; /* è©³ç´°ãƒ“ãƒ¥ãƒ¼ã‚’ç¶ºéº—ã«åˆ‡ã‚‹ */
    }
    .swipe-wrap{position:relative}
    .actions{
      position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;
      padding:0 8px; pointer-events:none;
    }
    .side{display:flex;gap:6px;align-items:center}
    .btn{
      pointer-events:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--line);
      background:var(--card);font-size:12px;user-select:none;
    }
    .btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
    .btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
    .btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}

    .track{
      position:relative;touch-action:pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯å¸¸ã«è¨±å¯ */
      background:var(--card); padding:12px var(--padX);
      transition:transform .18s ease; will-change:transform;
    }
    .row{display:flex;align-items:center;gap:8px}
    .titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
    .pillDue{padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .ghost{opacity:.45}

    /* è©³ç´°ãƒ“ãƒ¥ãƒ¼ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ */
    .detail{
      border-top:1px solid var(--line);
      background:#fff;
      transition:max-height .22s ease;
      max-height:0; overflow:hidden;
      padding:0 var(--padX);
    }
    .detail.open{max-height:320px; /* å…¥åŠ›UIåˆ†ã‚ã‚Œã°OK */ padding:12px var(--padX) 12px;}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:var(--sub)}
    .field input,.field textarea,.field select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font:inherit
    }
    .detailBar{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .saveBtn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#111;color:#fff;font-size:13px}

    .toolbar{display:flex;gap:8px;padding:8px}
    .toolbar input{flex:1;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .toolbar button{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}

    .empty{color:var(--sub);text-align:center;padding:36px 12px}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;
      padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
      <div class="pill" id="user-pill">loadingâ€¦</div>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰" />
      <button id="reload">å†èª­è¾¼</button>
    </div>

    <div id="active" class="section">
      <h3>ğŸ“ æœªå®Œäº†</h3>
      <div id="active-list"></div>
    </div>

    <div id="completed" class="section">
      <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
      <div id="completed-list"></div>
    </div>

    <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // ======= è¨­å®š =======
    const LIFF_ID = "2008311584-NdJqOqMn";
    const LIST_API_URL   = "https://lumicreate.xvps.jp/webhook/webhook-list";
    const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";
    // ====================

    let gUserId = null;
    let gAllTasks = [];
    let gOpenDetailId = null; // åŒæ™‚ã«1ä»¶ã ã‘é–‹ã

    const $ = s => document.querySelector(s);
    const $activeList    = $("#active-list");
    const $completedList = $("#completed-list");
    const $empty         = $("#empty");

    const toast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1400); };
    const fmtJST = iso => !iso ? "" : new Date(iso).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});

    // ä¸¦ã³é †ï¼šå„ªå…ˆåº¦(é™) â†’ æœŸé™(æ˜‡) â†’ ä½œæˆ(æ˜‡)
    function sortTasks(arr){
      return arr.slice().sort((a,b)=>{
        const ap = Number.isFinite(a.priority)?a.priority:-1;
        const bp = Number.isFinite(b.priority)?b.priority:-1;
        if (ap !== bp) return bp - ap; // å„ªå…ˆåº¦ã¯å¤§ãã„ã»ã©ä¸Š
        const ad = new Date(a.due_at||0).getTime();
        const bd = new Date(b.due_at||0).getTime();
        if (ad !== bd) return ad - bd;
        return new Date(a.created_at||0) - new Date(b.created_at||0);
      });
    }
    function splitByStatus(all){
      const now=Date.now(), weekAgo=now-7*24*3600*1000;
      const active=[], completed=[];
      for (const t of all){
        if (t.status === "completed"){
          const cAt = t.completed_at ? new Date(t.completed_at).getTime() : 0;
          if (cAt >= weekAgo) completed.push(t);
          continue;
        }
        if (t.status==="deleted"||t.status==="archived") continue;
        active.push(t);
      }
      return {active,completed};
    }

    function cardHTML(t){
      const dueTxt = fmtJST(t.due_at);
      const ghost  = t.status==="completed" ? " ghost" : "";
      // detailãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ï¼ˆåˆæœŸå€¤ï¼‰
      const detailVal = t.detail || "";
      const pri = Number.isFinite(t.priority) ? t.priority : 1;
      const dueISO = t.due_at ? new Date(t.due_at).toISOString().slice(0,16) : ""; // datetime-local ç”¨
      const r0 = Array.isArray(t.remind_times) && t.remind_times[0]
        ? new Date(t.remind_times[0]).toISOString().slice(0,16) : "";

      return `
      <div class="card" data-id="${t.id}">
        <div class="swipe-wrap" data-id="${t.id}">
          <div class="actions">
            <div class="side side-left">
              <button class="btn ok" data-act="complete">å®Œäº†</button>
            </div>
            <div class="side side-right">
              <button class="btn" data-act="detail">è©³ç´°</button>
              <button class="btn danger" data-act="delete">å‰Šé™¤</button>
            </div>
          </div>

          <div class="track${ghost}">
            <div class="row">
              <div class="titleTxt">${escapeHTML(t.title || "(ç„¡é¡Œ)")}</div>
              <div class="meta">
                <span class="pillDue">â˜…${pri}</span>
                <span class="pillDue">â° ${escapeHTML(dueTxt)}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="detail" id="detail-${t.id}">
          <div class="field">
            <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¡ãƒ¢ï¼‰</label>
            <textarea rows="3" data-field="detail" placeholder="ãƒ¡ãƒ¢â€¦">${escapeHTML(detailVal)}</textarea>
          </div>
          <div class="field">
            <label>å„ªå…ˆåº¦ï¼ˆ1ã€œ3ï¼‰</label>
            <select data-field="priority">
              ${[1,2,3].map(v=>`<option value="${v}" ${v===pri?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label>æœŸé™</label>
            <input type="datetime-local" data-field="due_at" value="${dueISO}">
          </div>
          <div class="field">
            <label>ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆ1ä»¶ç›®ï¼‰</label>
            <input type="datetime-local" data-field="remind_0" value="${r0}">
          </div>
          <div class="detailBar">
            <button class="saveBtn" data-act="save" data-id="${t.id}">ä¿å­˜</button>
            <button class="btn" data-act="close" data-id="${t.id}">âœ• é–‰ã˜ã‚‹</button>
          </div>
        </div>
      </div>`;
    }

    function escapeHTML(s){
      return String(s||"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]))
    }

    function render(){
      const {active,completed} = splitByStatus(gAllTasks);
      const a = sortTasks(active);
      const c = sortTasks(completed);

      $activeList.innerHTML   = a.map(cardHTML).join("");
      $completedList.innerHTML= c.map(cardHTML).join("");
      $empty.hidden = a.length + c.length > 0;

      // ã‚¹ãƒ¯ã‚¤ãƒ—ã®ãƒã‚¤ãƒ³ãƒ‰ï¼ˆå·¦å³ï¼‰
      [...document.querySelectorAll(".swipe-wrap")].forEach(bindSwipeCard);

      // ã‚¿ãƒƒãƒ—ã§è©³ç´°é–‹é–‰ï¼ˆtracké ˜åŸŸã®ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ï¼‰
      [...document.querySelectorAll(".track")].forEach(track=>{
        track.addEventListener('click', e=>{
          const wrap = track.closest('.swipe-wrap');
          openDetailFor(wrap.dataset.id, /*toggle*/ true);
        });
      });

      // å³å´ã€Œè©³ç´°ã€ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³
      document.querySelectorAll('.btn[data-act="detail"]').forEach(b=>{
        b.onclick = ()=>{
          const wrap = b.closest('.swipe-wrap');
          openDetailFor(wrap.dataset.id, /*toggle*/ true);
        };
      });
      document.querySelectorAll('.btn[data-act="delete"]').forEach(b=>{
        b.onclick = async ()=>{
          const wrap = b.closest('.swipe-wrap');
          const id = wrap.dataset.id;
          const ok = confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
          if (!ok) return;
          await runAction(id,'delete');
        };
      });
      // å·¦å´ã€Œå®Œäº†ã€ãƒœã‚¿ãƒ³
      document.querySelectorAll('.btn[data-act="complete"]').forEach(b=>{
        b.onclick = async ()=>{
          const wrap = b.closest('.swipe-wrap');
          await runAction(wrap.dataset.id,'complete');
        };
      });
      // è©³ç´°ä¿å­˜/é–‰ã˜ã‚‹
      document.querySelectorAll('.saveBtn[data-act="save"]').forEach(b=>{
        b.onclick = ()=>saveDetail(b.dataset.id);
      });
      document.querySelectorAll('.btn[data-act="close"]').forEach(b=>{
        b.onclick = ()=>openDetailFor(b.dataset.id,false);
      });
    }

    function openDetailFor(taskId, toggle){
      if (toggle && gOpenDetailId === taskId){
        // æ—¢ã«é–‹ã„ã¦ã„ã‚‹ â†’ é–‰ã˜ã‚‹
        const cur = document.getElementById(`detail-${taskId}`);
        cur?.classList.remove('open');
        gOpenDetailId = null;
        return;
      }
      // ä»–ã®ã‚’é–‰ã˜ã‚‹
      if (gOpenDetailId){
        const prev = document.getElementById(`detail-${gOpenDetailId}`);
        prev?.classList.remove('open');
      }
      // å¯¾è±¡ã‚’é–‹ã
      const el = document.getElementById(`detail-${taskId}`);
      if (el){ el.classList.add('open'); gOpenDetailId = taskId; }
    }

    async function saveDetail(taskId){
      const root = document.getElementById(`detail-${taskId}`);
      if (!root) return;
      const get = (sel)=> root.querySelector(sel);
      const detail  = get('textarea[data-field="detail"]').value;
      const priority= parseInt(get('select[data-field="priority"]').value||'1',10);
      const due     = get('input[data-field="due_at"]').value;      // yyyy-MM-ddTHH:mm
      const r0      = get('input[data-field="remind_0"]').value;

      const fields = {
        detail,
        priority,
        due_at: due ? new Date(due).toISOString() : null,
        remind_times: r0 ? [new Date(r0).toISOString()] : []
      };
      try{
        const r = await fetch(ACTION_API_URL,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'update', task_id: taskId, user_id:gUserId, fields })
        });
        const j = await r.json().catch(()=>({ok:false}));
        if(!r.ok || j.ok===false) throw new Error(j.message||'update failed');
        toast('ä¿å­˜ã—ã¾ã—ãŸ');
        openDetailFor(taskId,false);
        await loadTasks(gUserId);
      }catch(e){
        console.error(e); toast('ã‚¨ãƒ©ãƒ¼: '+(e.message||'failed'));
      }
    }

    async function runAction(id, action){
      try{
        if (action === 'delete'){
          // ã“ã“ã«ã¯æ¥ãªã„ãŒäºŒé‡å®‰å…¨
          const ok = confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
          if(!ok) return;
        }
        const res = await fetch(ACTION_API_URL,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action, task_id:id, user_id:gUserId })
        });
        const j = await res.json().catch(()=>({ok:false}));
        if(!res.ok || j.ok===false) throw new Error(j.message||'action failed');
        const label = ({complete:'å®Œäº†',delete:'å‰Šé™¤'})[action] || action;
        toast(label+'ã—ã¾ã—ãŸ');
        await loadTasks(gUserId);
      }catch(err){
        console.error(err); toast('ã‚¨ãƒ©ãƒ¼: '+(err.message||'failed'));
      }
    }

    // ===== ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå·¦å³ï¼‰ =====
    function bindSwipeCard(wrap){
      const track = wrap.querySelector('.track');
      const leftSide  = wrap.querySelector('.side-left');
      const rightSide = wrap.querySelector('.side-right');

      // å·¦éœ²å‡ºé‡ = å·¦ãƒœã‚¿ãƒ³ç¾¤ã®å¹… + ã‚«ãƒ¼ãƒ‰å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨åŒç­‰ã®è¦‹ãŸç›®ä½™ç™½
      const leftExpose = calcExpose(leftSide);
      const rightExpose= calcExpose(rightSide);

      let sx=0, dx=0, active=false, t0=0; // for velocity
      let dragging=false;

      const onStart = (x)=>{
        active=true; dragging=false; sx=x; dx=0; t0=performance.now();
        track.style.transition='none';
      };
      const onMove = (x)=>{
        if(!active) return;
        const nx = x - sx;
        // æ¨ªæ–¹å‘ã‚’å„ªå…ˆã—ã™ããšã€ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯é˜»å®³ã—ãªã„ï¼ˆã—ãã„å€¤ä½ã‚ï¼‰
        if (!dragging && Math.abs(nx) > 8) dragging=true;
        if (!dragging) return;

        dx = nx;
        // éœ²å‡ºã‚’è¶…ãˆãŸæ™‚ã¯ãƒœã‚¿ãƒ³ãŒã—ã£ã‹ã‚Šè¦‹ãˆã‚‹ã‚ˆã†ã«å¾ã€…ã«æ¸›è¡°
        track.style.transform = `translateX(${dx}px)`;
      };
      const onEnd = ()=>{
        if(!active) return;
        const dt = (performance.now()-t0)/1000; // sec
        const vx = dt>0 ? dx/dt : 0;            // px/s
        // ã—ãã„å€¤
        const SNAP = 0.35;     // ã‚¹ãƒŠãƒƒãƒ—ã®å„ªå…ˆåº¦ï¼ˆ0..1ï¼‰ä½ã„ã»ã©ã‚¹ãƒŠãƒƒãƒ—ã—ã‚„ã™ã„
        const FAST = 850;      // ã“ã®é€Ÿåº¦ã‚’è¶…ãˆãŸã‚‰å³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

        // éœ²å‡º/ç¢ºå®šé–¾å€¤
        const L_EXPOSE =  leftExpose;           // å·¦ãƒœã‚¿ãƒ³ãŒã—ã£ã‹ã‚Šè¦‹ãˆã‚‹ä½ç½®
        const L_COMMIT =  L_EXPOSE * (1+SNAP);  // ã•ã‚‰ã«æŠ¼ã—è¾¼ã‚€ã¨å³ã€Œå®Œäº†ã€
        const R_EXPOSE = -rightExpose;
        const R_COMMIT = R_EXPOSE * (1+SNAP);   // ã•ã‚‰ã«æŠ¼ã—è¾¼ã‚€ã¨å³ã€Œå‰Šé™¤ã€

        let snapTo = 0;
        let doAct = null;

        if (dx > 0){ // å³â†’å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå·¦å´éœ²å‡ºï¼šå®Œäº†ï¼‰
          if (dx >= L_COMMIT || vx > FAST){
            doAct = 'complete';
          }else if (dx >= L_EXPOSE){
            snapTo = L_EXPOSE; // ã‚¹ãƒŠãƒƒãƒ—ã—ã¦ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§ãã‚‹
          }
        }else if (dx < 0){ // å·¦â†’å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå³å´éœ²å‡ºï¼šè©³ç´°/å‰Šé™¤ï¼‰
          if (dx <= R_COMMIT || vx < -FAST){
            // å³å´ã¯å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ã§å³ã€Œå‰Šé™¤ã€
            const ok = confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
            if (ok) doAct = 'delete';
          }else if (dx <= R_EXPOSE){
            snapTo = R_EXPOSE; // ãƒœã‚¿ãƒ³æ“ä½œãƒ¢ãƒ¼ãƒ‰
          }
        }

        track.style.transition='transform .18s ease';
        if (doAct){
          track.style.transform='translateX(0)';
          runAction(wrap.dataset.id, doAct);
        }else if (snapTo !== 0){
          track.style.transform = `translateX(${snapTo}px)`;
        }else{
          track.style.transform='translateX(0)';
        }

        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å§”è­²ï¼ˆã‚¹ãƒŠãƒƒãƒ—ä¸­ã«æŠ¼ã›ã‚‹ï¼‰
        bindActionButtonsWhileSnapped(wrap, snapTo);

        active=false; dragging=false; dx=0;
      };

      // ã‚¿ãƒƒãƒ & ãƒã‚¦ã‚¹
      track.addEventListener('touchstart', e=>onStart(e.touches[0].clientX), {passive:true});
      track.addEventListener('touchmove',  e=>onMove(e.touches[0].clientX),  {passive:true});
      track.addEventListener('touchend',   onEnd);
      track.addEventListener('mousedown',  e=>onStart(e.clientX));
      track.addEventListener('mousemove',  e=>{ if(e.buttons===1) onMove(e.clientX); });
      track.addEventListener('mouseup',    onEnd);

      // éœ²å‡ºé‡ï¼ˆå·¦å³ãƒœã‚¿ãƒ³ç¾¤ã®å¹… + è¦‹ãŸç›®ä½™ç™½ï¼‰ã‚’è¨ˆç®—
      function calcExpose(sideEl){
        if (!sideEl) return 96; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const w = sideEl.getBoundingClientRect().width; // ãƒœã‚¿ãƒ³ç¾¤ã®å¹…
        // å·¦ç«¯ä½™ç™½ = ã‚«ãƒ¼ãƒ‰ã®padding-left ã¨åŒç­‰ã«è¦‹ã›ãŸã„ã®ã§ var(--padX) ã‚’åˆ©ç”¨
        // getComputedStyle ã§ px å–å¾—
        const padX = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--padX')) || 14;
        const gap  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'))  || 8;
        // éœ²å‡ºå¹… = ãƒœã‚¿ãƒ³ç¾¤ã®å¹… + å·¦å³ã®ä½™ç™½ï¼ˆpadX/gapï¼‰
        return Math.round(w + padX + gap);
      }

      function bindActionButtonsWhileSnapped(wrap, snapTo){
        // ã‚¹ãƒŠãƒƒãƒ—ã—ã¦ã„ã‚‹é–“ã¯ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¯èƒ½ã€‚æˆ»ã—ãŸã‚‰è§£é™¤ã¯ä¸è¦ï¼ˆè‡ªç„¶ã«OKï¼‰
        if (snapTo > 0){
          const c = wrap.querySelector('.btn.ok');
          if (c) c.onclick = ()=> runAction(wrap.dataset.id,'complete');
        }else if (snapTo < 0){
          const d = wrap.querySelector('.btn.danger');
          const det = wrap.querySelector('.side-right .btn:not(.danger)');
          if (det) det.onclick = ()=> openDetailFor(wrap.dataset.id, true);
          if (d) d.onclick = async ()=>{
            const ok = confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
            if(ok) await runAction(wrap.dataset.id,'delete');
          };
        }
      }
    }
    // =====================

    async function loadTasks(userId){
      try{
        const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
        const res = await fetch(url, {method:'GET', credentials:'omit', headers:{'Content-Type':'application/json'}});
        const payload = await res.json();
        if (!res.ok || !payload || payload.ok!==true) throw new Error('load failed');
        const active    = Array.isArray(payload.active)?payload.active:[];
        const completed = Array.isArray(payload.completed)?payload.completed:[];
        gAllTasks = [...active, ...completed];
        render();
      }catch(e){
        console.error(e); toast('èª­ã¿è¾¼ã¿å¤±æ•—');
      }
    }

    async function bootstrap(){
      console.log('LIST build: 2025-11-03_17:20');
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();
      const prof = await liff.getProfile();
      gUserId = prof.userId;
      $("#user-pill").textContent = "You: " + gUserId.slice(-6);

      $("#reload").onclick = ()=> loadTasks(gUserId);
      $("#q").addEventListener('input', e=>{
        const q = e.target.value.trim().toLowerCase();
        if (!q){ render(); return; }
        const filtered = gAllTasks.filter(t=>
          (t.title||"").toLowerCase().includes(q) || (t.detail||"").toLowerCase().includes(q)
        );
        const {active,completed} = splitByStatus(filtered);
        const a = sortTasks(active), c = sortTasks(completed);
        $activeList.innerHTML   = a.map(cardHTML).join("");
        $completedList.innerHTML= c.map(cardHTML).join("");
        $empty.hidden = a.length + c.length > 0;
        [...document.querySelectorAll(".swipe-wrap")].forEach(bindSwipeCard);
      });

      await loadTasks(gUserId);
    }
    bootstrap();
  </script>
</body>
</html>
