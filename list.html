<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LISTï½œã‚¿ã‚¹ã‚¯</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
      --left-ok-bg:#ecfdf5;        /* å®Œäº†ï¼ˆç·‘ï¼‰å¸¯ */
      --left-warn-bg:#fffbeb;      /* æœªå®Œäº†ï¼ˆé»„ï¼‰å¸¯ï¼šå®Œäº†â†’æœªå®Œäº†ã«æˆ»ã™æ™‚ */
      --right-bg:#fef2f2;          /* å³å´å¸¯ï¼ˆå‰Šé™¤å´ï¼‰ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    header{
      position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--line); z-index:10;
    }
    .bar{display:flex; align-items:center; gap:8px; justify-content:space-between; padding:12px 16px;}
    .title{font-weight:650; letter-spacing:.2px}
    .pill{padding:6px 10px; border-radius:999px; background:var(--pill); font-size:12px}
    main{padding:14px; max-width:720px; margin:0 auto}

    .section{margin:18px 0}
    .section h3{margin:8px 6px 10px; font-size:13px; color:var(--sub); font-weight:600}

    /* ---- swipe container ---- */
    .swipe-wrap{
      position:relative; border-radius:16px; margin:10px 0; overflow:hidden;
      border:1px solid var(--line); box-shadow:0 1px 0 rgba(0,0,0,.03);
      background:linear-gradient(90deg, var(--left-ok-bg) 0 50%, var(--right-bg) 50% 100%); /* æ—¢å®šï¼šå·¦=ç·‘ç³» */
      background-size:200% 100%;
      background-position:50% 0; /* ä¸­å¤®ï¼ˆä¸¡å´éš ã—ï¼‰ */
    }
    /* å®Œäº†ã‚¢ã‚¤ãƒ†ãƒ ã¯å·¦å¸¯ã‚’é»„è‰²ã«å¤‰æ›´ï¼ˆæœªå®Œäº†ã¸æˆ»ã™ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¤ºã™ï¼‰ */
    .swipe-wrap.left-warn{
      background:linear-gradient(90deg, var(--left-warn-bg) 0 50%, var(--right-bg) 50% 100%);
      background-size:200% 100%;
      background-position:50% 0;
    }

    .actions{
      position:absolute; inset:0; display:flex; justify-content:space-between; align-items:center;
      padding:0 8px; pointer-events:none;  /* ãƒ‡ãƒ•ã‚©ã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯ */
    }
    .actions .left, .actions .right{display:flex; gap:8px}
    .btn{
      pointer-events:auto; padding:8px 10px; border-radius:10px;
      border:1px solid var(--line); background:#fff; font-size:12px; user-select:none;
    }
    .btn.ok{border-color:#c7ecd1; color:var(--ok);}                /* å®Œäº†ï¼ˆç·‘ãƒœã‚¿ãƒ³ï¼‰ */
    .btn.uncomplete{border-color:#fde68a; color:var(--warn);}      /* æœªå®Œäº†ï¼ˆé»„ãƒœã‚¿ãƒ³ï¼‰ */
    .btn.info{border-color:#dbeafe; color:#2563eb;}                /* è©³ç´°ï¼ˆé’ï¼‰ */
    .btn.danger{border-color:#fecaca; color:var(--danger);}        /* å‰Šé™¤ï¼ˆèµ¤ï¼‰ */

    .track{position:relative; background:var(--card); touch-action:pan-y; will-change:transform;}
    .card{padding:12px 14px;}
    .row{display:flex; align-items:center; gap:8px}
    .titleTxt{flex:1; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta{display:flex; gap:8px; color:var(--sub); font-size:12px}
    .chip{padding:2px 8px; border-radius:999px; border:1px solid var(--line)}
    .ghost .titleTxt{opacity:.45} /* å®Œäº†ã¯æ–‡å­—ã ã‘è–„ãã€‚èƒŒæ™¯ã¯é€æ˜ã«ã—ãªã„ */

    /* è©³ç´°ãƒ“ãƒ¥ãƒ¼ */
    .detail{max-height:0; overflow:hidden; transition:max-height .24s ease, padding .24s ease, border .24s ease;
      padding:0 14px; border-top:1px solid transparent; background:#fff; position:relative;}
    .detail.open{padding:10px 14px 14px; border-top:1px solid var(--line);}
    .detail .grid{display:grid; grid-template-columns:96px 1fr; gap:8px 10px; align-items:center}
    .detail label{font-size:12px; color:var(--sub)}
    .detail input,.detail select,.detail textarea{
      width:100%; padding:8px 10px; border:1px solid var(--line);
      border-radius:10px; font:inherit; background:#fff;
    }
    .detail textarea{min-height:72px; resize:vertical}
    .detail .rowBtns{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
    .x-close{position:absolute; right:10px; top:8px; font-size:18px; color:#999; cursor:pointer;}

    .toolbar{display:flex; gap:8px; padding:8px}
    .toolbar input{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .toolbar button{padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff}

    .empty{color:var(--sub); text-align:center; padding:36px 12px}
    .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff;
      padding:10px 14px; border-radius:999px; font-size:13px; opacity:0; transition:.25s; z-index:50;}
    .toast.show{opacity:1}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div class="toolbar">
    <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰"/>
    <button id="reload">å†èª­è¾¼</button>
  </div>

  <div id="active" class="section">
    <h3>ğŸ“ ã‚¿ã‚¹ã‚¯</h3>
    <div id="active-list"></div>
  </div>

  <div id="completed" class="section">
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
</main>
<div id="toast" class="toast"></div>

<script>
const LIFF_ID="2008311584-NdJqOqMn";
const LIST_API_URL="https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL="https://lumicreate.xvps.jp/webhook/webhook-action";
let gUserId=null,gAllTasks=[];

const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const toast=m=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1400);}
const fmtJST=i=>!i?"":new Date(i).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});
const esc=s=>String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));

function sortTasks(a){return a.slice().sort((x,y)=>y.priority-x.priority||new Date(x.created_at)-new Date(y.created_at));}
function splitTasks(all){
  const now=Date.now(),week=now-7*864e5,ac=[],co=[];
  for(const t of all){
    if(t.status==="completed"){
      const c=new Date(t.completed_at||0).getTime();
      if(c>week) co.push(t);
    }else ac.push(t);
  }
  return{ac,co};
}

function cardHTML(t){
  const due=fmtJST(t.due_at),isC=t.status==="completed",act=isC?"uncomplete":"complete",lab=isC?"æœªå®Œäº†":"å®Œäº†",cls=isC?"uncomplete":"ok";
  const leftWrapClass=isC?'swipe-wrap left-warn':'swipe-wrap';
  return `<div class="${leftWrapClass}" data-id="${t.id}">
    <div class="actions">
      <div class="left"><button class="btn ${cls}" data-act="${act}">${lab}</button></div>
      <div class="right">
        <button class="btn info" data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track ${isC?'ghost':''}">
      <div class="card">
        <div class="row">
          <div class="titleTxt">${esc(t.title)||"(ç„¡é¡Œ)"}</div>
          <div class="meta">
            <span class="chip">â˜…${t.priority}</span>
            <span class="chip">â° ${esc(due)}</span>
          </div>
        </div>
      </div>
      <div class="detail" aria-hidden="true">
        <span class="x-close" title="é–‰ã˜ã‚‹">Ã—</span>
        <div class="grid">
          <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
          <textarea name="detail"></textarea>
          <label>å„ªå…ˆåº¦</label>
          <select name="priority">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
          <label>æœŸé™</label>
          <input type="datetime-local" name="due_at"/>
          <label>ãƒªãƒã‚¤ãƒ³ãƒ‰</label>
          <input type="datetime-local" name="remind_at"/>
        </div>
        <div class="rowBtns">
          <button class="btn info" data-act="save">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>`;
}

/* ------- Swipe logic (è»½ã„=ã‚¹ãƒŠãƒƒãƒ—/å¼·ã„=å³å®Ÿè¡Œ) ------- */
const SW_LIGHT=40;     // éœ²å‡ºé–‹å§‹ã®ã—ãã„å€¤
const SW_STRONG=140;   // å³å®Ÿè¡Œã®ã—ãã„å€¤
const SNAP_X=96;       // ã‚¹ãƒŠãƒƒãƒ—ä½ç½®ï¼ˆãƒœã‚¿ãƒ³ãŒè§¦ã‚Œã‚‹ã ã‘éœ²å‡ºï¼‰
const RETURN_MS=180;   // ã‚¢ãƒ‹ãƒ¡æˆ»ã—æ™‚é–“
function bindSwipe(track){
  const wrap=track.parentElement;
  const actions=wrap.querySelector(".actions");
  let sx=0,dx=0,active=false,downTime=0,lastX=0,lastT=0,snapped=false;

  const setBgPos=(x)=>{
    const w=wrap.clientWidth||1;
    const ratio=Math.max(-1,Math.min(1,x/(w*0.6)));
    wrap.style.backgroundPosition = `${50+ratio*50}% 0`;
  };

  const snapTo=(x)=>{
    track.style.transition=`transform ${RETURN_MS}ms ease`;
    track.style.transform=`translateX(${x}px)`;
    setBgPos(x);
    snapped=(x!==0);
  };

  const endTo=(x)=>{
    track.style.transition=`transform ${RETURN_MS}ms ease`;
    track.style.transform=`translateX(${x}px)`;
    setBgPos(x);
    setTimeout(()=>{ track.style.transition=""; }, RETURN_MS);
  };

  const start=(x)=>{
    active=true; sx=x; dx=0; downTime=performance.now(); lastX=x; lastT=downTime; snapped=false;
    track.style.transition="none";
  };
  const move=(x)=>{
    if(!active) return;
    dx=x-sx;
    track.style.transform=`translateX(${dx}px)`;
    setBgPos(dx);
    actions.style.pointerEvents="auto";
    lastX=x; lastT=performance.now();
  };
  const end=()=>{
    if(!active) return;
    const upT=performance.now();
    const dt=Math.max(1,upT-lastT);
    const vx=(lastX - sx)/Math.max(1, (upT - downTime)); // px/ms
    const speed=Math.abs(vx);

    // å¼·ã„ã‚¹ãƒ¯ã‚¤ãƒ— or å¤§ç§»å‹• â†’ å³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    if (dx > SW_STRONG || (dx > SW_LIGHT && speed > 0.8)) {
      endTo(0);
      onAction(wrap, wrap.querySelector('.btn[data-act]').dataset.act /* just placeholder */);
      // ä¸Šã®placeholderã ã¨å¸¸ã«å·¦æœ€åˆã®btnã®actã«ãªã£ã¦ã—ã¾ã†ã®ã§åˆ†å²:
      onAction(wrap, (wrap.querySelector('.track').classList.contains('ghost') ? 'uncomplete' : 'complete'));
      cleanup();
      return;
    }
    if (dx < -SW_STRONG || (dx < -SW_LIGHT && speed > 0.8)) {
      endTo(0);
      onAction(wrap,'delete');
      cleanup();
      return;
    }

    // è»½ã„ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ã‚¹ãƒŠãƒƒãƒ—
    if (dx > SW_LIGHT) { snapTo(+SNAP_X); return; }
    if (dx < -SW_LIGHT){ snapTo(-SNAP_X); return; }

    // ã—ãã„å€¤æœªæº€ â†’ æˆ»ã™
    endTo(0);
    cleanup();
  };

  const cleanup=()=>{ active=false; dx=0; actions.style.pointerEvents="auto"; };

  // ã‚¿ãƒƒãƒ—ã§æˆ»ã™ï¼ˆã‚¹ãƒŠãƒƒãƒ—çŠ¶æ…‹ã§ãƒˆãƒ©ãƒƒã‚¯è‡ªä½“ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰æˆ»ã™ï¼‰
  track.addEventListener('click', e=>{
    if (snapped){
      e.stopPropagation();
      snapped=false;
      endTo(0);
    }
  });

  // touch
  track.addEventListener('touchstart', e=>start(e.touches[0].clientX), {passive:true});
  track.addEventListener('touchmove',  e=>move(e.touches[0].clientX),  {passive:true});
  track.addEventListener('touchend',   end);

  // mouseï¼ˆé–‹ç™ºç”¨ï¼‰
  track.addEventListener('mousedown', e=>start(e.clientX));
  track.addEventListener('mousemove', e=>{ if(e.buttons===1) move(e.clientX); });
  track.addEventListener('mouseup',   end);
}

/* -------- Actions & Detail ---------- */
async function onAction(wrap, act){
  const id=wrap.dataset.id;
  if (act==='delete'){
    if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  }
  if (act==='detail'){
    openDetail(wrap);
    return;
  }
  // save ã¯è©³ç´°ãƒ“ãƒ¥ãƒ¼å†…ã®ä¿å­˜ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã¶ã®ã§ã“ã“ã§ã¯æ‰±ã‚ãªã„
  const res=await fetch(ACTION_API_URL,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:act, task_id:id, user_id:gUserId})
  });
  let j={ok:false};
  try{ j=await res.json(); }catch{}
  if(!res.ok || j.ok===false){ toast('ã‚¨ãƒ©ãƒ¼'); return; }
  toast(({complete:'å®Œäº†', uncomplete:'æœªå®Œäº†ã¸æˆ»ã—', delete:'å‰Šé™¤'})[act]||'OK');
  await loadTasks(gUserId);
}

function openDetail(wrap){
  // ä»–ã®é–‹ã„ã¦ã„ã‚‹è©³ç´°ã‚’é–‰ã˜ã‚‹
  $$('.detail.open').forEach(d=>{ d.classList.remove('open'); d.style.maxHeight=0; });
  const detail=wrap.querySelector('.detail');
  // åˆæœŸå€¤ã‚’åŸ‹ã‚ã‚‹ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒ gAllTasks ã«ã‚ã‚‹å‰æï¼‰
  const id=wrap.dataset.id;
  const t=gAllTasks.find(x=>x.id===id)||{};
  const ta=detail.querySelector('textarea[name="detail"]');
  const pr=detail.querySelector('select[name="priority"]');
  const du=detail.querySelector('input[name="due_at"]');
  const rm=detail.querySelector('input[name="remind_at"]');

  ta.value = t.detail || '';
  pr.value = String(t.priority ?? 1);

  const toLocal=(iso)=>{
    if(!iso) return '';
    const d=new Date(iso);
    const tzOff=-d.getTimezoneOffset(); // min
    const d2=new Date(d.getTime()+tzOff*60*1000);
    return d2.toISOString().slice(0,16);
  };
  du.value = toLocal(t.due_at);
  rm.value = Array.isArray(t.remind_times)&&t.remind_times[0]?toLocal(t.remind_times[0]):'';

  detail.classList.add('open');
  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é«˜ã•ã«ã‚¹ãƒ ãƒ¼ã‚ºã«é–‹ã
  requestAnimationFrame(()=>{
    detail.style.maxHeight = detail.scrollHeight + 20 + 'px';
  });

  // Ã— ãƒœã‚¿ãƒ³
  detail.querySelector('.x-close').onclick=()=>closeDetail(detail);
}

function closeDetail(detail){
  detail.classList.remove('open');
  detail.style.maxHeight=0;
}

function wireDetailInteractions(scope){
  // è©³ç´°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  scope.querySelectorAll('.btn[data-act="detail"]').forEach(b=>{
    b.onclick=(e)=>{ e.stopPropagation(); openDetail(b.closest('.swipe-wrap')); };
  });
  // ä¿å­˜ãƒœã‚¿ãƒ³
  scope.querySelectorAll('.btn[data-act="save"]').forEach(b=>{
    b.onclick=async(e)=>{
      e.stopPropagation();
      const wrap=b.closest('.swipe-wrap');
      const id=wrap.dataset.id;
      const d=wrap.querySelector('.detail');
      const ta=d.querySelector('textarea[name="detail"]').value.trim();
      const pr=Number(d.querySelector('select[name="priority"]').value);
      const du=d.querySelector('input[name="due_at"]').value;
      const rm=d.querySelector('input[name="remind_at"]').value;
      const toISO=(loc)=> loc ? new Date(loc).toISOString() : null;

      const fields={
        detail:ta,
        priority: Number.isFinite(pr)?pr:1,
        due_at: du?toISO(du):null,
        remind_times: rm?[toISO(rm)]:[]
      };

      const res=await fetch(ACTION_API_URL,{
        method:"POST", headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'update', task_id:id, user_id:gUserId, fields})
      });
      let j={ok:false}; try{ j=await res.json(); }catch{}
      if(!res.ok || j.ok===false){ toast('ã‚¨ãƒ©ãƒ¼'); return; }
      toast('ä¿å­˜ã—ã¾ã—ãŸ');
      await loadTasks(gUserId);
    };
  });

  // ã‚¿ã‚¹ã‚¯ãƒãƒ¼æœ¬ä½“ã‚¿ãƒƒãƒ—ã§é–‹é–‰ãƒˆã‚°ãƒ«
  scope.querySelectorAll('.track').forEach(tr=>{
    tr.onclick=(e)=>{
      // ã‚¹ãƒŠãƒƒãƒ—è§£é™¤ã®ã‚¯ãƒªãƒƒã‚¯ã¯ bindSwipe å†…ã§å‡¦ç†æ¸ˆã¿
      if (e.defaultPrevented) return;
      const detail=tr.querySelector('.detail');
      if (detail.classList.contains('open')) closeDetail(detail);
      else openDetail(tr.closest('.swipe-wrap'));
    };
  });

  // è©³ç´°ä»¥å¤–ã‚’ã‚¿ãƒƒãƒ—ã§é–‹ã„ã¦ã„ã‚‹è©³ç´°ã‚’é–‰ã˜ã‚‹
  document.addEventListener('click', (e)=>{
    const anyOpen=document.querySelector('.detail.open');
    if(!anyOpen) return;
    // detail å†…ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
    if (anyOpen.contains(e.target)) return;
    // ãƒœã‚¿ãƒ³é¡ã¯ç„¡è¦–ï¼ˆå‰Šé™¤/å®Œäº†ãªã©ï¼‰
    if ((e.target.closest && e.target.closest('.btn')) || (e.target.closest && e.target.closest('.actions'))) return;
    closeDetail(anyOpen);
  });
}

async function loadTasks(uid){
  const r=await fetch(`${LIST_API_URL}?user_id=${encodeURIComponent(uid)}`);
  const j=await r.json();
  gAllTasks=[...(j.active||[]),...(j.completed||[])];
  render();
}

function render(){
  const {ac,co}=splitTasks(gAllTasks);
  const actHTML=sortTasks(ac).map(cardHTML).join("");
  const comHTML=sortTasks(co).map(cardHTML).join("");
  $("#active-list").innerHTML=actHTML;
  $("#completed-list").innerHTML=comHTML;

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå®Œäº†/æœªå®Œäº†/å‰Šé™¤ï¼‰
  $$('.btn[data-act]').forEach(b=>{
    const act=b.dataset.act;
    if (act==='detail' || act==='save') return; // ã“ã‚Œã‚‰ã¯åˆ¥ãƒãƒ³ãƒ‰ãƒ©
    b.onclick=async()=>{
      const wrap=b.closest('.swipe-wrap');
      await onAction(wrap, act);
    };
  });

  // ã‚¹ãƒ¯ã‚¤ãƒ—ä»˜ä¸
  $$('.track').forEach(bindSwipe);

  // è©³ç´°å‘¨ã‚Š
  wireDetailInteractions(document);
}

async function bootstrap(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
  const p=await liff.getProfile();
  gUserId=p.userId; $("#user-pill").textContent="You: "+gUserId.slice(-6);
  $("#reload").onclick=()=>loadTasks(gUserId);

  // æ¤œç´¢
  $("#q").addEventListener("input",(e)=>{
    const q=e.target.value.trim().toLowerCase();
    const {ac,co}=splitTasks(gAllTasks);
    const filt = t => (t.title||'').toLowerCase().includes(q) || (t.detail||'').toLowerCase().includes(q);
    $("#active-list").innerHTML=sortTasks(ac.filter(filt)).map(cardHTML).join("");
    $("#completed-list").innerHTML=sortTasks(co.filter(filt)).map(cardHTML).join("");
    $$('.track').forEach(bindSwipe);
    wireDetailInteractions(document);
  });

  await loadTasks(gUserId);
}
bootstrap();
</script>
</body>
</html>
