<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LISTï½œã‚¿ã‚¹ã‚¯</title>
  <style>
    :root{
      --bg:#f7f7f8;--card:#fff;--ink:#111;--sub:#666;--line:#e9e9ec;
      --pill:#eef2ff;--accent:#3957ff;--ok:#16a34a;--warn:#eab308;--danger:#ef4444;
      --shadow:0 1px 0 rgba(0,0,0,.03);
      --snap:84px; /* ãƒœã‚¿ãƒ³ãŒã—ã£ã‹ã‚Šè¦‹ãˆã‚‹éœ²å‡ºé‡ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
    }
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px}
    .title{font-weight:650;letter-spacing:.2px}
    .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px}
    main{padding:14px;max-width:720px;margin:0 auto}
    .section{margin:18px 0}
    .section h3{margin:8px 6px 10px;font-size:13px;color:var(--sub);font-weight:600}
    .empty{color:var(--sub);text-align:center;padding:36px 12px}

    /* ã‚«ãƒ¼ãƒ‰ */
    .card{
      position:relative;background:var(--card);border:1px solid var(--line);
      border-radius:16px;margin:10px 0;box-shadow:var(--shadow)
    }
    .swipe-wrap{position:relative;overflow:hidden;border-radius:16px}
    .actions{
      position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;
      padding:0 8px;pointer-events:none; /* éœ²å‡ºæ™‚ã ã‘ auto ã«åˆ‡æ›¿ */
      background:transparent;
    }
    .btn{
      pointer-events:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--line);
      background:#fff;font-size:12px
    }
    .btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
    .btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
    .btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}

    .track{
      position:relative;touch-action:pan-y;background:var(--card);
      -webkit-touch-callout:none;-webkit-user-select:none;user-select:none;
    }
    .row{display:flex;align-items:center;gap:8px;padding:12px 14px}
    .titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
    .pill-sm{padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .ghost{opacity:.45}

    /* éœ²å‡ºçŠ¶æ…‹ã§ã ã‘ãƒœã‚¿ãƒ³ã‚’è§¦ã‚Œã‚‹ */
    .swipe-wrap.open-left .actions,
    .swipe-wrap.open-right .actions{pointer-events:auto}

    /* è©³ç´°ãƒ‘ãƒãƒ« */
    .detail{
      border-top:1px dashed var(--line);padding:10px 14px;display:none;background:#fff
    }
    .detail.open{display:block}
    .detail-grid{
      display:grid;gap:10px;grid-template-columns:1fr 1fr
    }
    .detail-grid .full{grid-column:1 / -1}
    .detail label{font-size:12px;color:var(--sub);display:block;margin-bottom:4px}
    .detail input,.detail select,.detail textarea{
      width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit
    }
    .detail textarea{min-height:72px;resize:vertical}
    .detail-bar{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .x-close{
      position:absolute;right:10px;top:10px;border:1px solid var(--line);background:#fff;border-radius:999px;
      width:28px;height:28px;display:grid;place-items:center;font-size:14px;cursor:pointer
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
    .toast.show{opacity:1}

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ï¼ˆåˆå›ç”¨ã ã£ãŸã‚‰ï¼‰ */
    .skeleton{height:60px;border-radius:16px;border:1px solid var(--line);
      background:linear-gradient(90deg,#f5f5f7,#eee,#f5f5f7);background-size:200% 100%;animation:s 1.1s linear infinite}
    @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div class="section" id="active">
    <h3>ğŸ“ ã‚¿ã‚¹ã‚¯</h3>
    <div id="active-list"></div>
  </div>

  <div class="section" id="completed">
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<pre id="debug" style="white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;margin:8px;border-radius:8px;"></pre>
<div id="toast" class="toast"></div>

<script>
/** =================== è¨­å®š =================== */
const LIFF_ID = "2008311584-NdJqOqMn"; // â† ã‚ãªãŸã®LIFF ID
const LIST_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-list";   // n8n: LIST (GET)
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action"; // n8n: ACTION (POST)
/** ============================================ */

let gUserId = null;
let gAllTasks = []; // pinnedå»ƒæ­¢ã€‚active/completedã®ã¿æ‰±ã†
let gOpenDetailId = null; // åŒæ™‚ã«1ä»¶ã ã‘é–‹ã

const $ = (s)=>document.querySelector(s);
const $activeList = $("#active-list");
const $completedList = $("#completed-list");
const $completed = $("#completed");
const $empty = $("#empty");

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function dbg(...a){ const el=$("#debug"); if(!el) return; el.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')+'\n'; }
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function fmtJST(iso){ if(!iso) return ""; const d=new Date(iso); return d.toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}); }
function isRecentCompleted(t){ if(!t.completed_at) return false; const wk = Date.now()-7*24*3600*1000; return new Date(t.completed_at).getTime()>=wk; }

/* ===== ã‚½ãƒ¼ãƒˆ: priority desc â†’ position asc ===== */
function sortTasks(arr){
  return arr.slice().sort((a,b)=>{
    const ap = Number.isFinite(a.priority)?a.priority:0;
    const bp = Number.isFinite(b.priority)?b.priority:0;
    if (bp!==ap) return bp-ap; // priorityé™é †
    const apos = Number.isFinite(a.position)?a.position:0;
    const bpos = Number.isFinite(b.position)?b.position:0;
    return apos-bpos;          // åŒå„ªå…ˆã¯ position æ˜‡é †
  });
}

/* ===== æç”» ===== */
function splitByStatus(all){
  const active=[], completed=[];
  for(const t of all){
    if(t.status==='completed'){
      if(isRecentCompleted(t)) completed.push(t);
    }else if(t.status!=='deleted' && t.status!=='archived'){
      active.push(t);
    }
  }
  return {active:sortTasks(active), completed:sortTasks(completed)};
}

function cardHTML(t){
  const ghost = t.status==='completed' ? ' ghost' : '';
  const dueTxt = fmtJST(t.due_at);
  const pri = Number.isFinite(t.priority)? t.priority : 0;
  const detailOpen = (gOpenDetailId===t.id) ? ' open' : '';

  return `
  <div class="swipe-wrap card${ghost}" data-id="${t.id}">
    <div class="actions">
      <!-- å·¦ï¼šè»½ã‚¹ãƒ¯ã‚¤ãƒ—éœ²å‡ºï¼ˆå®Œäº†ï¼‰ -->
      <div style="display:flex;gap:6px">
        <button class="btn ok" data-act="complete">å®Œäº†</button>
      </div>
      <!-- å³ï¼šè»½ã‚¹ãƒ¯ã‚¤ãƒ—éœ²å‡ºï¼ˆè©³ç´°ãƒ»å‰Šé™¤ï¼‰ -->
      <div style="display:flex;gap:6px">
        <button class="btn" data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track">
      <div class="row">
        <div class="titleTxt">${escapeHTML(t.title||'(ç„¡é¡Œ)')}</div>
        <div class="meta">
          <span class="pill-sm">â˜…${pri}</span>
          ${dueTxt? `<span class="pill-sm">â° ${escapeHTML(dueTxt)}</span>`:''}
        </div>
      </div>
      <div class="detail${detailOpen}">
        <button class="x-close" title="é–‰ã˜ã‚‹" data-act="close">âœ•</button>
        <div class="detail-grid">
          <div class="full">
            <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¡ãƒ¢ï¼‰</label>
            <textarea data-field="detail" placeholder="ãƒ¡ãƒ¢">${escapeHTML(t.detail||'')}</textarea>
          </div>
          <div>
            <label>å„ªå…ˆåº¦</label>
            <select data-field="priority">
              ${[3,2,1,0].map(v=>`<option value="${v}" ${String(v)===String(pri)?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
          <div>
            <label>æœŸé™</label>
            <input type="datetime-local" data-field="due_at" value="${toLocalValue(t.due_at)||''}">
          </div>
          <div class="full">
            <label>ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœŸé™ã®2æ™‚é–“å‰ï¼‰</label>
            <input type="datetime-local" data-field="remind_at" value="${toLocalValue(defaultRemind(t))||''}">
          </div>
        </div>
        <div class="detail-bar">
          <button class="btn" data-act="cancel">æˆ»ã™</button>
          <button class="btn ok" data-act="save">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>`;
}

function toLocalValue(iso){
  if(!iso) return '';
  const d = new Date(iso);
  const tz = (d)=> {
    const pad = n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };
  return tz(d);
}
function defaultRemind(t){
  // æœŸé™ãŒã‚ã‚Œã° 2æ™‚é–“å‰ã€ãªã‘ã‚Œã°ç©º
  if(!t?.due_at) return '';
  const d=new Date(t.due_at); d.setHours(d.getHours()-2); return d.toISOString();
}

/* ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼†ãƒã‚¤ãƒ³ãƒ‰ ===== */
function render(){
  const {active, completed} = splitByStatus(gAllTasks);
  $activeList.innerHTML = active.map(cardHTML).join('');
  $completedList.innerHTML = completed.map(cardHTML).join('');

  $("#completed").hidden = completed.length===0;
  $empty.hidden = (active.length+completed.length)>0;

  // ã‚¹ãƒ¯ã‚¤ãƒ—ï¼†ã‚¿ãƒƒãƒ—ï¼†è©³ç´°ã®ãƒã‚¤ãƒ³ãƒ‰
  [...document.querySelectorAll(".swipe-wrap .track")].forEach(bindSwipe);
  [...document.querySelectorAll(".swipe-wrap")].forEach(bindClicks);
}

/* ===== ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ ===== */
const SW_LIGHT=36, SW_STRONG=140;
const SNAP_X = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--snap')) || 84;

function bindSwipe(track){
  const wrap = track.closest('.swipe-wrap');
  const actions = wrap.querySelector('.actions');

  let sx=0, dx=0, active=false, startT=0;
  let dragging=false;  // ä¸¦ã¹æ›¿ãˆãƒ¢ãƒ¼ãƒ‰
  let longTimer=null, startY=0;
  let frame = null;

  const snapTo=(x)=>{
    track.style.transition='transform .18s ease';
    track.style.transform=`translateX(${x}px)`;
    wrap.classList.toggle('open-left', x>0);
    wrap.classList.toggle('open-right', x<0);
    if (x===0){ wrap.classList.remove('open-left','open-right'); }
    setTimeout(()=>{ track.style.transition=''; }, 200);
  };

  const onStart=(x,y)=>{
    active=true; sx=x; dx=0; startT=performance.now(); startY=y;
    track.style.transition='none';
    // é•·æŠ¼ã—ã§ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆç¸¦ï¼‰æœ‰åŠ¹åŒ–
    longTimer = setTimeout(()=>{ dragging=true; document.body.style.overflow='hidden'; }, 450);
  };
  const onMove=(x,y)=>{
    if(!active) return;
    const dy = Math.abs(y-startY);
    dx = x - sx;

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ï¼ˆç¸¦ä¸¦ã¹æ›¿ãˆï¼‰å„ªå…ˆ
    if (dragging || dy>18){ // ç¸¦ç§»å‹•ãŒç›®ç«‹ã¤ãªã‚‰ãƒ‰ãƒ©ãƒƒã‚°æ‰±ã„
      clearTimeout(longTimer); dragging=true; dx=0;
      // ã“ã“ã§ä¸¦ã¹æ›¿ãˆã® UI å‡¦ç†ï¼ˆã‚´ãƒ¼ã‚¹ãƒˆåŒ–ãªã©ï¼‰ã‚’å…¥ã‚Œã¦ã‚‚OKã€‚ä»Šå›ã¯ã‚µãƒ¼ãƒãƒ¼æ›´æ–°ã®ã¿ã§ç°¡ç•¥ã€‚
      return;
    }
    // ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¨ªï¼‰
    // éœ²å‡ºæ™‚ã«é©åº¦ã«æ­¢ã‚ã‚‹
    let tx = dx;
    if (dx>0 && dx>SNAP_X) tx = Math.min(dx, SW_STRONG); // å·¦ãƒœã‚¿ãƒ³ã¯å®Œäº†ã®ã¿
    if (dx<0 && Math.abs(dx)>SNAP_X) tx = Math.max(dx, -SW_STRONG);
    if (frame) cancelAnimationFrame(frame);
    frame = requestAnimationFrame(()=>{ track.style.transform=`translateX(${tx}px)`; });
  };
  const onEnd=async ()=>{
    clearTimeout(longTimer);
    active=false;
    const dt = Math.max(1, performance.now()-startT);
    const vx = dx/dt; // px/ms

    // ä¸¦ã¹æ›¿ãˆç™ºç«ï¼ˆä»Šå›ã¯ç°¡ç•¥ï¼šé•·æŠ¼ã—ï¼‹ç¸¦ç§»å‹•å¾Œã«ä½ç½®ã‚’ä¸Šä¸‹ã«å…¥ã‚Œæ›¿ãˆã‚‹ â†’ ã“ã“ã§ã¯ã‚¿ãƒƒãƒ—ã§è©³ç´°é–‹é–‰å„ªå…ˆã®ãŸã‚ã€ä¸¦ã¹æ›¿ãˆã¯åˆ¥UIã‚„æ¬¡å›æ‹¡å¼µï¼‰
    if (dragging){
      dragging=false; document.body.style.overflow='';
      // ä»Šå›ã¯ãƒ‰ãƒ©ãƒƒã‚°ç¢ºå®šå¾Œã€ä½•ã‚‚ã—ãªã„ï¼ˆå°†æ¥ã“ã“ã§ re-order é€ä¿¡ï¼‰
      snapTo(0);
      return;
    }

    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ or é«˜é€Ÿã§å¼·åˆ¤å®š
    if (dx > SW_STRONG || vx>0.8){
      // å³ã¸å¼·ï¼šå®Œäº†ï¼ˆã¾ãŸã¯å®Œäº†å–æ¶ˆã—ï¼‰
      const id = wrap.dataset.id;
      const t = gAllTasks.find(x=>x.id===id);
      if (!t){ snapTo(0); return; }
      const act = (t.status==='completed') ? 'uncomplete' : 'complete';
      const ok = await runAction(id, act);
      if (ok) await loadTasks(gUserId);
      snapTo(0);
      return;
    }
    if (dx < -SW_STRONG || vx<-0.8){
      // å·¦ã¸å¼·ï¼šå‰Šé™¤ï¼ˆç¢ºèªã¤ãï¼‰
      const id = wrap.dataset.id;
      const ok = await confirmDelete();
      if (ok){
        const ok2 = await runAction(id, 'delete');
        if (ok2) await loadTasks(gUserId);
      }
      snapTo(0);
      return;
    }

    // è»½ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ãƒœã‚¿ãƒ³éœ²å‡ºã§ã‚¹ãƒŠãƒƒãƒ—
    if (dx > SW_LIGHT){ snapTo(+SNAP_X); return; }
    if (dx < -SW_LIGHT){ snapTo(-SNAP_X); return; }

    snapTo(0);
  };

  // ã‚¿ãƒƒãƒãƒ»ãƒã‚¦ã‚¹
  track.addEventListener('touchstart', (e)=>{ e.preventDefault(); const t=e.touches[0]; onStart(t.clientX,t.clientY); }, {passive:false});
  track.addEventListener('touchmove',  (e)=>{ e.preventDefault(); const t=e.touches[0]; onMove(t.clientX,t.clientY); }, {passive:false});
  track.addEventListener('touchend',   onEnd, {passive:true});

  track.addEventListener('mousedown', (e)=>{ onStart(e.clientX,e.clientY); });
  document.addEventListener('mousemove', (e)=>{ if(e.buttons===1) onMove(e.clientX,e.clientY); });
  document.addEventListener('mouseup', onEnd);
}

function bindClicks(wrap){
  // è¡Œã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒˆã‚°ãƒ«ï¼ˆãŸã ã—éœ²å‡ºä¸­ã¯ãƒœã‚¿ãƒ³å„ªå…ˆï¼‰
  const track = wrap.querySelector('.track');
  track.addEventListener('click', (e)=>{
    const id = wrap.dataset.id;
    const detail = track.querySelector('.detail');
    // éœ²å‡ºçŠ¶æ…‹ãªã‚‰é–‰ã˜ã¦ã‹ã‚‰ç„¡è¦–
    if (wrap.classList.contains('open-left') || wrap.classList.contains('open-right')){
      snapToZero(track, wrap);
      return;
    }
    // ä»–ã®è©³ç´°ã¯é–‰ã˜ã‚‹
    if (gOpenDetailId && gOpenDetailId!==id){
      const opened = document.querySelector(`.swipe-wrap[data-id="${gOpenDetailId}"] .detail`);
      if (opened){ opened.classList.remove('open'); }
    }
    // ãƒˆã‚°ãƒ«
    if (detail.classList.contains('open')){
      detail.classList.remove('open'); gOpenDetailId=null;
    }else{
      detail.classList.add('open'); gOpenDetailId=id;
    }
  });

  // ãƒœã‚¿ãƒ³æ“ä½œï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ï¼‰
  wrap.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    const id = wrap.dataset.id;
    const track = wrap.querySelector('.track');
    if (act==='close'){
      const detail = track.querySelector('.detail'); detail.classList.remove('open'); gOpenDetailId=null; return;
    }
    if (act==='detail'){
      // å³ãƒœã‚¿ãƒ³ï¼šè©³ç´°é–‹ã
      const detail = track.querySelector('.detail');
      if (!detail.classList.contains('open')){
        // ä»–ã®è©³ç´°ã¯é–‰ã˜ã‚‹
        if (gOpenDetailId && gOpenDetailId!==id){
          const opened = document.querySelector(`.swipe-wrap[data-id="${gOpenDetailId}"] .detail`);
          if (opened){ opened.classList.remove('open'); }
        }
        detail.classList.add('open'); gOpenDetailId=id;
      }
      snapToZero(track, wrap);
      return;
    }
    if (act==='delete'){
      const ok = await confirmDelete();
      if (!ok){ snapToZero(track, wrap); return; }
      const ok2 = await runAction(id,'delete');
      if (ok2) await loadTasks(gUserId);
      snapToZero(track, wrap);
      return;
    }
    if (act==='complete'){
      // å®Œäº† or å–æ¶ˆã¯ runAction å´ã§ status ã‚’è¦‹ãšã«å¼·åˆ¶ complete ã«ã™ã‚‹
      const ok = await runAction(id,'complete');
      if (ok) await loadTasks(gUserId);
      snapToZero(track, wrap);
      return;
    }
    if (act==='cancel'){
      // å…¥åŠ›å€¤ã‚’å…ƒã«æˆ»ã™ â†’ å†æç”»ã§OK
      await loadTasks(gUserId);
      return;
    }
    if (act==='save'){
      const detail = track.querySelector('.detail');
      const fields = readDetailFields(detail);
      const ok = await runAction(id,'update',{fields});
      if (ok){
        toast('ä¿å­˜ã—ã¾ã—ãŸ');
        await loadTasks(gUserId);
      }else{
        toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      return;
    }
  });

  function snapToZero(track, wrap){
    track.style.transition='transform .18s ease';
    track.style.transform='translateX(0)';
    wrap.classList.remove('open-left','open-right');
    setTimeout(()=>{ track.style.transition=''; },200);
  }
}

function readDetailFields(detailEl){
  const get = (sel)=> detailEl.querySelector(`[data-field="${sel}"]`);
  // due / remind ã¯ ISO ã«æˆ»ã™
  const toISO = (val)=> val? new Date(val).toISOString() : null;

  const detail = get('detail')?.value?.trim() || '';
  const priority = parseInt(get('priority')?.value ?? '0',10);
  const due_at = toISO(get('due_at')?.value || '');
  const remind_at = toISO(get('remind_at')?.value || '');
  const remind_times = remind_at? [remind_at] : [];

  return { detail, priority, due_at, remind_times };
}

/* ===== API ===== */
async function runAction(task_id, action, extra={}){
  try{
    const body = { action, task_id, user_id:gUserId, ...extra };
    const res = await fetch(ACTION_API_URL,{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    const j = await res.json().catch(()=>({ok:false}));
    if(!res.ok || j.ok===false){ throw new Error(j.message||'action failed'); }
    return true;
  }catch(err){
    console.error(err); toast('ã‚¨ãƒ©ãƒ¼: '+(err.message||'failed')); return false;
  }
}

async function loadTasks(userId){
  try{
    const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
    const res = await fetch(url,{method:'GET',credentials:'omit',headers:{'Content-Type':'application/json'}});
    const payload = await res.json();
    if(!res.ok || !payload || payload.ok!==true){ throw new Error('load failed'); }
    const pinned = Array.isArray(payload.pinned)? payload.pinned : []; // äº’æ›
    const active = Array.isArray(payload.active)? payload.active : [];
    const completed = Array.isArray(payload.completed)? payload.completed : [];
    gAllTasks = [...pinned, ...active, ...completed]; // pinnedã¯ä»Šå¾Œç©º
    render();
  }catch(e){
    console.error(e); toast('èª­ã¿è¾¼ã¿å¤±æ•—');
  }
}

/* ===== åˆæœŸåŒ– ===== */
async function bootstrap(){
  dbg('LIFF_ID=', LIFF_ID);
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  gUserId = prof.userId;
  $("#user-pill").textContent = "You: " + gUserId.slice(-6);
  await loadTasks(gUserId);
}
bootstrap();

/* ===== ä¾¿åˆ©: å‰Šé™¤ç¢ºèª ===== */
function confirmDelete(){
  return new Promise((resolve)=>{
    const ok = window.confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
    resolve(ok);
  });
}
</script>
</body>
</html>
