<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LISTï½œã‚¿ã‚¹ã‚¯</title>
  <style>
    :root {
      --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
      --pill:#eef2ff; --accent:#3957ff; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px}
    .title{font-weight:650;letter-spacing:.2px}
    .pill{padding:6px 10px;border-radius:999px;background:var(--pill);font-size:12px}
    main{padding:14px;max-width:720px;margin:0 auto}
    h3{margin:8px 6px 10px;font-size:13px;color:var(--sub);font-weight:600}
    .section{margin:18px 0}
    .empty{color:var(--sub);text-align:center;padding:36px 12px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:.25s}
    .toast.show{opacity:1}

    /* card & swipe */
    .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;margin:10px 0;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .swipe-wrap{position:relative;overflow:hidden;border-radius:16px}
    .track{position:relative;touch-action:pan-y;padding:12px 14px;background:var(--card)}
    .row{display:flex;align-items:center;gap:8px}
    .titleTxt{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{display:flex;gap:8px;color:var(--sub);font-size:12px}
    .pillDue{padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .pin{font-size:12px;color:var(--accent)}
    .ghost{opacity:.45}

    .actions{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;padding:0 8px;pointer-events:none;opacity:0;transition:.18s}
    .btn{pointer-events:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--card);font-size:12px}
    .btn.ok{border-color:#c7ecd1;color:var(--ok);background:#ecfdf5}
    .btn.warn{border-color:#fde68a;color:var(--warn);background:#fffbeb}
    .btn.danger{border-color:#fecaca;color:var(--danger);background:#fef2f2}

    /* debug toggle (ä»»æ„) */
    #debug{white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;margin:8px;border-radius:8px;display:none}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div class="section" id="pinned-sec" hidden>
    <h3>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</h3>
    <div id="pinned-list"></div>
  </div>

  <div class="section">
    <h3>ğŸ“ æœªå®Œäº†</h3>
    <div id="active-list"></div>
  </div>

  <div class="section" id="completed-sec" hidden>
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="empty" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<pre id="debug"></pre>
<div id="toast" class="toast"></div>

<script>
/** ========= è¨­å®šï¼ˆã‚ãªãŸã®å€¤ã«å·®ã—æ›¿ãˆï¼‰ ========= */
const LIFF_ID       = "2008311584-NdJqOqMn";
const LIST_API_URL  = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL= "https://lumicreate.xvps.jp/webhook/webhook-action";
/** ================================================ */

let gUserId = null;
let gAll = [];

/* ---------- å°ç‰© ---------- */
const $ = s => document.querySelector(s);
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); }
function dbg(...a){ const d=$("#debug"); if(!d) return; d.style.display="block"; d.textContent += a.map(x=> typeof x==='string'?x:JSON.stringify(x)).join(' ')+"\n"; }
function fmtJST(iso){ if(!iso) return ""; const d=new Date(iso); return d.toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}); }
function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }

/* ---------- ãƒ‡ãƒ¼ã‚¿æ•´å½¢ ---------- */
function splitByStatus(all){
  const now=Date.now(), weekAgo=now-7*24*3600*1000;
  const pinned=[], active=[], completed=[];
  for(const t of all){
    if(t.pinned){ pinned.push(t); continue; }
    if(t.status==="completed"){
      const cAt=t.completed_at? new Date(t.completed_at).getTime():0;
      if(cAt>=weekAgo) completed.push(t);
      continue;
    }
    if(t.status==="deleted"||t.status==="archived") continue;
    active.push(t);
  }
  return { pinned, active, completed };
}
function sortTasks(arr){
  return arr.slice().sort((a,b)=>{
    const ad=new Date(a.due_at||0).getTime(), bd=new Date(b.due_at||0).getTime();
    if(ad!==bd) return ad-bd; // æœŸé™æ˜‡é †
    const ap=Number.isFinite(a.priority)?a.priority:-1, bp=Number.isFinite(b.priority)?b.priority:-1;
    return bp-ap; // å„ªå…ˆåº¦é™é †
  });
}

/* ---------- æç”» ---------- */
function cardHTML(t){
  const due=fmtJST(t.due_at), pin=t.pinned?'<span class="pin">ğŸ“Œ</span>':"", ghost=t.status==="completed"?" ghost":"";
  return `
  <div class="swipe-wrap card${ghost}" data-id="${t.id}">
    <div class="actions">
      <!-- å·¦å´ï¼ˆå®Œäº†/å–æ¶ˆãƒ»ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‰ -->
      <div style="display:flex;gap:6px">
        <button class="btn ok" data-act="${t.status==='completed'?'uncomplete':'complete'}">${t.status==='completed'?'å–æ¶ˆ':'å®Œäº†'}</button>
        <button class="btn warn" data-act="remind">ï¾˜ï¾ï½²ï¾ï¾„ï¾</button>
      </div>
      <!-- å³å´ï¼ˆãƒ”ãƒ³ãƒ»è©³ç´°ãƒ»å‰Šé™¤ï¼‰ -->
      <div style="display:flex;gap:6px">
        <button class="btn" data-act="pin">${t.pinned?'ãƒ”ãƒ³è§£é™¤':'ãƒ”ãƒ³'}</button>
        <button class="btn" data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track">
      <div class="row">
        <div class="titleTxt">${pin}${escapeHTML(t.title||'(ç„¡é¡Œ)')}</div>
        <div class="meta">
          <span class="pillDue">â° ${escapeHTML(due)}</span>
          ${Number.isFinite(t.priority)?`<span class="pillDue">â˜…${t.priority}</span>`:''}
        </div>
      </div>
    </div>
  </div>`;
}

function render(){
  const {pinned,active,completed}=splitByStatus(gAll);
  const pinS=sortTasks(pinned), actS=sortTasks(active), compS=sortTasks(completed);

  $("#pinned-sec").hidden = pinS.length===0;
  $("#completed-sec").hidden = compS.length===0;
  $("#empty").hidden = (pinS.length+actS.length)>0;

  $("#pinned-list").innerHTML   = pinS.map(cardHTML).join("");
  $("#active-list").innerHTML   = actS.map(cardHTML).join("");
  $("#completed-list").innerHTML= compS.map(cardHTML).join("");

  // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ãƒã‚¤ãƒ³ãƒ‰
  [...document.querySelectorAll(".track")].forEach(bindSwipe);
  $(".title").textContent = `LISTï½œã‚¿ã‚¹ã‚¯ï¼ˆ${gAll.length}ä»¶ï¼‰`;
}

/* ---------- ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆè·é›¢Ã—é€Ÿåº¦åˆ¤å®šï¼‰ ---------- */
function bindSwipe(track){
  const wrap = track.parentElement;       // .swipe-wrap
  const actions = wrap.querySelector(".actions");
  const id = wrap.dataset.id;

  // ã—ãã„å€¤
  const LIGHT_DIST = 40;      // è»½ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢(px)
  const STRONG_DIST = 120;    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢(px)
  const VELO_STRONG = 0.6;    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—é€Ÿåº¦(px/ms)

  let sx=0, dx=0, active=false, t0=0;

  const start = (x)=>{
    active=true; sx=x; dx=0; t0=performance.now();
    track.style.transition="none";
  };
  const move = (x)=>{
    if(!active) return;
    dx = x - sx;
    track.style.transform = `translateX(${dx}px)`;
    actions.style.opacity = Math.min(1, Math.abs(dx)/80);
  };
  const end = async ()=>{
    if(!active) return;
    const dt = Math.max(1, performance.now()-t0);
    const v = Math.abs(dx)/dt; // px/ms
    const dir = dx>0 ? "right" : "left";
    const strong = (Math.abs(dx)>=STRONG_DIST) || (v>=VELO_STRONG);
    const light  = Math.abs(dx)>=LIGHT_DIST;

    // reset view
    track.style.transition="transform .18s ease";
    track.style.transform="translateX(0)";
    actions.style.opacity=0;
    active=false;

    // è»½ã‚¹ãƒ¯ã‚¤ãƒ—ï¼šæ“ä½œãƒãƒ¼è¡¨ç¤ºã®ã¿ï¼ˆéè‡ªå‹•å®Ÿè¡Œï¼‰
    if(light && !strong){
      openActionBar(wrap, dir);
      return;
    }

    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—ï¼šå³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    if(strong){
      const t = gAll.find(x=>x.id===id);
      if(!t) return;
      if(dir==="right"){
        // å³ï¼å®Œäº† / å®Œäº†å–æ¶ˆ
        const act = (t.status==="completed") ? "uncomplete" : "complete";
        await runAction(id, act);
      }else{
        // å·¦ï¼å‰Šé™¤ï¼ˆç¢ºèªï¼‰
        const ok = confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
        if(ok) await runAction(id, "delete");
      }
    }
  };

  // Touch
  track.addEventListener("touchstart", e=>start(e.touches[0].clientX), {passive:true});
  track.addEventListener("touchmove",  e=>move(e.touches[0].clientX),   {passive:true});
  track.addEventListener("touchend",   end);
  // Mouseï¼ˆé–‹ç™ºç”¨ï¼‰
  track.addEventListener("mousedown", e=>start(e.clientX));
  track.addEventListener("mousemove", e=>{ if(e.buttons===1) move(e.clientX); });
  track.addEventListener("mouseup", end);
}

function openActionBar(wrap, dir){
  const actions = wrap.querySelector(".actions");
  actions.style.opacity = 1;
  // ç‰‡å´ã ã‘å¼·èª¿ï¼ˆä»»æ„ã®UIï¼‰
  actions.style.justifyContent = "space-between";
  // ä¸€åº¦ã ã‘ãƒœã‚¿ãƒ³ã‚’æŸã­ã¦ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
  wrap.querySelectorAll(".btn").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const id = wrap.dataset.id;
      const act = e.currentTarget.dataset.act;
      if(act==="delete"){
        const ok = confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
        if(!ok) return;
      }
      await runAction(id, act);
      actions.style.opacity = 0;
    }, {once:true});
  });
}

/* ---------- é€šä¿¡ ---------- */
async function load(){
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(gUserId)}`;
  let res, j;
  try{
    res = await fetch(url, {method:"GET", cache:"no-store", credentials:"omit", headers:{ "Accept":"application/json" }});
    j = await res.json();
  }catch(e){
    dbg("load fetch/json error:", e.message||e);
    toast("èª­ã¿è¾¼ã¿å¤±æ•—"); return;
  }
  if(!res.ok || !j || j.ok!==true){
    toast("èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆHTTP "+(res&&res.status)+")"); return;
  }
  // å½¢å¼ï¼š{ok:true, pinned/active/completed}
  const pinned = Array.isArray(j.pinned)?j.pinned:[];
  const active = Array.isArray(j.active)?j.active:[];
  const completed = Array.isArray(j.completed)?j.completed:[];
  gAll = [...pinned, ...active, ...completed];
  render();
}

async function runAction(id, act){
  try{
    const res = await fetch(ACTION_API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action: act, task_id: id, user_id: gUserId })
    });
    const j = await res.json().catch(()=>({ok:false}));
    if(!res.ok || j.ok===false) throw new Error(j.message||"action failed");

    // --- ãƒ­ãƒ¼ã‚«ãƒ«å³æ™‚åæ˜  ---
    const t = gAll.find(x=>x.id===id);
    if(act==="delete"){
      gAll = gAll.filter(x=>x.id!==id);
    }else if(act==="complete" && t){
      t.status="completed";
      t.completed_at = new Date().toISOString();
    }else if(act==="uncomplete" && t){
      t.status="active";
      t.completed_at = null;
    }else if(act==="pin" && t){
      t.pinned = !t.pinned;
    }else if(act==="detail" && t){
      alert(`ï¼»è©³ç´°ï¼ˆç°¡æ˜“è¡¨ç¤ºï¼‰ï¼½\nã‚¿ã‚¤ãƒˆãƒ«ï¼š${t.title||'(ç„¡é¡Œ)'}\næœŸé™ï¼š${fmtJST(t.due_at)}`);
    }else if(act==="remind" && t){
      toast("ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆä»®ï¼‰");
    }

    render();               // â† ã¾ãšUIå³æ™‚æ›´æ–°
    setTimeout(load, 900);  // â† å°‘ã—å¾Œã«ã‚µãƒ¼ãƒãƒ¼åŒæœŸï¼ˆåæ˜ é…å»¶å¸åï¼‰
    toast(labelOf(act)+"ã—ã¾ã—ãŸ");
  }catch(err){
    console.error(err);
    toast("å¤±æ•—ã—ã¾ã—ãŸ");
  }
}
function labelOf(a){ return ({pin:"ãƒ”ãƒ³",complete:"å®Œäº†",uncomplete:"å–æ¶ˆ",delete:"å‰Šé™¤",remind:"ï¾˜ï¾ï½²ï¾ï¾„ï¾",detail:"è©³ç´°"}[a]||a); }

/* ---------- èµ·å‹• ---------- */
async function bootstrap(){
  dbg("LIFF_ID=", LIFF_ID);
  await liff.init({ liffId: LIFF_ID });
  dbg("liff.init OK");
  if(!liff.isLoggedIn()) liff.login();
  const ctx = liff.getContext?.(); if(ctx) dbg("context", ctx);
  const prof = await liff.getProfile(); gUserId = prof.userId; $("#user-pill").textContent = "You: "+gUserId.slice(-6);
  await load();
}

bootstrap();
</script>
</body>
</html>
