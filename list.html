<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LISTï½œã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --ink:#111; --sub:#666; --line:#e9e9ec;
    --accent:#3957ff; --ok:#16a34a; --danger:#ef4444;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  header{
    position:sticky; top:0; background:var(--card);
    border-bottom:1px solid var(--line); z-index:10;
  }
  .bar{ display:flex; align-items:center; gap:8px; justify-content:space-between; padding:12px 16px; }
  .title{ font-weight:650; letter-spacing:.2px; }
  .pill{ padding:6px 10px; border-radius:999px; background:#eef2ff; font-size:12px; }

  main{ padding:14px; max-width:720px; margin:0 auto; }
  .toolbar{ display:flex; gap:8px; padding:8px 0; }
  .toolbar input{ flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; }
  .toolbar button{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; }

  .section{ margin:18px 0; }
  .section h3{ margin:8px 6px 10px; font-size:13px; color:var(--sub); font-weight:600; }

  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px;
    padding:12px 14px; margin:10px 0; box-shadow:0 1px 0 rgba(0,0,0,.03);
    touch-action:pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯OKã€æ¨ªã¯ãƒ‰ãƒ©ãƒƒã‚°ç”¨ */
  }
  .row{ display:flex; align-items:center; gap:8px; }
  .titleTxt{ flex:1; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .meta{ display:flex; gap:8px; color:var(--sub); font-size:12px; }
  .due{ padding:2px 8px; border-radius:999px; border:1px solid var(--line); }

  .btns{ display:flex; gap:6px; }
  .btn{
    padding:6px 10px; border-radius:10px; border:1px solid var(--line); background:#fff; font-size:12px; cursor:pointer;
  }
  .btn.ok{ border-color:#c7ecd1; color:var(--ok); background:#ecfdf5; }
  .btn.danger{ border-color:#fecaca; color:var(--danger); background:#fef2f2; }

  .ghost{ opacity:.45; }
  .placeholder{
    border:2px dashed var(--accent); background:#f0f4ff; border-radius:16px; height:56px; margin:10px 0;
  }
  .dragging{ opacity:.8; box-shadow:0 6px 16px rgba(0,0,0,.12); }

  .detail{
    margin-top:10px; padding-top:10px; border-top:1px dashed var(--line); display:none;
  }
  .detail.open{ display:block; }
  .detail .row2{ display:grid; grid-template-columns:88px 1fr; gap:8px; align-items:center; margin:8px 0; }
  .detail input, .detail select, .detail textarea{
    width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; background:#fff; font:inherit;
  }
  .detail .hdr{ display:flex; align-items:center; justify-content:space-between; }
  .detail .close{ cursor:pointer; font-size:18px; line-height:1; padding:4px 10px; }

  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px;
    opacity:0; transition:.2s;
  }
  .toast.show{ opacity:1; }

  /* ã‚¹ãƒŠãƒƒãƒ—æ™‚ã«ä¸Šä¸‹ä½™ç™½ã‚’å°‘ã—åºƒã’ã¦è¦‹ã‚„ã™ã */
  .drop-zone{ margin:4px 0; }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
    <div class="pill" id="user-pill">loadingâ€¦</div>
  </div>
</header>

<main>
  <div class="toolbar">
    <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰" />
    <button id="reload">å†èª­è¾¼</button>
  </div>

  <div id="active" class="section">
    <h3>ğŸ“ æœªå®Œäº†ï¼ˆå„ªå…ˆåº¦ã§ä¸¦ã³æ›¿ãˆï¼é•·æŠ¼ã—ã§ä¸¦ã³æ›¿ãˆï¼‰</h3>
    <div id="active-list"></div>
  </div>

  <div id="completed" class="section" hidden>
    <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
    <div id="completed-list"></div>
  </div>

  <div id="empty" class="section" hidden>ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
</main>

<pre id="debug" style="white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid #eee;padding:8px;margin:8px;border-radius:8px;"></pre>
<div id="toast" class="toast"></div>

<script>
/** ================= è¨­å®š ================= */
const LIFF_ID = "2008311584-NdJqOqMn";                           // â† ã‚ãªãŸã®LIFF ID
const LIST_API_URL   = "https://lumicreate.xvps.jp/webhook/webhook-list";   // n8n: LIST (GET)
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action"; // n8n: ACTION (POST)
/** ======================================= */

let gUserId = null;
let gAllTasks = [];   // supabase ãã®ã¾ã¾
// å„ªå…ˆåº¦å†…ã®ä¸¦ã³é †ã‚’ä¿æŒã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå„ªå…ˆåº¦ã”ã¨ã« id é…åˆ—ï¼‰
let gOrderMap = new Map();  // key: priority(number or null)-> value: [id,id,...]

const $ = (sel)=>document.querySelector(sel);
const $activeList = $('#active-list');
const $completedList = $('#completed-list');
const $completed = $('#completed');
const $empty = $('#empty');

function dbg(...a){ const el=$('#debug'); if(!el) return; el.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')+'\n'; }
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
function fmtJST(iso){ if(!iso) return ""; const d=new Date(iso); return d.toLocaleString("ja-JP",{timeZone:"Asia/Tokyo",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}); }

function splitByStatus(all){
  const now=Date.now(), weekAgo=now-7*24*3600*1000;
  const active=[], completed=[];
  for(const t of all){
    if(t.status==='completed'){
      const cAt=t.completed_at? new Date(t.completed_at).getTime():0;
      if(cAt>=weekAgo) completed.push(t);
      continue;
    }
    if(t.status==='deleted' || t.status==='archived') continue;
    active.push(t);
  }
  return { active, completed };
}

// ä¸¦ã³é †ï¼šå„ªå…ˆåº¦ï¼ˆå¤§ãã„ã»ã©ä¸Šï¼‰â†’ åŒå„ªå…ˆåº¦ã¯ gOrderMap ã®é †ï¼ˆç„¡ã‘ã‚Œã°å–å¾—é †ï¼‰
// priority ãŒ null/undefined ã®å ´åˆã¯ 0 ã¨ã—ã¦æ‰±ã†
function sortActive(arr){
  // order map ã‚’åˆæœŸåŒ–
  gOrderMap.clear();
  for(const t of arr){
    const p = Number.isFinite(t.priority)? t.priority : 0;
    if(!gOrderMap.has(p)) gOrderMap.set(p,[]);
    gOrderMap.get(p).push(t.id);
  }
  // å®Ÿéš›ã®ã‚½ãƒ¼ãƒˆ
  const byPriority = arr.slice().sort((a,b)=>{
    const ap = Number.isFinite(a.priority)? a.priority:0;
    const bp = Number.isFinite(b.priority)? b.priority:0;
    if(bp!==ap) return bp-ap; // å¤§ãã„å„ªå…ˆ
    // åŒå„ªå…ˆâ†’ gOrderMap ã®é †
    const seq = gOrderMap.get(ap) || [];
    return seq.indexOf(a.id) - seq.indexOf(b.id);
  });
  return byPriority;
}

function render(){
  const {active, completed} = splitByStatus(gAllTasks);
  const actSorted = sortActive(active);
  $activeList.innerHTML = actSorted.map(cardHTML).join('');
  $completed.hidden = completed.length===0;
  $completedList.innerHTML = completed.map(cardHTML).join('');

  // è©³ç´°ã®é–‹é–‰ã€ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  bindCardEvents();

  // ä¸¦ã³æ›¿ãˆï¼ˆé•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°ï¼‰ã¯ã€Œæœªå®Œäº†ã€ãƒªã‚¹ãƒˆã®ã¿æœ‰åŠ¹
  bindDragSort($activeList);
  $empty.hidden = actSorted.length>0;
  $('.title').textContent = 'LISTï½œã‚¿ã‚¹ã‚¯ï¼ˆæœªå®Œäº†: '+actSorted.length+'ä»¶ï¼‰';
}

function cardHTML(t){
  const dueTxt = fmtJST(t.due_at);
  const pr = Number.isFinite(t.priority)? t.priority:0;
  return `
  <div class="card" data-id="${t.id}" data-priority="${pr}">
    <div class="row">
      <div class="titleTxt js-toggle-detail">${escapeHTML(t.title || '(ç„¡é¡Œ)')}</div>
      <div class="meta">
        <span class="due">â˜…${pr}</span>
        ${dueTxt? `<span class="due">â° ${escapeHTML(dueTxt)}</span>` : ``}
      </div>
      <div class="btns">
        <button class="btn ok" data-act="complete">å®Œäº†</button>
        <button class="btn" data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="detail" id="detail-${t.id}">
      <div class="hdr">
        <strong>è©³ç´°ç·¨é›†</strong>
        <span class="close" data-close="1">âœ•</span>
      </div>
      <div class="row2">
        <div>ã‚³ãƒ¡ãƒ³ãƒˆ</div>
        <textarea rows="3" data-field="detail" placeholder="ãƒ¡ãƒ¢ãªã©...">${escapeHTML(t.detail||'')}</textarea>
      </div>
      <div class="row2">
        <div>å„ªå…ˆåº¦</div>
        <select data-field="priority">
          ${[3,2,1,0].map(v=>`<option value="${v}" ${v===pr?'selected':''}>${v}</option>`).join('')}
        </select>
      </div>
      <div class="row2">
        <div>æœŸé™</div>
        <input type="datetime-local" data-field="due_at" value="${toLocalInputValue(t.due_at)}" />
      </div>
      <div class="row2">
        <div>ãƒªãƒã‚¤ãƒ³ãƒ‰</div>
        <input type="datetime-local" data-field="remind_times" value="${toLocalInputValue((t.remind_times||[])[0])}" />
      </div>
      <div style="text-align:right; margin-top:8px;">
        <button class="btn" data-save="1">ä¿å­˜</button>
      </div>
    </div>
  </div>`;
}

function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}
function toLocalInputValue(iso){
  if(!iso) return '';
  const d=new Date(iso);
  const pad=n=>String(n).padStart(2,'0');
  const yyyy=d.getFullYear();
  const mm=pad(d.getMonth()+1);
  const dd=pad(d.getDate());
  const hh=pad(d.getHours());
  const mi=pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function fromLocalInputValue(v){
  if(!v) return null;
  const d=new Date(v);
  return d.toISOString();
}

function bindCardEvents(){
  // ã‚¿ã‚¤ãƒˆãƒ« or detailãƒœã‚¿ãƒ³ã§è©³ç´°é–‹é–‰ã€Ã—ã§ã‚¯ãƒ­ãƒ¼ã‚ºã€‚åˆ¥ã®ã‚«ãƒ¼ãƒ‰ã‚’é–‹ãæ™‚ã¯ä»–ã‚’é–‰ã˜ã‚‹
  document.querySelectorAll('.js-toggle-detail, .btn[data-act="detail"]').forEach(el=>{
    el.addEventListener('click', e=>{
      e.stopPropagation();
      const card = el.closest('.card');
      toggleDetail(card.dataset.id);
    }, {passive:false});
  });
  document.querySelectorAll('.detail .close').forEach(el=>{
    el.addEventListener('click', e=>{
      e.stopPropagation();
      const card = el.closest('.card');
      openDetail(null); // å…¨é–‰
    }, {passive:false});
  });
  // ä¿å­˜
  document.querySelectorAll('.detail [data-save]').forEach(el=>{
    el.addEventListener('click', async e=>{
      e.preventDefault(); e.stopPropagation();
      const card = el.closest('.card');
      await saveDetail(card);
    }, {passive:false});
  });
  // å®Œäº† / å‰Šé™¤
  document.querySelectorAll('.btn[data-act="complete"]').forEach(el=>{
    el.addEventListener('click', async e=>{
      e.preventDefault(); e.stopPropagation();
      const card = el.closest('.card');
      await runAction(card.dataset.id,'complete');
    }, {passive:false});
  });
  document.querySelectorAll('.btn[data-act="delete"]').forEach(el=>{
    el.addEventListener('click', async e=>{
      e.preventDefault(); e.stopPropagation();
      const card = el.closest('.card');
      if(!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await runAction(card.dataset.id,'delete');
    }, {passive:false});
  });
}

function openDetail(id){
  document.querySelectorAll('.detail').forEach(d=>d.classList.remove('open'));
  if(id){
    const panel = document.getElementById('detail-'+id);
    if(panel) panel.classList.add('open');
  }
}
function toggleDetail(id){
  const panel = document.getElementById('detail-'+id);
  if(!panel) return;
  const opened = panel.classList.contains('open');
  openDetail(null);
  if(!opened) panel.classList.add('open');
}

async function saveDetail(cardEl){
  const id = cardEl.dataset.id;
  const panel = cardEl.querySelector('.detail');
  const f = sel => panel.querySelector(`[data-field="${sel}"]`);
  const patch = {
    detail: (f('detail')?.value||'').trim(),
    priority: Number(f('priority')?.value||0),
    due_at: fromLocalInputValue(f('due_at')?.value||''),
    remind_times: (()=>{
      const v = fromLocalInputValue(f('remind_times')?.value||'');
      return v? [v] : [];
    })()
  };
  try{
    const res = await fetch(ACTION_API_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'update', task_id:id, user_id:gUserId, fields:patch })
    });
    const j = await res.json();
    if(!res.ok || j.ok===false) throw new Error(j.message||'update failed');
    toast('ä¿å­˜ã—ã¾ã—ãŸ');
    await loadTasks();
    // ä¿å­˜å¾Œã«è©³ç´°ã‚’é–‰ã˜ã‚‹å ´åˆã¯ä¸‹è¡Œã‚’æœ‰åŠ¹åŒ–
    // openDetail(null);
  }catch(e){
    console.error(e);
    toast('ã‚¨ãƒ©ãƒ¼: '+(e.message||'failed'));
  }
}

async function runAction(id, action){
  try{
    const body = { action, task_id:id, user_id:gUserId };
    if(action==='complete'){
      // ã€Œå®Œäº†â†’æœªå®Œäº†ã€ãƒˆã‚°ãƒ«ã«ã—ãŸã„å ´åˆã¯ã‚µãƒ¼ãƒå´ã§åˆ‡ã‚Šæ›¿ãˆå®Ÿè£…ã§ã‚‚OK
      // ã“ã“ã§ã¯å®Œäº†ã«å›ºå®š
    }
    const res = await fetch(ACTION_API_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await res.json().catch(()=>({ok:false}));
    if(!res.ok || j.ok===false) throw new Error(j.message||'action failed');
    toast(({complete:'å®Œäº†ã«ã—ã¾ã—ãŸ', delete:'å‰Šé™¤ã—ã¾ã—ãŸ'})[action] || 'OK');
    await loadTasks();
  }catch(e){
    console.error(e);
    toast('ã‚¨ãƒ©ãƒ¼: '+(e.message||'failed'));
  }
}

/* ====== ä¸¦ã³æ›¿ãˆï¼ˆé•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°ï¼‰ ======
   - ã€Œæœªå®Œäº†ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã®ã¿æœ‰åŠ¹
   - åŒã˜å„ªå…ˆåº¦ï¼ˆâ˜…ï¼‰åŒå£«ã®ã¿ä¸Šä¸‹å…¥ã‚Œæ›¿ãˆå¯
   - ãƒ‰ãƒ­ãƒƒãƒ—å¾Œ: ACTION_API_URL ã« {action:'reorder', priority, ordered_ids:[...]} ã‚’é€ä¿¡
*/
function bindDragSort(container){
  // ä¸€æ—¦ã€éå»ãƒãƒ³ãƒ‰ãƒ©ã‚’ç¶ºéº—ã«
  container.querySelectorAll('.card').forEach(card=>{
    card.onpointerdown = card.onpointermove = card.onpointerup = null;
    card.ontouchstart = card.ontouchmove = card.ontouchend = null;
    card.onmousedown = card.onmousemove = card.onmouseup = null;
  });

  let pressTimer=null, dragging=null, startY=0, lastY=0, placeholder=null, originNext=null, groupNodes=null, groupTop=0, groupBottom=0;

  function longPressStart(card, clientY){
    // åŒä¸€å„ªå…ˆåº¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŠ½å‡º
    const pr = Number(card.dataset.priority||0);
    groupNodes = [...container.querySelectorAll(`.card[data-priority="${pr}"]`)];
    if(groupNodes.length<=1) return; // ä¸¦ã³æ›¿ãˆä¸è¦

    dragging = card;
    startY = lastY = clientY;

    card.classList.add('dragging');
    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
    placeholder = document.createElement('div');
    placeholder.className = 'placeholder drop-zone';
    card.parentNode.insertBefore(placeholder, card.nextSibling);

    // ä½ç½®å›ºå®šã®ãŸã‚ card ã‚’çµ¶å¯¾é…ç½®é¢¨ã«
    const rect = card.getBoundingClientRect();
    const offsetY = clientY - rect.top;
    card.style.position='fixed';
    card.style.left = rect.left+'px';
    card.style.width = rect.width+'px';
    card.style.top = (clientY - offsetY)+'px';
    card.style.zIndex = 50;

    // ã‚°ãƒ«ãƒ¼ãƒ—ç¯„å›²
    const rects = groupNodes.map(n=>n.getBoundingClientRect());
    groupTop = Math.min(...rects.map(r=>r.top));
    groupBottom = Math.max(...rects.map(r=>r.bottom));

    originNext = placeholder.nextElementSibling;
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã®é¸æŠã‚’é˜²æ­¢
    document.body.style.userSelect='none';
  }

  function longPressMove(clientY){
    if(!dragging) return;
    // ç§»å‹•
    const rect = dragging.getBoundingClientRect();
    const dy = clientY - lastY;
    lastY = clientY;
    dragging.style.top = (rect.top + dy) + 'px';

    // æŒ¿å…¥ä½ç½®æ›´æ–°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å†…ï¼‰
    const centerY = rect.top + dy + rect.height/2;
    // å®‰å…¨ã«å†è¨ˆç®—
    const siblings = [...container.querySelectorAll(`.card[data-priority="${dragging.dataset.priority}"]`)]
      .filter(n=>n!==dragging);
    let insertBefore = null;
    for(const sib of siblings){
      const r = sib.getBoundingClientRect();
      if(centerY < (r.top + r.height/2)){ insertBefore = sib; break; }
    }
    if(insertBefore){
      container.insertBefore(placeholder, insertBefore);
    }else{
      // æœ€å¾Œå°¾
      const last = siblings[siblings.length-1];
      if(last) last.after(placeholder);
    }
  }

  async function longPressEnd(){
    if(!dragging) return;
    const card = dragging;
    card.classList.remove('dragging');
    card.style.position=''; card.style.left=''; card.style.top=''; card.style.width=''; card.style.zIndex='';

    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ä½ç½®ã¸å·®ã—æ›¿ãˆ
    placeholder.replaceWith(card);
    placeholder=null;

    document.body.style.userSelect='';
    // æ–°ã—ã„é †åºã‚’ç¢ºå®šã—ã€ã‚µãƒ¼ãƒã¸é€šçŸ¥
    const pr = Number(card.dataset.priority||0);
    const ordered = [...container.querySelectorAll(`.card[data-priority="${pr}"]`)].map(n=>n.dataset.id);
    // ãƒ­ãƒ¼ã‚«ãƒ«é †åºã‚‚æ›´æ–°
    gOrderMap.set(pr, ordered);

    try{
      const res = await fetch(ACTION_API_URL, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'reorder', user_id:gUserId, priority:pr, ordered_ids:ordered })
      });
      const j = await res.json().catch(()=>({ok:false}));
      if(!res.ok || j.ok===false) throw new Error(j.message||'reorder failed');
      toast('ä¸¦ã³é †ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }catch(e){
      console.error(e);
      toast('ã‚¨ãƒ©ãƒ¼: '+(e.message||'failed'));
      // å¤±æ•—æ™‚ã¯å†èª­ã¿è¾¼ã¿ã§æ•´åˆ
      await loadTasks();
    }
    dragging=null;
  }

  // é•·æŠ¼ã—æ¤œå‡ºï¼ˆã‚¹ãƒãƒ›/PCä¸¡å¯¾å¿œï¼‰
  container.querySelectorAll('.card').forEach(card=>{
    const start = (y)=>{ clearTimeout(pressTimer); pressTimer = setTimeout(()=>longPressStart(card,y), 350); };
    const move  = (y)=>{ if(pressTimer && Math.abs(y-startY)>8) { /*é•·æŠ¼ã—å‰ã«å¤§ç§»å‹•ãªã‚‰è§£é™¤*/ } if(dragging) longPressMove(y); };
    const end   = ()=>{ clearTimeout(pressTimer); longPressEnd(); };

    // Touch
    card.addEventListener('touchstart', e=>{ const t=e.touches[0]; start(t.clientY); }, {passive:true});
    card.addEventListener('touchmove',  e=>{ const t=e.touches[0]; move(t.clientY); }, {passive:true});
    card.addEventListener('touchend',   end);

    // Mouseï¼ˆé–‹ç™ºç”¨ï¼‰
    card.addEventListener('mousedown', e=>{ start(e.clientY); });
    card.addEventListener('mousemove', e=>{ if(dragging) move(e.clientY); });
    card.addEventListener('mouseup',   end);
    card.addEventListener('mouseleave',()=>{ if(dragging) longPressEnd(); });
  });
}

async function loadTasks(userId){
  if(!userId){
    try{
      const prof = await liff.getProfile(); userId = prof.userId;
    }catch(e){ toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã«å¤±æ•—'); return; }
  }
  gUserId = userId;
  $('#user-pill').textContent = 'You: ' + gUserId.slice(-6);

  try{
    const res = await fetch(`${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`);
    const payload = await res.json();
    if(!res.ok || !payload || payload.ok!==true){
      toast('èª­ã¿è¾¼ã¿å¤±æ•—'); return;
    }
    // æ—§å½¢å¼ {ok:true,data:[]} ã‚‚ä¸€å¿œã‚µãƒãƒ¼ãƒˆ
    const pinned = Array.isArray(payload.pinned)? payload.pinned : [];
    const active = Array.isArray(payload.active)? payload.active :
                   Array.isArray(payload.data)? payload.data : [];
    const completed = Array.isArray(payload.completed)? payload.completed : [];
    gAllTasks = [...pinned, ...active, ...completed];
    dbg('loaded items=', gAllTasks.length);
    render();
  }catch(e){
    console.error(e); toast('èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆé€šä¿¡/JSONï¼‰');
  }
}

async function bootstrap(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();
  const prof = await liff.getProfile();
  gUserId = prof.userId;
  $('#user-pill').textContent = 'You: ' + gUserId.slice(-6);

  $('#reload').onclick = ()=> loadTasks(gUserId);
  $('#q').addEventListener('input', e=>{
    const q = e.target.value.trim().toLowerCase();
    if(!q){ render(); return; }
    const filtered = gAllTasks.filter(t=>
      (t.title||'').toLowerCase().includes(q) ||
      (t.detail||'').toLowerCase().includes(q)
    );
    const {active, completed} = splitByStatus(filtered);
    const actSorted = sortActive(active);
    $activeList.innerHTML = actSorted.map(cardHTML).join('');
    $completed.hidden = completed.length===0;
    $completedList.innerHTML = completed.map(cardHTML).join('');
    bindCardEvents();
    bindDragSort($activeList);
  });

  await loadTasks(gUserId);
}

bootstrap();
</script>
</body>
</html>
