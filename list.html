<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LISTï½œã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
    <style>
      :root {
        --bg: #f7f7f8;
        --card: #fff;
        --ink: #111;
        --sub: #666;
        --line: #e9e9ec;
        --pill: #eef2ff;
        --accent: #3957ff;
        --ok: #16a34a;
        --warn: #eab308;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--ink);
        font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
      }
      header {
        position: sticky;
        top: 0;
        background: var(--card);
        border-bottom: 1px solid var(--line);
        z-index: 10;
      }
      .bar {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
        padding: 12px 16px;
      }
      .title {
        font-weight: 650;
        letter-spacing: 0.2px;
      }
      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--pill);
        font-size: 12px;
      }
      main {
        padding: 14px;
        max-width: 720px;
        margin: 0 auto;
      }
      .section {
        margin: 18px 0;
      }
      .section h3 {
        margin: 8px 6px 10px;
        font-size: 13px;
        color: var(--sub);
        font-weight: 600;
      }

      .card {
        position: relative;
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 12px 14px;
        margin: 10px 0;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.03);
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .titleTxt {
        flex: 1;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .meta {
        display: flex;
        gap: 8px;
        color: var(--sub);
        font-size: 12px;
      }
      .due {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--line);
      }
      .pin {
        font-size: 12px;
        color: var(--accent);
      }

      /* swipe */
      .swipe-wrap {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
      }
      .actions {
        position: absolute;
        inset: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 8px;
        pointer-events: none;
      }
      .btn {
        pointer-events: auto;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: var(--card);
        font-size: 12px;
      }
      .btn.ok {
        border-color: #c7ecd1;
        color: var(--ok);
        background: #ecfdf5;
      }
      .btn.warn {
        border-color: #fde68a;
        color: var(--warn);
        background: #fffbeb;
      }
      .btn.danger {
        border-color: #fecaca;
        color: var(--danger);
        background: #fef2f2;
      }
      .track {
        position: relative;
        touch-action: pan-y;
        background: var(--card);
      }
      .ghost {
        opacity: 0.45;
      }

      .empty {
        color: var(--sub);
        text-align: center;
        padding: 36px 12px;
      }
      .skeleton {
        height: 60px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: linear-gradient(90deg, #f5f5f7, #eee, #f5f5f7);
        background-size: 200% 100%;
        animation: s 1.1s linear infinite;
      }
      @keyframes s {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .toolbar {
        display: flex;
        gap: 8px;
        padding: 8px;
      }
      .toolbar input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
      }
      .toolbar button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #fff;
      }
      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: #111;
        color: #fff;
        padding: 10px 14px;
        border-radius: 999px;
        font-size: 13px;
        opacity: 0;
        transition: 0.25s;
      }
      .toast.show {
        opacity: 1;
      }
      /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å±•é–‹ã—ãŸçŠ¶æ…‹ã‚’å›ºå®šè¡¨ç¤º */
      .swipe-wrap.menu .actions{
        opacity:1 !important;
        pointer-events:auto !important;
      }
      .swipe-wrap.menu .track{
        transform:translateX(-96px); /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ†ã ã‘è¦‹ã›ã‚‹ */
        transition:transform .18s ease;
      }
      
      /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚¿ãƒƒãƒ—ã§ãã‚‹ã‚ˆã†ã« */
      .actions{
        transition:opacity .15s ease;
        z-index:2;          /* ãƒˆãƒ©ãƒƒã‚¯ã‚ˆã‚Šå‰é¢ */
      }
      .track{
        position:relative;
        z-index:1;
      }


    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  </head>
  <body>
    <header>
      <div class="bar">
        <div class="title">LISTï½œã‚¿ã‚¹ã‚¯</div>
        <div class="pill" id="user-pill">loadingâ€¦</div>
      </div>
    </header>

    <main>
      <div class="toolbar">
        <input id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è©³ç´°ï¼‰" />
        <button id="reload">å†èª­è¾¼</button>
      </div>

      <div id="pinned" class="section" hidden>
        <h3>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</h3>
        <div id="pinned-list"></div>
      </div>

      <div id="active" class="section">
        <h3>ğŸ“ æœªå®Œäº†</h3>
        <div id="active-list"></div>
      </div>

      <div id="completed" class="section" hidden>
        <h3>âœ… å®Œäº†ï¼ˆç›´è¿‘1é€±é–“ï¼‰</h3>
        <div id="completed-list"></div>
      </div>

      <div id="empty" class="empty" hidden>
        ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚
      </div>
    </main>

    <pre id="debug" style="white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace; background:#fff;border:1px solid #eee; padding:8px; margin:8px; border-radius:8px;"></pre>

    <div id="toast" class="toast"></div>

    <script>
/** =================== è¨­å®š =================== */
const LIST_API_URL   = "https://lumicreate.xvps.jp/webhook/webhook-list";
const ACTION_API_URL = "https://lumicreate.xvps.jp/webhook/webhook-action";
/* LIFF ID ã¯ URLã® ?liffId=... ã‚’æœ€å„ªå…ˆã§ä½¿ã„ã€ä¸åœ¨ã®ã¨ãã«å›ºå®šIDã‚’ä½¿ã† */
const LIFF_ID = new URL(location.href).searchParams.get("liffId") || "2008311584-NdJqOqMn";
/** ============================================ */

/* ç”»é¢ãƒ­ã‚° */
function dbg(...a){
  const p = document.getElementById('debug');
  if(!p) return;
  p.textContent += a.map(v=>typeof v==='string'?v:JSON.stringify(v)).join(' ') + '\n';
}
window.onerror = (m,s,l,c,e)=>{ dbg('window.onerror:', m, s+':'+l); };
window.onunhandledrejection = (ev)=>{ dbg('unhandledrejection:', String(ev.reason||ev)); };

let gUserId = null;
let gAllTasks = [];

const el = (sel) => document.querySelector(sel);
const $pinned = el("#pinned");
const $pinnedList = el("#pinned-list");
const $activeList = el("#active-list");
const $completed = el("#completed");
const $completedList = el("#completed-list");
const $empty = el("#empty");

function toast(msg){
  const t = el("#toast"); t.textContent = msg;
  t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1400);
}
function fmtJST(iso){
  if(!iso) return "";
  const d = new Date(iso);
  return d.toLocaleString("ja-JP",{ timeZone:"Asia/Tokyo", month:"numeric", day:"numeric", hour:"2-digit", minute:"2-digit" });
}
function sortTasks(arr){
  return arr.slice().sort((a,b)=>{
    const ad = new Date(a.due_at||0).getTime();
    const bd = new Date(b.due_at||0).getTime();
    if(ad!==bd) return ad-bd;
    const ap = Number.isFinite(a.priority)?a.priority:-1;
    const bp = Number.isFinite(b.priority)?b.priority:-1;
    return bp-ap;
  });
}
function splitByStatus(all){
  const now = Date.now(), weekAgo = now - 7*24*3600*1000;
  const pinned=[], active=[], completed=[];
  for(const t of all){
    if(t.pinned){ pinned.push(t); continue; }
    if(t.status==='completed'){
      const cAt = t.completed_at? new Date(t.completed_at).getTime():0;
      if(cAt>=weekAgo) completed.push(t);
      continue;
    }
    if(t.status==='deleted' || t.status==='archived') continue;
    active.push(t);
  }
  return { pinned:pinned.slice(0,3), active, completed };
}
function cardHTML(t) {
  const dueTxt = fmtJST(t.due_at);
  const pin = t.pinned ? '<span class="pin">ğŸ“Œ</span>' : "";
  const ghost = t.status === "completed" ? " ghost" : "";
  return `
  <div class="swipe-wrap card${ghost}" data-id="${t.id}" data-status="${t.status || 'active'}">
    <div class="actions">
      <div style="display:flex;gap:6px">
        <button class="btn ok"    data-act="complete">å®Œäº†</button>
        <button class="btn warn"  data-act="remind">ï¾˜ï¾ï½²ï¾ï¾„ï¾</button>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn"        data-act="pin">${t.pinned ? "ãƒ”ãƒ³è§£é™¤" : "ãƒ”ãƒ³"}</button>
        <button class="btn"        data-act="detail">è©³ç´°</button>
        <button class="btn danger" data-act="delete">å‰Šé™¤</button>
      </div>
    </div>
    <div class="track">
      <div class="row">
        <div class="titleTxt">${pin}${escapeHTML(t.title || "(ç„¡é¡Œ)")}</div>
        <div class="meta"><span class="due">â° ${escapeHTML(dueTxt)}</span>${
          Number.isFinite(t.priority) ? `<span class="due">â˜…${t.priority}</span>` : ""
        }</div>
      </div>
    </div>
  </div>`;
}

function escapeHTML(s){
  return String(s||"").replace(/[&<>\"']/g,(c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}
function bindSwipe(track) {
  const wrap    = track.parentElement;          // .swipe-wrap
  const actions = wrap.querySelector(".actions");

  // ã—ãã„å€¤
  const SW_MENU   = 36;   // è»½ãï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ or ãƒ”ãƒ³
  const SW_ACTION = 120;  // å¼·ãï¼šç¢ºå®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå‰Šé™¤/å®Œäº†/å–æ¶ˆï¼‰

  let sx = 0, dx = 0, active = false;

  const isMenuOpen = () => wrap.classList.contains('menu');
  const openMenu   = () => { closeAllMenus(); wrap.classList.add('menu'); actions.style.opacity = 1; };
  const closeMenu  = () => { wrap.classList.remove('menu'); actions.style.opacity = 0; track.style.transform = "translateX(0)"; };

  function closeAllMenus(){
    document.querySelectorAll('.swipe-wrap.menu').forEach(w=>{
      w.classList.remove('menu');
      const act = w.querySelector('.actions');
      const trk = w.querySelector('.track');
      if (act) act.style.opacity = 0;
      if (trk) trk.style.transform = 'translateX(0)';
    });
  }

  const onStart = (x) => {
    active = true;
    sx = x;
    dx = 0;
    track.style.transition = "none";
  };

  const onMove = (x) => {
    if (!active) return;
    dx = x - sx;

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å±•é–‹ä¸­ï¼šå³ã«å°‘ã—å¼•ã„ãŸã‚‰é–‰ã˜ã‚‹
    if (isMenuOpen()) {
      if (dx > 16) closeMenu();
      return;
    }

    // é€šå¸¸ï¼šæŒ‡ã«è¿½å¾“
    track.style.transform = `translateX(${dx}px)`;
    actions.style.opacity = Math.min(1, Math.abs(dx) / 80);
  };

  const onEnd = async () => {
    track.style.transition = "transform .18s ease";

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹ã„ã¦ã‚‹â†’ã‚¿ãƒƒãƒ—ã£ã½ã‘ã‚Œã°é–‰ã˜ã‚‹ã ã‘
    if (isMenuOpen()) {
      if (Math.abs(dx) < 12) closeMenu();
      active = false; dx = 0; return;
    }

    // æ±ºå®š
    let act = null;
    if (dx <= -SW_ACTION) {
      act = "delete";                         // å¼·ãå·¦ï¼å‰Šé™¤
    } else if (dx >=  SW_ACTION) {
      // å¼·ãå³ï¼å®Œäº†ï¼å®Œäº†å–æ¶ˆï¼ˆãƒˆã‚°ãƒ«ï¼‰
      const status = wrap.dataset.status || 'active';
      act = (status === 'completed') ? "uncomplete" : "complete";
    } else if (dx <= -SW_MENU) {
      openMenu();                             // è»½ãå·¦ï¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹ã
    } else if (dx >=  SW_MENU) {
      act = "pin";                            // è»½ãå³ï¼ãƒ”ãƒ³
    }

    // æˆ»ã™ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ openMenu å†…ã§å›ºå®šï¼‰
    if (!isMenuOpen()) {
      track.style.transform = "translateX(0)";
      actions.style.opacity = 0;
    }

    const id = wrap.dataset.id;
    active = false;
    dx = 0;

    if (!act) return;

    try {
      await runAction(id, act);
    } catch (e) {
      console.error(e);
      toast("ã‚¨ãƒ©ãƒ¼: " + (e.message || "failed"));
      return;
    }
  };

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ãƒœã‚¿ãƒ³
  wrap.querySelectorAll(".btn").forEach((b) => {
    b.addEventListener("click", async (e) => {
      const id  = wrap.dataset.id;
      const act = e.currentTarget.dataset.act;
      closeMenu();

      if (act === "detail") {
        alert("è©³ç´°ã¯åˆ¥ç”»é¢ã¸é·ç§»äºˆå®š\nï¼ˆã“ã“ã§ã¯ç°¡æ˜“è¡¨ç¤ºã®ã¿ï¼‰");
        return;
      }
      if (act === "delete") {
        const ok = confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;
      }
      try { await runAction(id, act); }
      catch(err){ console.error(err); toast("ã‚¨ãƒ©ãƒ¼: " + (err.message || "failed")); }
    });
  });

  // ã‚¿ãƒƒãƒ/ãƒã‚¦ã‚¹
  track.addEventListener("touchstart", (e)=>onStart(e.touches[0].clientX), { passive:true });
  track.addEventListener("touchmove",  (e)=>onMove(e.touches[0].clientX),  { passive:true });
  track.addEventListener("touchend", onEnd);

  track.addEventListener("mousedown", (e)=>onStart(e.clientX));
  track.addEventListener("mousemove", (e)=>{ if (e.buttons === 1) onMove(e.clientX); });
  track.addEventListener("mouseup", onEnd);

  // ç”»é¢ã‚¿ãƒƒãƒ—ã§ä»–ã‚«ãƒ¼ãƒ‰ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
  document.addEventListener('click', (e)=>{
    if (!wrap.contains(e.target)) closeAllMenus();
  });
}


function actionLabel(a){
  return ({ pin:"ãƒ”ãƒ³", complete:"å®Œäº†", uncomplete:"å–æ¶ˆ", delete:"å‰Šé™¤", remind:"ãƒªãƒã‚¤ãƒ³ãƒ‰", menu:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼" }[a] || a);
}

async function runAction(id, action) {
  try {
    if (action === "detail") { alert("è©³ç´°ã¯åˆ¥ç”»é¢ã¸é·ç§»äºˆå®š"); return; }
    if (action === "delete") { const ok = confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"); if (!ok) return; }

    // é€šå¸¸é€šã‚Š Webhook ã¸
    const res = await fetch(ACTION_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, task_id: id, user_id: gUserId }),
    });
    const j = await res.json().catch(()=>({ok:false}));
    if (!res.ok || j.ok === false) throw new Error(j.message || "action failed");

    toast(actionLabel(action) + "ã—ã¾ã—ãŸ");
    await loadTasks(gUserId);
  } catch (err) {
    console.error(err);
    toast("ã‚¨ãƒ©ãƒ¼: " + (err.message || "failed"));
  }
}

async function loadTasks(userId){
  dbg('loadTasks userId=', userId);
  if(!userId){
    try{ const prof=await liff.getProfile(); userId=prof.userId; gUserId=userId; }
    catch(e){ dbg('getProfile failed:', e.code||'', e.message||e); toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã«å¤±æ•—'); return; }
  }
  const url = `${LIST_API_URL}?user_id=${encodeURIComponent(userId)}`;
  dbg('GET', url);
  let res, payload;
  try{
    res = await fetch(url, { method:'GET', credentials:'omit', headers:{'Content-Type':'application/json'} });
    payload = await res.json();
  }catch(e){
    dbg('fetch/json error:', e.message||e); toast('èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆé€šä¿¡/JSONï¼‰'); return;
  }
  dbg('status=', res.status, 'payload.ok=', payload && payload.ok);
  if(!res.ok || !payload || payload.ok!==true){ toast('èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆHTTP '+(res&&res.status)+')'); return; }
  const pinned = Array.isArray(payload.pinned)?payload.pinned:[], active = Array.isArray(payload.active)?payload.active:[], completed = Array.isArray(payload.completed)?payload.completed:[];
  gAllTasks = [...pinned, ...active, ...completed];
  dbg('gAllTasks.length=', gAllTasks.length);
  render();
}

    function render(){
      dbg('render() in items=', gAllTasks.length);
    
      const { pinned, active, completed } = splitByStatus(gAllTasks);
      $pinned.hidden   = pinned.length === 0;
      $completed.hidden= completed.length === 0;
    
      // HTML å·®ã—è¾¼ã¿ï¼ˆã“ã“ã¯ä¾‹å¤–èµ·ãã«ãã„ï¼‰
      $pinnedList.innerHTML    = sortTasks(pinned).map(TML).join("");
      $activeList.innerHTML    = sortTasks(active).map(cardHTML).join("");
      $completedList.innerHTML = sortTasks(completed).map(cardHTML).join("");
      $empty.hidden = (pinned.length + active.length) > 0;
    
      // â˜… ã‚¹ãƒ¯ã‚¤ãƒ—åˆæœŸåŒ–ã¯ try/catch ã§ã‚¬ãƒ¼ãƒ‰
      try {
        const tracks = document.querySelectorAll(".track");
        tracks.forEach(t => { try { bindSwipe(t); } catch(e) { dbg('bindSwipe err:', e.message||e); }});
        dbg('tracks=', tracks.length);
      } catch(e) {
        dbg('query .track failed:', e.message||e);
      }
    
      // â˜… ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ ãŒãªã‘ã‚Œã°æ›¸ãæ›ãˆãªã„
      const ttl = document.querySelector('.title');
      if (ttl) {
        ttl.textContent = 'LISTï½œã‚¿ã‚¹ã‚¯ ï¼ˆdebugå—ä¿¡:'+ gAllTasks.length +'ä»¶ï¼‰';
      } else {
        dbg('no .title element');
      }
    
      const activeDom = document.querySelectorAll('#active-list .card').length;
      dbg('render() out activeDom=', activeDom);
    }


async function bootstrap(){
  dbg('LIFF_ID=', LIFF_ID);
  try{
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
    dbg('liff.init OK');
  }catch(e){
    dbg('liff.init ERROR:', e.code||'', e.message||e);
    toast('LIFFåˆæœŸåŒ–ã«å¤±æ•—: '+(e.message||e));
    return;
  }
  const ctx = liff.getContext?.(); dbg('context', ctx||{});
  if(!liff.isLoggedIn()){ dbg('not logged-in -> login'); liff.login(); return; }

  try{
    const prof = await liff.getProfile();
    gUserId = prof.userId;
    document.getElementById('user-pill').textContent = 'You: '+ gUserId.slice(-6);
    dbg('profile OK userId=', gUserId);
  }catch(e){
    dbg('getProfile ERROR:', e.code||'', e.message||e);
    toast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—'); return;
  }

  document.getElementById('reload').onclick = ()=>loadTasks(gUserId);
  document.getElementById('q').addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    if(!q){ render(); return; }
    const filtered = gAllTasks.filter(t=>(t.title||'').toLowerCase().includes(q) || (t.detail||'').toLowerCase().includes(q));
    const { pinned, active, completed } = splitByStatus(filtered);
    $pinned.hidden = pinned.length===0; $completed.hidden = completed.length===0; $empty.hidden=true;
    $pinnedList.innerHTML   = sortTasks(pinned).map(cardHTML).join("");
    $activeList.innerHTML   = sortTasks(active).map(cardHTML).join("");
    $completedList.innerHTML= sortTasks(completed).map(cardHTML).join("");
    [...document.querySelectorAll(".track")].forEach(bindSwipe);
  });

  await loadTasks(gUserId);
}

bootstrap();
</script>

  </body>
</html>









